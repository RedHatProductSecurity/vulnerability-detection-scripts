 #!/usr/bin/env bats

. test_harness


KPATCH_MODULE_NAMES=(
    'kpatch_3_10_0_327_36_1_1_1'
    'kpatch_3_10_0_327_36_2_1_1'
    'kpatch_3_10_0_229_4_2_1_1'
)


@test "check_kpatch -- loaded" {
    lsmod() {
        cat << EOF
Module                     Size  Used by
ip6t_rpfilter              16384  1
ip6t_REJECT                16384  2
kpatch_3_10_0_327_36_1_1_1 11111 1
EOF
    }

    run check_kpatch "${KPATCH_MODULE_NAMES[@]}"
    [[ "$output" == "kpatch_3_10_0_327_36_1_1_1" ]]
}


@test "check_kpatch -- not loaded" {
    lsmod() {
        cat << EOF
Module                     Size  Used by
ip6t_rpfilter              16384  1
ip6t_REJECT                16384  2
EOF
    }

    run check_kpatch "${KPATCH_MODULE_NAMES[@]}"
    [[ ! "$output" ]]
}


