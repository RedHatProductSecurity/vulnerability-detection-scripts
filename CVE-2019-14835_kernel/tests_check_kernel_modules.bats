 #!/usr/bin/env bats

. test_harness

VULNERABLE_KERNEL_MODULE_NAMES=(
    'bnep'
    'bluetooth'
    'btusb'
)


@test "check_kernel_modules -- loaded one module" {
    lsmod() {
        cat << EOF
Module                     Size  Used by
ip6t_rpfilter              16384  1
ip6t_REJECT                16384  2
bluetooth                  16384  2
kpatch_3_10_0_327_36_1_1_1 11111 1
EOF
    }

    run check_kernel_modules "${VULNERABLE_KERNEL_MODULE_NAMES[@]}"
    [[ "$output" == "bluetooth" ]]
}


@test "check_kernel_modules -- not loaded" {
    lsmod() {
        cat << EOF
Module                     Size  Used by
ip6t_rpfilter              16384  1
ip6t_REJECT                16384  2
kpatch_3_10_0_327_36_1_1_1 11111 1
EOF
    }

    run check_kernel_modules "${VULNERABLE_KERNEL_MODULE_NAMES[@]}"
    [[ "$output" == "" ]]
}


@test "check_kernel_modules -- all loaded" {
    lsmod() {
        cat << EOF
Module                     Size  Used by
ip6t_rpfilter              16384  1
ip6t_REJECT                16384  2
btusb                      16384  2
bnep                       16384  2
bluetooth                  16384  2
kpatch_3_10_0_327_36_1_1_1 11111 1
EOF
    }

    run check_kernel_modules "${VULNERABLE_KERNEL_MODULE_NAMES[@]}"
    [[ "$output" == "bnep bluetooth btusb" ]]
}


