#!/usr/bin/env bats

# some of the tests are too meticulous - that is because the script is modificed CVE-2019-5736.sh and the tests also test that none of the old now-irrelevant behavior persists

export RHEL7="3.10.0-520.10.2.el7.x86_64"
export RHEL8="4.18.0-80.el8.x86_64"
export FEDORA="4.9.14-200.fc25.x86_64"
export SCRIPT_NAME=$( grep -E '^\. .*\.sh$' test_harness | sed -r 's/^\. (.*)$/\1/g' )


@test "Integration -- Fedora" {
    uname() {
        echo "$FEDORA"
    }
    export -f uname

    run ./"${SCRIPT_NAME}"
    (( status == 1 ))
}


@test "Integration -- RHEL7, all vulnerable, SELinux good" {
    uname() {
        echo "$RHEL7"
    }
    rpm() {
        if [[ "$3" == "docker" ]]; then
            echo "docker-1.13.1-108.git4ef4b30.el7.x86_64"
        fi
    }
    getenforce() {
        echo "Enforcing"
    }
    sestatus() {
        echo "Loaded policy name:             targeted"
    }
    export -f uname
    export -f rpm
    export -f getenforce
    export -f sestatus


    run ./"${SCRIPT_NAME}" -n
    (( status == 1 ))
    [[ "$output" == *"CVE-2020-14298 is mitigated by SELinux and cannot be exploited."* ]]
    [[ "$output" == *"CVE-2020-14300 is mitigated by SELinux and cannot be exploited."* ]]
    [[ "$output" == *"CVE-2016-8867 can not be mitigated by SELinux and the 'docker' package is vulnerable."* ]]
    [[ "$output" != *"This version of RHEL is NOT affected. The vulnerable package is not available for this version of RHEL."* ]]
}


@test "Integration -- RHEL7, all vulnerable, SELinux bad" {
    uname() {
        echo "$RHEL7"
    }
    rpm() {
        if [[ "$3" == "docker" ]]; then
            echo "docker-1.13.1-108.git4ef4b30.el7.x86_64"
        fi
    }
    getenforce() {
        echo "Permissive"
    }
    sestatus() {
        echo "Loaded policy name:             targeted"
    }
    export -f uname
    export -f rpm
    export -f getenforce
    export -f sestatus

    run ./"${SCRIPT_NAME}" -n
    (( status == 2 ))
    [[ "$output" != *"'runc' package is vulnerable"* ]]
    [[ "$output" == *"'docker' package is vulnerable"* ]]
    [[ "$output" != *"'docker-latest' package is vulnerable"* ]]
    [[ "$output" == *"SELinux in current state does NOT mitigate"* ]]
    [[ "$output" != *"This version of RHEL is NOT affected. The vulnerable package is not available for this version of RHEL."* ]]
}


@test "Integration -- RHEL8, all vulnerable, SELinux bad (testing a highly improbable configuration)" {
    uname() {
        echo "$RHEL8"
    }
    rpm() {
        if [[ "$3" == "docker" ]]; then
            echo "docker-1.13.1-108.git4ef4b30.el7.x86_64"
        fi
    }
    getenforce() {
        echo "Permissive"
    }
    sestatus() {
        echo "Loaded policy name:             targeted"
    }
    export -f uname
    export -f rpm
    export -f getenforce
    export -f sestatus

    run ./"${SCRIPT_NAME}" -n
    (( status == 2 ))
    [[ "$output" != *"'runc' package is vulnerable"* ]]
    [[ "$output" == *"'docker' package is vulnerable"* ]]
    [[ "$output" != *"'docker-latest' package is vulnerable"* ]]
    [[ "$output" == *"SELinux in current state does NOT mitigate"* ]]
    [[ "$output" != *"This version of RHEL is NOT affected. The vulnerable package is not available for this version of RHEL."* ]]
}


@test "Integration -- RHEL8, all vulnerable, SELinux good (testing a highly improbable configuration)" {
    uname() {
        echo "$RHEL8"
    }
    rpm() {
        if [[ "$3" == "docker" ]]; then
            echo "docker-1.13.1-108.git4ef4b30.el7.x86_64"
        fi
    }
    getenforce() {
        echo "Enforcing"
    }
    sestatus() {
        echo "Loaded policy name:             targeted"
    }
    export -f uname
    export -f rpm
    export -f getenforce
    export -f sestatus

    run ./"${SCRIPT_NAME}" -n
    (( status == 1 ))
    [[ "$output" != *"'runc' package is vulnerable"* ]]
    [[ "$output" == *"'docker' package is vulnerable"* ]]
    [[ "$output" != *"'docker-latest' package is vulnerable"* ]]
    [[ "$output" == *"CVE-2020-14298 is mitigated by SELinux and cannot be exploited."* ]]
    [[ "$output" == *"CVE-2020-14300 is mitigated by SELinux and cannot be exploited."* ]]
    [[ "$output" == *"CVE-2016-8867 can not be mitigated by SELinux and the 'docker' package is vulnerable."* ]]
    [[ "$output" != *"SELinux in current state does NOT mitigate"* ]]
    [[ "$output" != *"This version of RHEL is NOT affected. The vulnerable package is not available for this version of RHEL."* ]]
}


@test "Integration -- RHEL7, no vulnerable, SELinux bad" {
    uname() {
        echo "$RHEL7"
    }
    rpm() {
        if [[ "$3" == "docker" ]]; then
            echo "docker-5.12.5-14.el7.x86_64"
        fi
    }
    getenforce() {
        echo "Permissive"
    }
    sestatus() {
        echo "Loaded policy name:             targeted"
    }
    export -f uname
    export -f rpm
    export -f getenforce
    export -f sestatus

    run ./"${SCRIPT_NAME}" -n
    (( status == 0 ))
    [[ "$output" != *"'runc' package is vulnerable"* ]]
    [[ "$output" != *"'docker' package is vulnerable"* ]]
    [[ "$output" != *"'docker-latest' package is vulnerable"* ]]
    [[ "$output" == *"'docker' package is NOT vulnerable"* ]]
    [[ "$output" != *"SELinux in current state does NOT mitigate"* ]]
    [[ "$output" != *"This version of RHEL is NOT affected. The vulnerable package is not available for this version of RHEL."* ]]
}


@test "Integration -- RHEL8, no vulnerable, SELinux bad" {
    uname() {
        echo "$RHEL8"
    }
    rpm() {
        if [[ "$3" == "docker" ]]; then
            echo "docker-5.12.5-14.el7.x86_64"
        fi
    }
    getenforce() {
        echo "Permissive"
    }
    sestatus() {
        echo "Loaded policy name:             targeted"
    }
    export -f uname
    export -f rpm
    export -f getenforce
    export -f sestatus

    run ./"${SCRIPT_NAME}" -n
    (( status == 0 ))
    [[ "$output" != *"'runc' package is vulnerable"* ]]
    [[ "$output" != *"'docker' package is vulnerable"* ]]
    [[ "$output" != *"'docker-latest' package is vulnerable"* ]]
    [[ "$output" != *"SELinux in current state does NOT mitigate"* ]]
    [[ "$output" == *"This version of RHEL is NOT affected. The vulnerable package is not available for this version of RHEL."* ]]
    [[ "$output" == *"There are NO vulnerable packages"* ]]
}


@test "Integration -- RHEL7, no vulnerable, SELinux good" {
    uname() {
        echo "$RHEL7"
    }
    rpm() {
        if [[ "$3" == "docker" ]]; then
            echo "docker-5.12.5-14.el7.x86_64"
        fi
    }
    getenforce() {
        echo "Enforcing"
    }
    sestatus() {
        echo "Loaded policy name:             targeted"
    }
    export -f uname
    export -f rpm
    export -f getenforce
    export -f sestatus

    run ./"${SCRIPT_NAME}" -n
    (( status == 0 ))
    [[ "$output" != *"'runc' package is vulnerable"* ]]
    [[ "$output" != *"'docker' package is vulnerable"* ]]
    [[ "$output" != *"'docker-latest' package is vulnerable"* ]]
    [[ "$output" == *"'docker' package is NOT vulnerable"* ]]
    [[ "$output" != *"SELinux in current state does NOT mitigate"* ]]
    [[ "$output" == *"There are NO vulnerable packages"* ]]
    [[ "$output" != *"cannot be exploited"* ]]
    [[ "$output" != *"This version of RHEL is NOT affected. The vulnerable package is not available for this version of RHEL."* ]]
}
