#!/usr/bin/env bats

export SCRIPT_NAME=$( grep -E '^\. .*\.sh$' test_harness | sed -r 's/^\. (.*)$/\1/g' )
export MOCK_EUID="0"
export RHEL7="3.10.0-327.49.2.el7.x86_64"

uname() {
    echo "$RHEL7"
}
export -f uname


@test "Integration -- Vulnerable kernel" {
    virt-what() {
        printf "kvm"
    }
    export -f virt-what
    dmesg() {
        echo "Initializing cgroup subsys cpu"
    }
    export -f dmesg

    export MOCK_CPU_INFO_PATH=file_mocks/cpuinfo/affect_intel
    export MOCK_VULN_FILE_PATH=file_mocks/vulns/file_missing
    export MOCK_CPU_DIRS_PATH=file_mocks/smt/smt_disabled_cpu
    export MOCK_DMESG_PATH=file_mocks/dmesg/dmesg_log

    run ./"${SCRIPT_NAME}"
    (( status == 1 ))
}

@test "Integration -- Vulnerable kernel without mitigation" {
    virt-what() {
        printf ""
    }
    export -f virt-what
    dmesg() {
        echo "Initializing cgroup subsys cpu"
        echo "L1TF: System has more than MAX_PA/2 memory. L1TF mitigation not effective."
    }
    export -f dmesg

    export MOCK_CPU_INFO_PATH=file_mocks/cpuinfo/affect_intel
    export MOCK_VULN_FILE_PATH=file_mocks/vulns/vulnerable
    export MOCK_CPU_DIRS_PATH=file_mocks/smt/smt_enabled_cpu_comma
    export MOCK_DMESG_PATH=file_mocks/dmesg/dmesg_log_no_mitg

    run ./"${SCRIPT_NAME}"
    (( status == 1 ))
}

@test "Integration -- Not affected vendor" {
    virt-what() {
        printf "kvm"
    }
    export -f virt-what
    dmesg() {
        echo "Initializing cgroup subsys cpu"
    }
    export -f dmesg

    export MOCK_CPU_INFO_PATH=file_mocks/cpuinfo/not_aff_amd
    export MOCK_VULN_FILE_PATH=file_mocks/vulns/not_affected
    export MOCK_CPU_DIRS_PATH=file_mocks/smt/smt_disabled_cpu
    export MOCK_DMESG_PATH=file_mocks/dmesg/dmesg_log

    run ./"${SCRIPT_NAME}"
    (( status == 0 ))
}

@test "Integration -- Not affected due to mitigation" {
    virt-what() {
        printf "kvm"
    }
    export -f virt-what
    dmesg() {
        echo "Initializing cgroup subsys cpu"
    }
    export -f dmesg

    export MOCK_CPU_INFO_PATH=file_mocks/cpuinfo/affect_intel
    export MOCK_VULN_FILE_PATH=file_mocks/vulns/miti_active
    export MOCK_CPU_DIRS_PATH=file_mocks/smt/smt_disabled_cpu
    export MOCK_DMESG_PATH=file_mocks/dmesg/dmesg_log

    run ./"${SCRIPT_NAME}"
    (( status == 0 ))
}
