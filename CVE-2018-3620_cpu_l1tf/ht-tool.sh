#!/bin/bash

# Copyright (C) 2018  Red Hat, Inc.
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.

ht_status() {
    lscpu | grep -E '^On|Off'
}


check_toggle_supported() {
    for cpu_directory in /sys/devices/system/cpu/cpu[0-9]*; do
        if [[ ! -f "$cpu_directory/online" ]]; then
            echo "This kernel is not supported by the script"
            exit 1
        fi
        if [[ ! -w "$cpu_directory/online" ]]; then
            echo "Cannot control hyper-threading. Run this script with elevated privileges"
            echo "(e.g. as root)"
            exit 1
        fi
    done
}


ht_disable() {
    for cpu_directory in /sys/devices/system/cpu/cpu[0-9]*; do
        cpu_number="${cpu_directory##*cpu}"
        main_thread=$( awk -F, '{ print $1 }' "$cpu_directory/topology/thread_siblings_list" )
        if (( cpu_number == main_thread )); then
            echo "CPU $cpu_number ON"
            echo "1" > "$cpu_directory/online"
        else
            echo "CPU $cpu_number OFF"
            echo "0" > "$cpu_directory/online"
        fi
    done
}


ht_enable() {
    for cpu_directory in /sys/devices/system/cpu/cpu[0-9]*; do
        cpu_number="${cpu_directory##*cpu}"
        echo "CPU $cpu_number ON"
        echo "1" > "$cpu_directory/online"
    done
}


usage() {
    cat << EOF
usage: ht-tool [-e|--enable] [-d|--disable] [-s|--status] [-h|--help]

Utility script to control CPU hyper-threading. When executed without parameters
it will print this help message.
It is tested on RHEL7.

optional arguments:
  -h, --help     show this help message and exit
  -s, --status   print core on-line status to asses hyper-threading state
  -e, --enable   enable hyper-threading
  -d, --disable  disable hyper-threading
EOF
}


if (( "$#" != 1 )); then
    usage
    exit 1
fi

case "$1" in
    -s | --status)
        ht_status
        ;;
    -e | --enable)
        check_toggle_supported
        echo "Enabling hyper-threading"
        echo
        ht_enable
        ;;
    -d | --disable)
        check_toggle_supported
        echo "Disabling hyper-threading"
        echo
        ht_disable
        ;;
    *)
        usage
        exit 1
        ;;
esac
