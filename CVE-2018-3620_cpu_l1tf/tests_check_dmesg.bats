#!/usr/bin/env bats

. test_harness


@test "check_dmesg -- dmesg" {
    dmesg() {
        echo "Initializing cgroup subsys cpu"
    }
    export -f dmesg
    export MOCK_DMESG_PATH=file_mocks/dmesg/dmesg_log

    run check_dmesg
    (( status == 0 ))
}


@test "check_dmesg -- dmesg command no mitigation" {
    dmesg() {
        echo "Initializing cgroup subsys cpu"
        echo "L1TF: System has more than MAX_PA/2 memory. L1TF mitigation not effective."
    }
    export -f dmesg
    export MOCK_DMESG_PATH=file_mocks/dmesg/dmesg_log

    run check_dmesg
    (( status == 1 ))
}


@test "check_dmesg -- dmesg log no mitigation" {
    dmesg() {
        echo "Initializing cgroup subsys cpu"
    }
    export -f dmesg
    export MOCK_DMESG_PATH=file_mocks/dmesg/dmesg_log_no_mitg

    run check_dmesg
    (( status == 1 ))
}
