#!/usr/bin/env bats

. test_harness

@test "check_mitigation_active -- active" {
    MOCK_VULN_FILE_PATH=file_mocks/vulns/miti_active
    run check_mitigation_active
    [[ "$output" == "Mitigation: Page Table Inversion" ]]
    (( status == 1 ))
}


@test "check_mitigation_active -- not affected" {
    MOCK_VULN_FILE_PATH=file_mocks/vulns/not_affected
    run check_mitigation_active
    [[ "$output" == "Not affected" ]]
    (( status == 1 ))
}


@test "check_mitigation_active -- vulnerable" {
    MOCK_VULN_FILE_PATH=file_mocks/vulns/vulnerable
    run check_mitigation_active
    [[ "$output" == "" ]]
    (( status == 0 ))
}


@test "check_mitigation_active -- vulnerable rhel7 l1tf=off" {
    MOCK_VULN_FILE_PATH=file_mocks/vulns/vulnerable_rhel7_l1tf_off
    run check_mitigation_active
    [[ "$output" == "Mitigation: PTE Inversion; VMX: SMT vulnerable, L1D vulnerable" ]]
    (( status == 0 ))
}



@test "check_mitigation_active -- file not readable" {
    MOCK_VULN_FILE_PATH=file_mocks/vulns/file_missing
    run check_mitigation_active
    [[ "$output" == "" ]]
    (( status == 0 ))
}
