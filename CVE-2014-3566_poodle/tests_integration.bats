#!/usr/bin/env bats

export SCRIPT="./CVE-2014-3566.sh"


@test "Integration -- not installed" {
    rpm() {
        echo ""
    }
    uname() {
        echo "3.10.0-514.el7.x86_64"
    }
    export -f rpm
    export -f uname
    export MOCK_HTTPD_CONFIGS_PATH=file_mocks/01
    export MOCK_VSFTP_CONFIG_PATH=file_mocks/vsftpd_1.conf
    
    run "$SCRIPT"
    (( status == 0 ))
    [[ "$output" == *"Neither 'httpd' nor 'vsftpd' is not installed."* ]]
}


@test "Integration -- httpd installed and vulnerable" {
    rpm() {
        [[ "$3" == "httpd" ]] && echo "httpd-2.4.6-67.el7_4.6.x86_64"
    }
    uname() {
        echo "3.10.0-514.el7.x86_64"
    }
    export -f rpm
    export -f uname
    export MOCK_HTTPD_CONFIGS_PATH=file_mocks/01
    export MOCK_VSFTP_CONFIG_PATH=file_mocks/vsftpd_1.conf
    
    run "$SCRIPT"
    (( status == 2 ))
    [[ "$output" == *"Detected 'httpd' packages are:"* ]]
    [[ "$output" == *"'httpd' configuration is vulnerable."* ]]
}


@test "Integration -- vsftpd installed and vulnerable" {
    rpm() {
        [[ "$3" == "vsftpd" ]] && echo "vsftpd-3.0.2-22.el7.x86_64"
    }
    uname() {
        echo "3.10.0-514.el7.x86_64"
    }
    export -f rpm
    export -f uname
    export MOCK_HTTPD_CONFIGS_PATH=file_mocks/01
    export MOCK_VSFTP_CONFIG_PATH=file_mocks/vsftpd_1.conf
    
    run "$SCRIPT"
    (( status == 4 ))
    [[ "$output" == *"Detected 'vsftpd' packages are:"* ]]
    [[ "$output" == *"'vsftpd' configuration is vulnerable."* ]]
}


@test "Integration -- both installed and vulnerable" {
    rpm() {
        [[ "$3" == "httpd" ]] && echo "httpd-2.4.6-67.el7_4.6.x86_64"
        [[ "$3" == "vsftpd" ]] && echo "vsftpd-3.0.2-22.el7.x86_64"
    }
    uname() {
        echo "3.10.0-514.el7.x86_64"
    }
    export -f rpm
    export -f uname
    export MOCK_HTTPD_CONFIGS_PATH=file_mocks/01
    export MOCK_VSFTP_CONFIG_PATH=file_mocks/vsftpd_1.conf
    
    run "$SCRIPT"
    (( status == 6 ))
    [[ "$output" == *"Detected 'httpd' packages are:"* ]]
    [[ "$output" == *"'httpd' configuration is vulnerable."* ]]
    [[ "$output" == *"Detected 'vsftpd' packages are:"* ]]
    [[ "$output" == *"'vsftpd' configuration is vulnerable."* ]]
}


@test "Integration -- both installed only httpd vulnerable" {
    rpm() {
        [[ "$3" == "httpd" ]] && echo "httpd-2.4.6-67.el7_4.6.x86_64"
        [[ "$3" == "vsftpd" ]] && echo "vsftpd-3.0.2-22.el7.x86_64"
    }
    uname() {
        echo "3.10.0-514.el7.x86_64"
    }
    export -f rpm
    export -f uname
    export MOCK_HTTPD_CONFIGS_PATH=file_mocks/01
    export MOCK_VSFTP_CONFIG_PATH=file_mocks/vsftpd_3.conf
    
    run "$SCRIPT"
    (( status == 2 ))
    [[ "$output" == *"Detected 'httpd' packages are:"* ]]
    [[ "$output" == *"'httpd' configuration is vulnerable."* ]]
    [[ "$output" == *"Detected 'vsftpd' packages are:"* ]]
    [[ "$output" != *"'vsftpd' configuration is vulnerable."* ]]
}



@test "Integration -- both installed only vsftp vulnerable" {
    rpm() {
        [[ "$3" == "httpd" ]] && echo "httpd-2.4.6-67.el7_4.6.x86_64"
        [[ "$3" == "vsftpd" ]] && echo "vsftpd-3.0.2-22.el7.x86_64"
    }
    uname() {
        echo "3.10.0-514.el7.x86_64"
    }
    export -f rpm
    export -f uname
    export MOCK_HTTPD_CONFIGS_PATH=file_mocks/06
    export MOCK_VSFTP_CONFIG_PATH=file_mocks/vsftpd_1.conf
    
    run "$SCRIPT"
    (( status == 4 ))
    [[ "$output" == *"Detected 'httpd' packages are:"* ]]
    [[ "$output" != *"'httpd' configuration is vulnerable."* ]]
    [[ "$output" == *"Detected 'vsftpd' packages are:"* ]]
    [[ "$output" == *"'vsftpd' configuration is vulnerable."* ]]
}


@test "Integration -- both installed none vulnerable" {
    rpm() {
        [[ "$3" == "httpd" ]] && echo "httpd-2.4.6-67.el7_4.6.x86_64"
        [[ "$3" == "vsftpd" ]] && echo "vsftpd-3.0.2-22.el7.x86_64"
    }
    uname() {
        echo "3.10.0-514.el7.x86_64"
    }
    export -f rpm
    export -f uname
    export MOCK_HTTPD_CONFIGS_PATH=file_mocks/06
    export MOCK_VSFTP_CONFIG_PATH=file_mocks/vsftpd_3.conf
    
    run "$SCRIPT"
    (( status == 0 ))
    [[ "$output" == *"Detected 'httpd' packages are:"* ]]
    [[ "$output" != *"'httpd' configuration is vulnerable."* ]]
    [[ "$output" == *"Detected 'vsftpd' packages are:"* ]]
    [[ "$output" != *"'vsftpd' configuration is vulnerable."* ]]
}
