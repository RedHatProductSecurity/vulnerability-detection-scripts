#!/usr/bin/env bats

export RHEL7="3.10.0-520.10.2.el7.x86_64"
export SCRIPT_NAME=$( grep -E '^\. .*\.sh$' test_harness | sed -r 's/^\. (.*)$/\1/g' )

@test "Cmdline -- no settings" {
    uname() {
        echo "$RHEL7"
    }
    dmesg() {
        echo "Linux version"
        echo "FEATURE SPEC_CTRL Present"
        echo "FEATURE IBPB_SUPPORT Present"
        echo "x86/pti: Unmapping kernel while in userspace"
    }
    mount() {
        echo "debugfs"
    }
    lsmod() {
        :
    }
    modinfo() {
        echo nope retpoline
    }
    export -f lsmod
    export -f modinfo
    export -f uname
    export -f dmesg
    export -f mount
    export MOCK_CPU_INFO_PATH=integration/file_mocks/cpuinfo/intel
    export MOCK_DEBUG_X86_PATH=integration/file_mocks/debug/pti1_ibrs1_ibpb1
    export MOCK_CMDLINE_PATH=integration/file_mocks/cmdline/cmdline_ok
    export MOCK_VULNS_PATH=integration/file_mocks/vulns/nonexistent
    export MOCK_LOG_DMESG_PATH=integration/file_mocks/dmesg/nonexistent
    export MOCK_EUID=0

    run ./"${SCRIPT_NAME}"
    (( status == 0 ))
}

@test "Cmdline -- nospectre_v2" {
    uname() {
        echo "$RHEL7"
    }
    dmesg() {
        echo "Linux version"
        echo "FEATURE SPEC_CTRL Not Present"
        echo "FEATURE IBPB_SUPPORT Not Present"
        echo "x86/pti: Unmapping kernel while in userspace"
    }
    mount() {
        echo "debugfs"
    }
    lsmod() {
        :
    }
    modinfo() {
        echo nope retpoline
    }
    export -f lsmod
    export -f modinfo
    export -f uname
    export -f dmesg
    export -f mount
    export MOCK_CPU_INFO_PATH=integration/file_mocks/cpuinfo/intel
    export MOCK_DEBUG_X86_PATH=integration/file_mocks/debug/pti1_ibrs0_ibpb0_retp0
    export MOCK_CMDLINE_PATH=integration/file_mocks/cmdline/cmdline_nospectre_v2
    export MOCK_VULNS_PATH=integration/file_mocks/vulns/vuln_vuln_pti
    export MOCK_LOG_DMESG_PATH=integration/file_mocks/dmesg/nonexistent
    export MOCK_EUID=0

    run ./"${SCRIPT_NAME}"
    (( status == 6 ))
}

@test "Cmdline -- spectre_v2=off" {
    uname() {
        echo "$RHEL7"
    }
    dmesg() {
        echo "Linux version"
        echo "FEATURE SPEC_CTRL Not Present"
        echo "FEATURE IBPB_SUPPORT Not Present"
        echo "x86/pti: Unmapping kernel while in userspace"
    }
    mount() {
        echo "debugfs"
    }
    lsmod() {
        :
    }
    modinfo() {
        echo nope retpoline
    }
    export -f lsmod
    export -f modinfo
    export -f uname
    export -f dmesg
    export -f mount
    export MOCK_CPU_INFO_PATH=integration/file_mocks/cpuinfo/intel
    export MOCK_DEBUG_X86_PATH=integration/file_mocks/debug/pti1_ibrs0_ibpb0_retp0
    export MOCK_CMDLINE_PATH=integration/file_mocks/cmdline/cmdline_sv2_off
    export MOCK_VULNS_PATH=integration/file_mocks/vulns/vuln_vuln_pti
    export MOCK_LOG_DMESG_PATH=integration/file_mocks/dmesg/nonexistent
    export MOCK_EUID=0

    ./"${SCRIPT_NAME}" -d | grep -Fxq 'cmd_spectre_v2_value = *off*'

    run ./"${SCRIPT_NAME}"
    (( status == 6 ))
}

@test "Cmdline -- spectre_v2=ibrs" {
    uname() {
        echo "$RHEL7"
    }
    dmesg() {
        echo "Linux version"
        echo "FEATURE SPEC_CTRL Present"
        echo "FEATURE IBPB_SUPPORT Present"
        echo "x86/pti: Unmapping kernel while in userspace"
    }
    mount() {
        echo "debugfs"
    }
    lsmod() {
        :
    }
    modinfo() {
        echo nope retpoline
    }
    export -f lsmod
    export -f modinfo
    export -f uname
    export -f dmesg
    export -f mount
    export MOCK_CPU_INFO_PATH=integration/file_mocks/cpuinfo/intel
    export MOCK_DEBUG_X86_PATH=integration/file_mocks/debug/pti1_ibrs1_ibpb1_retp0
    export MOCK_CMDLINE_PATH=integration/file_mocks/cmdline/cmdline_sv2_ibrs
    export MOCK_VULNS_PATH=integration/file_mocks/vulns/ibrs_ibrs_pti
    export MOCK_LOG_DMESG_PATH=integration/file_mocks/dmesg/nonexistent
    export MOCK_EUID=0

    ./"${SCRIPT_NAME}" -d | grep -Fxq 'cmd_spectre_v2_value = *ibrs*'

    run ./"${SCRIPT_NAME}"
    (( status == 0 ))
}
