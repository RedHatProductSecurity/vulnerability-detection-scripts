#!/usr/bin/env bats

export RHEL8="4.18.0-80.el8.x86_64"
export RHEL9="5.14.0-70.13.1.el9_0.x86_64"
export FEDORA="4.9.14-200.fc25.x86_64"
export SCRIPT_NAME=$( grep -E '^\. .*\.sh$' test_harness | sed -r 's/^\. (.*)$/\1/g' )

# TODO these are very simple tests, a lot of customization is needed. See older tests.

@test "Integration -- Fedora" {
    uname() {
        echo "$FEDORA"
    }
    export -f uname

    run ./"${SCRIPT_NAME}"
    (( status == 1 ))
}


@test "Integration -- RHEL8" {
    uname() {
        echo "$RHEL8"
    }
    rpm() {
        echo "openssl-1.1.1-8.el8.x86_64"
    }
    export -f uname
    export -f rpm

    run ./"${SCRIPT_NAME}"
    (( status == 0 ))
}


@test "Integration -- RHEL9 -- Vulnerable version installed" {
    uname() {
        echo "$RHEL9"
    }
    rpm() {
        echo "openssl-3.0.1-20.el9_0.x86_64"
    }
    export -f uname
    export -f rpm

    run ./"${SCRIPT_NAME}"
    ((status == 1))
    [[ "$output" != *"is not installed"* ]]
    [[ "$output" == *"installed openssl version is vulnerable"* ]]
    [[ "$output" != *"installed openssl version is not vulnerable"* ]]
}


@test "Integration -- RHEL9 -- Non-vulnerable version installed" {
    uname() {
        echo "$RHEL9"
    }
    rpm() {
        echo "openssl-3.0.1-43.el9_0.x86_64"
    }
    export -f uname
    export -f rpm

    run ./"${SCRIPT_NAME}"
    ((status == 0))
    [[ "$output" != *"is not installed"* ]]
    [[ "$output" != *"installed openssl version is vulnerable"* ]]
    [[ "$output" == *"installed openssl version is not vulnerable"* ]]
}


@test "Integration -- RHEL9 -- openssl somehow not installed" {
    uname() {
        echo "$RHEL9"
    }
    rpm() {
        echo ""
    }
    export -f uname
    export -f rpm

    run ./"${SCRIPT_NAME}"
    ((status == 0))
    [[ "$output" == *"is not installed"* ]]
    [[ "$output" != *"installed openssl version is vulnerable"* ]]
    [[ "$output" != *"installed openssl version is not vulnerable"* ]]

}
