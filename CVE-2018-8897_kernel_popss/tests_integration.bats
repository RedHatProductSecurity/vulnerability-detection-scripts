#!/usr/bin/env bats

export RHEL7="3.10.0-520.10.2.el7.x86_64"
export RHEL7VULN="3.10.0-862.el7.x86_64"
export RHEL7_VULN_NVR_NONVULN_ARCH_s390x="3.10.0-862.el7.s390x"
export FEDORA="4.9.14-200.fc25.x86_64"
export SCRIPT_NAME=$( grep -E '^\. .*\.sh$' test_harness | sed -r 's/^\. (.*)$/\1/g' )


@test "Integration -- Fedora" {
    uname() {
        echo "$FEDORA"
    }
    export -f uname

    run ./"${SCRIPT_NAME}"
    (( status == 1 ))
}


@test "Integration -- RHEL7 -- nonvulnerable" {
    uname() {
        echo "$RHEL7"
    }
    export -f uname

    run ./"${SCRIPT_NAME}"
    (( status == 0 ))
}


@test "Integration -- RHEL7 -- vulnerable" {
    uname() {
        echo "$RHEL7VULN"
    }
    export -f uname

    run ./"${SCRIPT_NAME}"
    (( status == 2 ))
}


@test "Integration -- RHEL7 -- vulnerable NVR but nonvulnerable arch" {
    uname() {
        if [[ "$1" == "-r" ]]; then
            echo "${RHEL7_VULN_NVR_NONVULN_ARCH_s390x}"
        fi
        if [[ "$1" == "-p" ]]; then
            echo "s390x"  # tested on gss5.s390.bos.redhat.com
        fi
        if [[ "$1" == "-m" ]]; then
            echo "s390x"  # tested on gss5.s390.bos.redhat.com
        fi
    }
    export -f uname

    run ./"${SCRIPT_NAME}"
    (( status == 0 ))
}
