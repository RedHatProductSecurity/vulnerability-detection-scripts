#!/usr/bin/env bats

SCRIPT='./CVE-2017-1000367.sh'

export VULNERABLE_1="sudo-1.7.2p1-22.el5"
export VULNERABLE_2="sudo-1.8.6p7-21.el7_3"
export SAFE_1="sudo-1.9.0-1.el7"
export SAFE_2="sudo-2.9.0-1.el7"
export RHEL7="3.10.0-520.10.2.el7.x86_64"
export FEDORA="4.9.14-200.fc25.x86_64"


@test "Integration -- vulnerable #1" {
    rpm() {
        echo "$VULNERABLE_1"
    }
    uname() {
        echo "$RHEL7"
    }
    export -f rpm
    export -f uname
    
    run "$SCRIPT"
    (( status == 2 ))
}


@test "Integration -- vulnerable #2" {
    rpm() {
        echo "$VULNERABLE_2"
    }
    uname() {
        echo "$RHEL7"
    }
    export -f rpm
    export -f uname
    
    run "$SCRIPT"
    (( status == 2 ))
}


@test "Integration -- safe #1" {
    rpm() {
        echo "$SAFE_1"
    }
    uname() {
        echo "$RHEL7"
    }
    export -f rpm
    export -f uname
    
    run "$SCRIPT"
    (( status == 0 ))
}


@test "Integration -- safe #2" {
    rpm() {
        echo "$SAFE_2"
    }
    uname() {
        echo "$RHEL7"
    }
    export -f rpm
    export -f uname
    
    run "$SCRIPT"
    (( status == 0 ))
}


@test "Integration -- not installed" {
    rpm() {
        :
    }
    uname() {
        echo "$RHEL7"
    }
    export -f rpm
    export -f uname
    
    run "$SCRIPT"
    (( status == 0 ))
    [[ "$output" == *"is not installed"* ]]
}


@test "Integration -- not RHEL" {
    rpm() {
        :
    }
    uname() {
        echo "$FEDORA"
    }
    export -f rpm
    export -f uname
    
    run "$SCRIPT"
    (( status == 1 ))
    [[ "$output" == *"This script is meant to be used only on Red Hat"* ]]
}

