#!/usr/bin/env bats

export RHEL7_VULNERABLE="4.11.0-44.el7"
export RHEL7_VULNERABLE_WITH_A="4.11.0-44.el7a"
export RHEL7_SAFE="3.10.0-520.10.2.el7.x86_64"
export FEDORA="4.9.14-200.fc25.x86_64"
export SCRIPT_NAME=$( grep -E '^\. .*\.sh$' test_harness | sed -r 's/^\. (.*)$/\1/g' )


@test "Integration -- Safe kernel" {
    uname() {
        echo "$RHEL7_SAFE"
    }
    export -f uname
    export MOCK_THP_ENABLED_PATH=file_mocks/hugepages/always
    export MOCK_THP_ZERO_PATH=file_mocks/zeropage/1

    run ./"${SCRIPT_NAME}"
    (( status == 0 ))
    [[ "$output" == *"This kernel version is not vulnerable"* ]]
}


@test "Integration -- Vulnerable kernel #1" {
    uname() {
        echo "$RHEL7_VULNERABLE"
    }
    export -f uname
    export MOCK_THP_ENABLED_PATH=file_mocks/hugepages/always
    export MOCK_THP_ZERO_PATH=file_mocks/zeropage/1

    run ./"${SCRIPT_NAME}"
    (( status == 2 ))
    [[ "$output" == *"update kernel package"* ]]
}


@test "Integration -- Vulnerable kernel #2" {
    uname() {
        echo "$RHEL7_VULNERABLE_WITH_A"
    }
    export -f uname
    export MOCK_THP_ENABLED_PATH=file_mocks/hugepages/always
    export MOCK_THP_ZERO_PATH=file_mocks/zeropage/1

    run ./"${SCRIPT_NAME}"
    (( status == 2 ))
    [[ "$output" == *"update kernel package"* ]]
}


@test "Integration -- Vulnerable kernel - midvise" {
    uname() {
        echo "$RHEL7_VULNERABLE"
    }
    export -f uname
    export MOCK_THP_ENABLED_PATH=file_mocks/hugepages/midvise
    export MOCK_THP_ZERO_PATH=file_mocks/zeropage/1

    run ./"${SCRIPT_NAME}"
    (( status == 2 ))
    [[ "$output" == *"update kernel package"* ]]
}


@test "Integration -- Vulnerable kernel - never" {
    uname() {
        echo "$RHEL7_VULNERABLE"
    }
    export -f uname
    export MOCK_THP_ENABLED_PATH=file_mocks/hugepages/never
    export MOCK_THP_ZERO_PATH=file_mocks/zeropage/1

    run ./"${SCRIPT_NAME}"
    (( status == 0 ))
    [[ "$output" == *"transparent hugepages disabled"* ]]
}


@test "Integration -- Vulnerable kernel - zeropage disabled" {
    uname() {
        echo "$RHEL7_VULNERABLE"
    }
    export -f uname
    export MOCK_THP_ENABLED_PATH=file_mocks/hugepages/always
    export MOCK_THP_ZERO_PATH=file_mocks/zeropage/0

    run ./"${SCRIPT_NAME}"
    ./"${SCRIPT_NAME}"
    (( status == 0 ))
    [[ "$output" == *"zero page is prevented"* ]]
}

