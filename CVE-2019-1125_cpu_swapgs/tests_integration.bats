#!/usr/bin/env bats


export FEDORA="4.9.14-200.fc25.x86_64"
export SCRIPT_NAME=$( grep -E '^\. .*\.sh$' test_harness | sed -r 's/^\. (.*)$/\1/g' )


@test "Integration -- Fedora - not supported" {
    uname() {
        echo "$FEDORA"
    }
    export -f uname

    run ./"${SCRIPT_NAME}"
    (( status == 1 ))
}


@test "Integration -- RHEL7, kernel not updated - vuln. file does not exit" {
    uname() {
        cat file_mocks/uname_r-rhel7
    }
    export -f uname
    export MOCK_ARCH="x86_64"
    export MOCK_EUID=0
    export MOCK_CPU_INFO_PATH=file_mocks/cpuinfo-skylake
    export MOCK_VULN_FILE_PATH=file_mocks/foo

    run ./"${SCRIPT_NAME}"
    (( status == 2 ))
}


@test "Integration -- RHEL7, POWER not affected" {
    uname() {
        cat file_mocks/uname_r-rhel7
    }
    export -f uname
    export MOCK_ARCH="ppc64le"
    export MOCK_EUID=0
    export MOCK_CPU_INFO_PATH=file_mocks/cpuinfo-power
    export MOCK_VULN_FILE_PATH=file_mocks/foo

    run ./"${SCRIPT_NAME}"
    #(( output == 'abc' ))
    (( status == 0 ))
}


@test "Integration -- RHEL7, i686 not affected" {
    uname() {
        cat file_mocks/uname_r-rhel7
    }
    export -f uname
    export MOCK_ARCH="i686"
    export MOCK_EUID=0
    export MOCK_CPU_INFO_PATH=file_mocks/cpuinfo-skylake
    export MOCK_VULN_FILE_PATH=file_mocks/foo

    run ./"${SCRIPT_NAME}"
    (( status == 0 ))
}


@test "Integration -- RHEL7, Intel, mitigation" {
    uname() {
        cat file_mocks/uname_r-rhel7
    }
    export -f uname
    export MOCK_ARCH="x86_64"
    export MOCK_EUID=0
    export MOCK_CPU_INFO_PATH=file_mocks/cpuinfo-skylake
    export MOCK_VULN_FILE_PATH=file_mocks/vuln-mit/spectre_v1

    run ./"${SCRIPT_NAME}"
    (( status == 0 ))
}


@test "Integration -- RHEL7, vulnerable, kernel updated, mitigation disabled" {
    uname() {
        cat file_mocks/uname_r-rhel7
    }
    export -f uname
    export MOCK_ARCH="x86_64"
    export MOCK_EUID=0
    export MOCK_CPU_INFO_PATH=file_mocks/cpuinfo-skylake
    export MOCK_VULN_FILE_PATH=file_mocks/vuln-disabled/spectre_v1

    run ./"${SCRIPT_NAME}"
    (( status == 3 ))
}


@test "Integration -- RHEL7, vulnerable, only kernel with spectre_v1 mitigation" {
    uname() {
        cat file_mocks/uname_r-rhel7
    }
    export -f uname
    export MOCK_ARCH="x86_64"
    export MOCK_EUID=0
    export MOCK_CPU_INFO_PATH=file_mocks/cpuinfo-skylake
    export MOCK_VULN_FILE_PATH=file_mocks/vuln-spectre/spectre_v1

    run ./"${SCRIPT_NAME}"
    (( status == 3 ))
}


@test "Integration -- RHEL7, vulnerable, kernel updated" {
    uname() {
        cat file_mocks/uname_r-rhel7
    }
    export -f uname
    export MOCK_ARCH="x86_64"
    export MOCK_EUID=0
    export MOCK_CPU_INFO_PATH=file_mocks/cpuinfo-skylake
    export MOCK_VULN_FILE_PATH=file_mocks/vuln-vuln/spectre_v1

    run ./"${SCRIPT_NAME}"
    (( status == 3 ))
}


@test "Integration -- RHEL7, AMD, vulnerable, kernel updated" {
    uname() {
        cat file_mocks/uname_r-rhel7
    }
    export -f uname
    export MOCK_ARCH="x86_64"
    export MOCK_EUID=0
    export MOCK_CPU_INFO_PATH=file_mocks/cpuinfo-amd
    export MOCK_VULN_FILE_PATH=file_mocks/vuln-vuln/spectre_v1

    run ./"${SCRIPT_NAME}"
    (( status == 3 ))
}
