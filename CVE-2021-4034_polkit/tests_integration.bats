#!/usr/bin/env bats

export RHEL7="3.10.0-520.10.2.el7.x86_64"
export FEDORA="4.9.14-200.fc25.x86_64"
export SCRIPT_NAME=$( grep -E '^\. .*\.sh$' test_harness | sed -r 's/^\. (.*)$/\1/g' )

@test "Integration -- Fedora" {
    uname() {
        echo "$FEDORA"
    }
    rpm() {
        echo "polkit-0.120-1.fc35.x86_64"
    }
    export -f uname
    export -f rpm

    run ./"${SCRIPT_NAME}"
    (( status == 1 ))
    [[ "$output" == *"This script is meant to be used only on RHEL 6-8."* ]]
    [[ "$output" != *"Detected 'polkit' package:"* ]]
    [[ "$output" != *"This polkit version is vulnerable."* ]]
    [[ "$output" != *"This polkit version is not vulnerable."* ]]
}


@test "Integration -- RHEL7 - vuln ver installed" {
    uname() {
        echo "$RHEL7"
    }
    rpm() {
        echo "polkit-0.112-11.el7_3.x86_64"
    }
    export -f uname
    export -f rpm

    run ./"${SCRIPT_NAME}" -n
    (( status == 1 ))

    [[ "$output" == *"Detected 'polkit' package: polkit-0.112-11.el7_3.x86_64"* ]]
    [[ "$output" == *"This polkit version is vulnerable."* ]]
    [[ "$output" != *"This polkit version is not vulnerable."* ]]
}


@test "Integration -- RHEL7 - broken rpmdb, multiple vuln vers installed" {
    uname() {
        echo "$RHEL7"
    }
    rpm() {
        echo 'polkit-0.112-11.el7_3.x86_64'
        echo 'polkit-0.112-12.el7_3.x86_64'
        echo 'polkit-0.112-12.el7_4.1.x86_64'
    }
    export -f uname
    export -f rpm

    run ./"${SCRIPT_NAME}" -n
    (( status == 1 ))

    [[ "$output" == *"Detected 'polkit' package: polkit-0.112-11.el7_3.x86_64"* ]]
    # NOTE: Also displays the other versions. This being a broken state of the rpmdb,
    # there's no sure way for the script to detect which version is actually installed,
    # so this behavior is acceptable. See https://access.redhat.com/solutions/3924551
    # for more information.
    [[ "$output" == *"This polkit version is vulnerable."* ]]
    [[ "$output" != *"This polkit version is not vulnerable."* ]]
}


@test "Integration -- RHEL7 - polkit not installed" {
    uname() {
        echo "$RHEL7"
    }
    rpm() {
        return 0
    }
    export -f uname
    export -f rpm

    run ./"${SCRIPT_NAME}" -n
    (( status == 0 ))
    [[ "$output" != *"Detected 'polkit' package:"* ]]
    [[ "$output" != *"This polkit version is vulnerable."* ]]
    [[ "$output" != *"This polkit version is not vulnerable."* ]]
    [[ "$output" == *"'polkit' is not installed."* ]]
}


@test "Integration -- RHEL7 - nonvuln ver installed" {
    uname() {
        echo "$RHEL7"
    }
    rpm() {
        echo "polkit-0.115-12345.el8.x86_64"
    }
    export -f uname
    export -f rpm

    run ./"${SCRIPT_NAME}" -n
    (( status == 0 ))

    [[ "$output" == *"Detected 'polkit' package: polkit-0.115-12345.el8.x86_64"* ]]
    [[ "$output" != *"This polkit version is vulnerable."* ]]
    [[ "$output" == *"This polkit version is not vulnerable."* ]]
}
