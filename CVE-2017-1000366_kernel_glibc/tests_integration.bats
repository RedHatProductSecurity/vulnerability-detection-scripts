#!/usr/bin/env bats

export SCRIPT="./CVE-2017-1000366.sh"

export GLIBC6_VULNERABLE="glibc-2.12-1.80.el6_3.3.x86_64"
export GLIBC6_SAFE="glibc-3.12-1.80.el6_3.3.x86_64"
export GLIBC7_VULNERABLE="glibc-2.17-105.el7.x86_64"
export GLIBC7_SAFE="glibc-3.17-105.el7.x86_64"

export RHEL6_VULNERABLE="2.6.32-71.7.1.el6.x86_64"
export RHEL6_SAFE="2.7.32-696.1.1.el6.x86_64"
export RHEL7_VULNERABLE="3.10.0-123.1.2.el7.x86_64"
export RHEL7_SAFE="3.11.0-123.1.2.el7.x86_64"
export FEDORA="4.9.14-200.fc25.x86_64"


@test "Integration -- RHEL6, glibc safe, kernel safe" {
    rpm() {
        echo "$GLIBC6_SAFE"
    }
    uname() {
        echo "$RHEL6_SAFE"
    }
    export -f rpm
    export -f uname

    run "$SCRIPT"
    (( status == 0 ))
    [[ "$output" == *"'glibc' version is not"* ]]
    [[ "$output" == *"'kernel' version is not"* ]]
}


@test "Integration -- RHEL6, glibc vulnerable, kernel safe" {
    rpm() {
        echo "$GLIBC6_VULNERABLE"
    }
    uname() {
        echo "$RHEL6_SAFE"
    }
    export -f rpm
    export -f uname

    run "$SCRIPT"
    (( status == 4 ))
    [[ "$output" == *"'glibc' version is vul"* ]]
    [[ "$output" == *"'kernel' version is not"* ]]
}


@test "Integration -- RHEL6, glibc safe, kernel vulnerable" {
    rpm() {
        echo "$GLIBC6_SAFE"
    }
    uname() {
        echo "$RHEL6_VULNERABLE"
    }
    export -f rpm
    export -f uname

    run "$SCRIPT"
    (( status == 3 ))
    [[ "$output" == *"'glibc' version is not"* ]]
    [[ "$output" == *"'kernel' version is vul"* ]]
}


@test "Integration -- RHEL6, both vulnerable" {
    rpm() {
        echo "$GLIBC6_VULNERABLE"
    }
    uname() {
        echo "$RHEL6_VULNERABLE"
    }
    export -f rpm
    export -f uname

    run "$SCRIPT"
    (( status == 2 ))
    [[ "$output" == *"'glibc' version is vul"* ]]
    [[ "$output" == *"'kernel' version is vul"* ]]
}


@test "Integration -- RHEL7, glibc safe, kernel safe" {
    rpm() {
        echo "$GLIBC7_SAFE"
    }
    uname() {
        echo "$RHEL7_SAFE"
    }
    export -f rpm
    export -f uname

    run "$SCRIPT"
    (( status == 0 ))
    [[ "$output" == *"'glibc' version is not"* ]]
    [[ "$output" == *"'kernel' version is not"* ]]
}


@test "Integration -- RHEL7, glibc vulnerable, kernel safe" {
    rpm() {
        echo "$GLIBC7_VULNERABLE"
    }
    uname() {
        echo "$RHEL7_SAFE"
    }
    export -f rpm
    export -f uname

    run "$SCRIPT"
    (( status == 4 ))
    [[ "$output" == *"'glibc' version is vul"* ]]
    [[ "$output" == *"'kernel' version is not"* ]]
}


@test "Integration -- RHEL7, glibc safe, kernel vulnerable" {
    rpm() {
        echo "$GLIBC7_SAFE"
    }
    uname() {
        echo "$RHEL7_VULNERABLE"
    }
    export -f rpm
    export -f uname

    run "$SCRIPT"
    (( status == 3 ))
    [[ "$output" == *"'glibc' version is not"* ]]
    [[ "$output" == *"'kernel' version is vul"* ]]
}


@test "Integration -- RHEL7, both vulnerable" {
    rpm() {
        echo "$GLIBC7_VULNERABLE"
    }
    uname() {
        echo "$RHEL7_VULNERABLE"
    }
    export -f rpm
    export -f uname

    run "$SCRIPT"
    (( status == 2 ))
    [[ "$output" == *"'glibc' version is vul"* ]]
    [[ "$output" == *"'kernel' version is vul"* ]]
}


@test "Integration -- RHEL7, both vulnerable, kpatch applied" {
    rpm() {
        echo "$GLIBC7_VULNERABLE"
    }
    uname() {
        echo "$RHEL7_VULNERABLE"
    }
    lsmod() {
        echo "kpatch_3_10_0_514_21_1_1_2"
    }
    export -f rpm
    export -f uname
    export -f lsmod

    run "$SCRIPT" --no-colors
    (( status == 4 ))
    [[ "$output" == *"'glibc' version is vul"* ]]
    [[ "$output" == *"'kernel' version is vul"* ]]
    [[ "$output" == *"You have correct kpatch installed"* ]]
}


@test "Integration -- Fedora" {
    uname() {
        echo "$FEDORA"
    }
    export -f uname

    run "$SCRIPT"
    (( status == 1 ))
    [[ "$output" == *"is meant to be used only on Red Hat"* ]]
}
