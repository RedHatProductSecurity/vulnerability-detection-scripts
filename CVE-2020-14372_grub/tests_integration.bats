#!/usr/bin/env bats

export RHEL7="3.10.0-520.10.2.el7.x86_64"
export RHEL8="4.18.0-80.el8.x86_64"
export FEDORA="4.9.14-200.fc25.x86_64"
export SCRIPT_NAME=$( grep -E '^\. .*\.sh$' test_harness | sed -r 's/^\. (.*)$/\1/g' )
export RHEL7_SECBOOT_DMESG="Secure boot enabled"

journalctl() {
    echo "nothing relevant"
}

rpm_rh7_allvuln() {
    if [[ "$2" == '--queryformat=%{NAME}\n' ]]; then
        while (( "$#" >= 3 )) ; do
            if [[ "$3" == "shim-x64" ]]; then
                echo "shim-x64"
            fi
            if [[ "$3" == "grub2-efi" ]]; then
                echo "grub2-efi"
            fi
            shift
        done
    else
        while (( "$#" >= 3 )) ; do
            if [[ "$3" == "shim-x64" ]]; then
                echo "shim-x64-12-1.el7.x86_64"
            fi
            if [[ "$3" == "grub2-efi" ]]; then
                echo "grub2-efi-2.02-0.44.el7.x86_64"
            fi
            shift
        done
    fi
}

rpm_rh7_allvuln_bios() {
    if [[ "$2" == '--queryformat=%{NAME}\n' ]]; then
        while (( "$#" >= 3 )) ; do
            if [[ "$3" == "grub2" ]]; then
                echo "grub2"
            fi
            shift
        done
    else
        while (( "$#" >= 3 )) ; do
            if [[ "$3" == "grub2" ]]; then
                echo "grub2-2.02-0.44.el7.x86_64"
            fi
            shift
        done
    fi
}

rpm_rh7_allvuln_bios_only_grub2pc() {
    if [[ "$2" == '--queryformat=%{NAME}\n' ]]; then
        while (( "$#" >= 3 )) ; do
            if [[ "$3" == "grub2-pc" ]]; then
                echo "grub2-pc"
            fi
            shift
        done
    else
        while (( "$#" >= 3 )) ; do
            if [[ "$3" == "grub2-pc" ]]; then
                echo "grub2-pc-2.02-0.64.el7.x86_64"
            fi
            shift
        done
    fi
}

rpm_rh7_kernvuln_fixedgrub_bios() {
    if [[ "$2" == '--queryformat=%{NAME}\n' ]]; then
        while (( "$#" >= 3 )) ; do
            if [[ "$3" == "grub2" ]]; then
                echo "grub2"
            fi
            shift
        done
    else
        while (( "$#" >= 3 )) ; do
            if [[ "$3" == "grub2" ]]; then
                echo "grub2-9992.02-0.44.el7.x86_64"
            fi
            shift
        done
    fi
}

rpm_rh7_allvuln_nogrub() {
    if [[ "$2" == '--queryformat=%{NAME}\n' ]]; then
        while (( "$#" >= 3 )) ; do
            shift
        done
    else
        while (( "$#" >= 3 )) ; do
            shift
        done
    fi
}

rpm_rh7_allvuln_shimgrub_somevuln() {
    if [[ "$2" == '--queryformat=%{NAME}\n' ]]; then
        while (( "$#" >= 3 )) ; do
            if [[ "$3" == "shim-x64" ]]; then
                echo "shim-x64"
            fi
            if [[ "$3" == "grub2-efi" ]]; then
                echo "grub2-efi"
            fi
            shift
        done
    else
        while (( "$#" >= 3 )) ; do
            if [[ "$3" == "shim-x64" ]]; then
                echo "shim-x64-12-1.el7.x86_64"
            fi
            if [[ "$3" == "grub2-efi" ]]; then
                echo "grub2-efi-2.02-0.44.el7.x86_64"
            fi
            shift
        done
    fi
}

rpm_rh7_somevuln_shim() {
    if [[ "$2" == '--queryformat=%{NAME}\n' ]]; then
        while (( "$#" >= 3 )) ; do
            if [[ "$3" == "shim-x64" ]]; then
                echo "shim-x64"
            fi
            if [[ "$3" == "grub2-efi" ]]; then
                echo "grub2-efi"
            fi
            shift
        done
    else
        while (( "$#" >= 3 )) ; do
            if [[ "$3" == "shim-x64" ]]; then
                echo "shim-x64-12-1.el7.x86_64"
            fi
            if [[ "$3" == "grub2-efi" ]]; then
                echo "grub2-efi-2.02-1.foobar.el7.x86_64"
            fi
            shift
        done
    fi
}

rpm_rh7_allfix() {
    if [[ "$2" == '--queryformat=%{NAME}\n' ]]; then
        while (( "$#" >= 3 )) ; do
            if [[ "$3" == "shim-x64" ]]; then
                echo "shim-x64"
            fi
            if [[ "$3" == "grub2-efi" ]]; then
                echo "grub2-efi"
            fi
            shift
        done
    else
        while (( "$#" >= 3 )) ; do
            if [[ "$3" == "shim-x64" ]]; then
                echo "shim-x64-13-foobar.el7.x86_64"
            fi
            if [[ "$3" == "grub2-efi" ]]; then
                echo "grub2-efi-2.02-1.foobar.el7.x86_64"
            fi
            shift
        done
    fi
}


rpm_rh7_fixedshim_vulngrub() {
    if [[ "$2" == '--queryformat=%{NAME}\n' ]]; then
        while (( "$#" >= 3 )) ; do
            if [[ "$3" == "shim-x64" ]]; then
                echo "shim-x64"
            fi
            if [[ "$3" == "grub2-efi" ]]; then
                echo "grub2-efi"
            fi
            shift
        done
    else
        while (( "$#" >= 3 )) ; do
            if [[ "$3" == "shim-x64" ]]; then
                echo "shim-x64-13-foobar.el7.x86_64"
            fi
            if [[ "$3" == "grub2-efi" ]]; then
                echo "grub2-efi-2.02-0.44.el7.x86_64"
            fi
            shift
        done
    fi
}


rpm_rh7_vulnshim_fixedgrub() {
    if [[ "$2" == '--queryformat=%{NAME}\n' ]]; then
        while (( "$#" >= 3 )) ; do
            if [[ "$3" == "shim-x64" ]]; then
                echo "shim-x64"
            fi
            if [[ "$3" == "grub2-efi" ]]; then
                echo "grub2-efi"
            fi
            shift
        done
    else
        while (( "$#" >= 3 )) ; do
            if [[ "$3" == "shim-x64" ]]; then
                echo "shim-x64-12-1.el7.x86_64"
            fi
            if [[ "$3" == "grub2-efi" ]]; then
                echo "grub2-9992.02-0.44.el7.x86_64"
            fi
            shift
        done
    fi
}


@test "Integration -- Fedora" {
    uname() {
        echo "$FEDORA"
    }
    export -f uname

    run ./"${SCRIPT_NAME}"
    (( status == 1 ))
}


@test "Integration -- RHEL7, secboot, all vulnerable" {
    uname() {
        echo "$RHEL7"
    }
    rpm() {
        rpm_rh7_allvuln "$@"
    }
    dmesg() {
        echo "$RHEL7_SECBOOT_DMESG"
    }
    mokutil() {
        echo "blabla"
    }
    export -f uname
    export -f rpm_rh7_allvuln
    export -f rpm
    export -f dmesg
    export -f journalctl
    export -f mokutil
    export MOCK_DMESG_PATH=/dev/null
    export MOCK_EFI_PATH=file_mocks/efivars/empty


    run ./"${SCRIPT_NAME}" -n
    (( status == 8 ))
    [[ "$output" != *"This system is not vulnerable."* ]]
    [[ "$output" == *"This system is vulnerable."* ]]
    [[ "$output" == *"Vulnerable versions of the affected packages are installed."* ]]
    local pkglist="* The following installed packages are affected:

grub2-efi
shim-x64
"
    [[ "$output" == *"$pkglist"* ]]
    run ./"${SCRIPT_NAME}" -n -d
    [[ "$output" == *"bootproblem = *0*"* ]]
    [[ "$output" == *"fixed_shim = *0*"* ]]
    [[ "$output" == *"fixed_grub = *0*"* ]]
    [[ "$output" == *"secure_boot_active_dmesg = *1*"* ]]
}


@test "Integration -- RHEL7, secboot, all vulnerable shim, grub" {
    uname() {
        echo "$RHEL7"
    }
    rpm() {
        rpm_rh7_allvuln_shimgrub_somevuln "$@"
    }
    dmesg() {
        echo "$RHEL7_SECBOOT_DMESG"
    }
    mokutil() {
        echo "blabla"
    }
    export -f uname
    export -f rpm_rh7_allvuln_shimgrub_somevuln
    export -f rpm
    export -f dmesg
    export -f journalctl
    export -f mokutil
    export MOCK_DMESG_PATH=/dev/null
    export MOCK_EFI_PATH=file_mocks/efivars/empty


    run ./"${SCRIPT_NAME}" -n
    (( status == 8 ))
    [[ "$output" != *"This system is not vulnerable."* ]]
    [[ "$output" == *"This system is vulnerable."* ]]
    [[ "$output" == *"Vulnerable versions of the affected packages are installed."* ]]
    local pkglist="* The following installed packages are affected:

grub2-efi
shim-x64
"
    [[ "$output" == *"$pkglist"* ]]
    run ./"${SCRIPT_NAME}" -n -d
    [[ "$output" == *"bootproblem = *0*"* ]]
    [[ "$output" == *"fixed_shim = *0*"* ]]
    [[ "$output" == *"fixed_grub = *0*"* ]]
    [[ "$output" == *"secure_boot_active_dmesg = *1*"* ]]
}



@test "Integration -- RHEL7, secboot, some vulnerable shim" {
    uname() {
        echo "$RHEL7"
    }
    rpm() {
        rpm_rh7_somevuln_shim "$@"
    }
    dmesg() {
        echo "$RHEL7_SECBOOT_DMESG"
    }
    mokutil() {
        echo "blabla"
    }
    export -f uname
    export -f rpm_rh7_somevuln_shim
    export -f rpm
    export -f dmesg
    export -f journalctl
    export -f mokutil
    export MOCK_DMESG_PATH=/dev/null
    export MOCK_EFI_PATH=file_mocks/efivars/empty


    run ./"${SCRIPT_NAME}" -n
    (( status == 4 ))
    [[ "$output" != *"This system is not vulnerable."* ]]
    [[ "$output" == *"This system is vulnerable."* ]]
    [[ "$output" == *"Only a partial update of the affected packages has been applied."* ]]
    local pkglist="* The following installed packages are affected:

shim-x64
"
    [[ "$output" == *"$pkglist"* ]]
    run ./"${SCRIPT_NAME}" -n -d
    [[ "$output" == *"bootproblem = *0*"* ]]
    [[ "$output" == *"fixed_shim = *0*"* ]]
    [[ "$output" == *"fixed_grub = *1*"* ]]
    [[ "$output" == *"secure_boot_active_dmesg = *1*"* ]]
}


@test "Integration -- RHEL7, secboot, all fixed" {
    uname() {
        echo "$RHEL7"
    }
    rpm() {
        rpm_rh7_allfix "$@"
    }
    dmesg() {
        echo "$RHEL7_SECBOOT_DMESG"
    }
    mokutil() {
        echo "blabla"
    }
    export -f uname
    export -f rpm_rh7_allfix
    export -f rpm
    export -f dmesg
    export -f journalctl
    export -f mokutil
    export MOCK_DMESG_PATH=/dev/null
    export MOCK_EFI_PATH=file_mocks/efivars/empty


    run ./"${SCRIPT_NAME}" -n
    (( status == 0 ))
    [[ "$output" != *"This system is vulnerable."* ]]
    [[ "$output" == *"This system is not vulnerable."* ]]
    [[ "$output" == *"Vulnerable package versions not installed"* ]]
    run ./"${SCRIPT_NAME}" -n -d
    [[ "$output" == *"bootproblem = *0*"* ]]
    [[ "$output" == *"fixed_shim = *1*"* ]]
    [[ "$output" == *"fixed_grub = *1*"* ]]
    [[ "$output" == *"secure_boot_active_dmesg = *1*"* ]]
}


@test "Integration -- RHEL7, secure boot disabled" {
    uname() {
        echo "$RHEL7"
    }
    rpm() {
        rpm_rh7_allvuln "$@"
    }
    dmesg() {
        echo "foobaz!"
    }
    mokutil() {
        >&2 echo "EFI variables are not supported on this system"
    }
    export -f uname
    export -f rpm_rh7_allvuln
    export -f rpm
    export -f dmesg
    export -f journalctl
    export -f mokutil
    export MOCK_DMESG_PATH=/dev/null
    export MOCK_EFI_PATH=file_mocks/efivars/empty


    run ./"${SCRIPT_NAME}" -n
    (( status == 0 ))
    [[ "$output" == *"This system is not vulnerable."* ]]
    [[ "$output" != *"This system is vulnerable."* ]]
    [[ "$output" != *"Vulnerable versions of the affected packages are installed."* ]]
    [[ "$output" != *"EFI variables are not supported on this system"* ]]
    [[ "$output" == *"Secure Boot is not enabled"* ]]
    run ./"${SCRIPT_NAME}" -n -d
    [[ "$output" == *"bootproblem = *0*"* ]]
    [[ "$output" == *"fixed_shim = *0*"* ]]
    [[ "$output" == *"fixed_grub = *0*"* ]]
    [[ "$output" == *"secure_boot_active_dmesg = *0*"* ]]
    [[ "$output" == *"secure_boot_active_mokutil = *0*"* ]]
    [[ "$output" == *"secure_boot_active_firmware = *0*"* ]]
}


@test "Integration -- RHEL7, secboot, all vulnerable, mokutil" {
    uname() {
        echo "$RHEL7"
    }
    rpm() {
        rpm_rh7_allvuln "$@"
    }
    dmesg() {
        echo "foobaz!"
    }
    mokutil() {
        echo "SecureBoot enabled"
    }
    export -f uname
    export -f rpm_rh7_allvuln
    export -f rpm
    export -f dmesg
    export -f journalctl
    export -f mokutil
    export MOCK_DMESG_PATH=/dev/null
    export MOCK_EFI_PATH=file_mocks/efivars/empty


    run ./"${SCRIPT_NAME}" -n
    (( status == 8 ))
    [[ "$output" != *"This system is not vulnerable."* ]]
    [[ "$output" == *"This system is vulnerable."* ]]
    [[ "$output" == *"Vulnerable versions of the affected packages are installed."* ]]
    local pkglist="* The following installed packages are affected:

grub2-efi
shim-x64
"
    [[ "$output" == *"$pkglist"* ]]
    run ./"${SCRIPT_NAME}" -n -d
    [[ "$output" == *"bootproblem = *0*"* ]]
    [[ "$output" == *"fixed_shim = *0*"* ]]
    [[ "$output" == *"fixed_grub = *0*"* ]]
    [[ "$output" == *"secure_boot_active_dmesg = *0*"* ]]
    [[ "$output" == *"secure_boot_active_mokutil = *1*"* ]]
    [[ "$output" == *"secure_boot_active_firmware = *0*"* ]]
}


@test "Integration -- RHEL7, secboot, shim fixed, grub vulnerable, efivars" {
    uname() {
        echo "$RHEL7"
    }
    rpm() {
        rpm_rh7_fixedshim_vulngrub "$@"
    }
    dmesg() {
        echo "foobaz!"
    }
    mokutil() {
        echo "blabla"
    }
    export -f uname
    export -f rpm_rh7_fixedshim_vulngrub 
    export -f rpm
    export -f dmesg
    export -f journalctl
    export -f mokutil
    export MOCK_DMESG_PATH=/dev/null
    export MOCK_EFI_PATH=file_mocks/efivars/enabled


    run ./"${SCRIPT_NAME}" -n
    (( status == 2 ))
    [[ "$output" != *"This system is not vulnerable."* ]]
    [[ "$output" == *"This system is vulnerable."* ]]
    [[ "$output" != *"Vulnerable versions of the affected packages are installed."* ]]
    [[ "$output" == *"Only a partial update of the affected packages has been applied."* ]]
    [[ "$output" == *"Additionally, the system might be unable to boot correctly in its current configuration. To resolve the issue, update all the listed packages."* ]]
    local pkglist="* The following installed packages are affected:

grub2-efi
"
    [[ "$output" == *"$pkglist"* ]]
    run ./"${SCRIPT_NAME}" -n -d
    [[ "$output" == *"bootproblem = *1*"* ]]
    [[ "$output" == *"fixed_shim = *1*"* ]]
    [[ "$output" == *"fixed_grub = *0*"* ]]
    [[ "$output" == *"secure_boot_active_dmesg = *0*"* ]]
    [[ "$output" == *"secure_boot_active_mokutil = *0*"* ]]
    [[ "$output" == *"secure_boot_active_firmware = *1*"* ]]
}


@test "Integration -- RHEL7, secboot, shim vulnerable, grub fixed, efivars" {
    uname() {
        echo "$RHEL7"
    }
    rpm() {
        rpm_rh7_vulnshim_fixedgrub "$@"
    }
    dmesg() {
        echo "foobaz!"
    }
    mokutil() {
        echo "blabla"
    }
    export -f uname
    export -f rpm_rh7_vulnshim_fixedgrub
    export -f rpm
    export -f dmesg
    export -f journalctl
    export -f mokutil
    export MOCK_DMESG_PATH=/dev/null
    export MOCK_EFI_PATH=file_mocks/efivars/enabled


    run ./"${SCRIPT_NAME}" -n
    (( status == 4 ))
    [[ "$output" != *"This system is not vulnerable."* ]]
    [[ "$output" == *"This system is vulnerable."* ]]
    [[ "$output" != *"Vulnerable versions of the affected packages are installed."* ]]
    [[ "$output" == *"Only a partial update of the affected packages has been applied."* ]]
    [[ "$output" != *"Additionally, the system might be unable to boot correctly in its current configuration. To resolve the issue, update all the listed packages."* ]]
    local pkglist="* The following installed packages are affected:

shim-x64
"
    [[ "$output" == *"$pkglist"* ]]
    run ./"${SCRIPT_NAME}" -n -d
    [[ "$output" == *"bootproblem = *0*"* ]]
    [[ "$output" == *"fixed_shim = *0*"* ]]
    [[ "$output" == *"fixed_grub = *1*"* ]]
    [[ "$output" == *"secure_boot_active_dmesg = *0*"* ]]
    [[ "$output" == *"secure_boot_active_mokutil = *0*"* ]]
    [[ "$output" == *"secure_boot_active_firmware = *1*"* ]]
}


@test "Integration -- RHEL7, secboot, all vulnerable, efivars" {
    uname() {
        echo "$RHEL7"
    }
    rpm() {
        rpm_rh7_allvuln "$@"
    }
    dmesg() {
        echo "foobaz!"
    }
    mokutil() {
        echo "blabla"
    }
    export -f uname
    export -f rpm_rh7_allvuln
    export -f rpm
    export -f dmesg
    export -f journalctl
    export -f mokutil
    export MOCK_DMESG_PATH=/dev/null
    export MOCK_EFI_PATH=file_mocks/efivars/enabled


    run ./"${SCRIPT_NAME}" -n
    (( status == 8 ))
    [[ "$output" != *"This system is not vulnerable."* ]]
    [[ "$output" == *"This system is vulnerable."* ]]
    [[ "$output" == *"Vulnerable versions of the affected packages are installed."* ]]
    local pkglist="* The following installed packages are affected:

grub2-efi
shim-x64
"
    [[ "$output" == *"$pkglist"* ]]
    run ./"${SCRIPT_NAME}" -n -d
    [[ "$output" == *"bootproblem = *0*"* ]]
    [[ "$output" == *"fixed_shim = *0*"* ]]
    [[ "$output" == *"fixed_grub = *0*"* ]]
    [[ "$output" == *"secure_boot_active_dmesg = *0*"* ]]
    [[ "$output" == *"secure_boot_active_mokutil = *0*"* ]]
    [[ "$output" == *"secure_boot_active_firmware = *1*"* ]]
}


@test "Integration -- RHEL7, secure boot disabled, efivars" {
    uname() {
        echo "$RHEL7"
    }
    rpm() {
        rpm_rh7_allvuln "$@"
    }
    dmesg() {
        echo "foobaz!"
    }
    mokutil() {
        echo "blabla"
    }
    export -f uname
    export -f rpm_rh7_allvuln
    export -f rpm
    export -f dmesg
    export -f journalctl
    export -f mokutil
    export MOCK_DMESG_PATH=/dev/null
    export MOCK_EFI_PATH=file_mocks/efivars/disabled


    run ./"${SCRIPT_NAME}" -n
    (( status == 0 ))
    [[ "$output" == *"This system is not vulnerable."* ]]
    [[ "$output" != *"This system is vulnerable."* ]]
    [[ "$output" != *"Vulnerable versions of the affected packages are installed."* ]]
    run ./"${SCRIPT_NAME}" -n -d
    [[ "$output" == *"bootproblem = *0*"* ]]
    [[ "$output" == *"fixed_shim = *0*"* ]]
    [[ "$output" == *"fixed_grub = *0*"* ]]
    [[ "$output" == *"secure_boot_active_dmesg = *0*"* ]]
    [[ "$output" == *"secure_boot_active_mokutil = *0*"* ]]
    [[ "$output" == *"secure_boot_active_firmware = *0*"* ]]
}


@test "Integration -- RHEL7, BIOS" {
    uname() {
        echo "$RHEL7"
    }
    rpm() {
        rpm_rh7_allvuln_bios "$@"
    }
    dmesg() {
        echo "foobaz!"
    }
    mokutil() {
        echo "EFI variables are not supported on this system"
    }
    export -f uname
    export -f rpm_rh7_allvuln_bios
    export -f rpm
    export -f dmesg
    export -f journalctl
    export -f mokutil
    export MOCK_DMESG_PATH=/dev/null
    export MOCK_EFI_PATH=file_mocks/efivars/nonexistent


    run ./"${SCRIPT_NAME}" -n
    (( status == 0 ))
    [[ "$output" == *"This system is not vulnerable."* ]]
    [[ "$output" != *"This system is vulnerable."* ]]
    [[ "$output" != *"Vulnerable versions of the affected packages are installed."* ]]
    [[ "$output" == *"Secure Boot is not enabled."* ]]
    run ./"${SCRIPT_NAME}" -n -d
    [[ "$output" == *"bootproblem = *0*"* ]]
    [[ "$output" == *"fixed_shim = *1*"* ]]
    [[ "$output" == *"fixed_grub = *0*"* ]]
    [[ "$output" == *"secure_boot_active_dmesg = *0*"* ]]
    [[ "$output" == *"secure_boot_active_mokutil = *0*"* ]]
    [[ "$output" == *"secure_boot_active_firmware = *0*"* ]]
}


@test "Integration -- RHEL7, BIOS, grub2-pc instead of grub2" {
    uname() {
        echo "$RHEL7"
    }
    rpm() {
        rpm_rh7_allvuln_bios_only_grub2pc "$@"
    }
    dmesg() {
        echo "foobaz!"
    }
    mokutil() {
        echo "EFI variables are not supported on this system"
    }
    export -f uname
    export -f rpm_rh7_allvuln_bios_only_grub2pc
    export -f rpm
    export -f dmesg
    export -f journalctl
    export -f mokutil
    export MOCK_DMESG_PATH=/dev/null
    export MOCK_EFI_PATH=file_mocks/efivars/nonexistent


    run ./"${SCRIPT_NAME}" -n
    (( status == 0 ))
    [[ "$output" == *"This system is not vulnerable."* ]]
    [[ "$output" != *"This system is vulnerable."* ]]
    [[ "$output" != *"Vulnerable versions of the affected packages are installed."* ]]
    [[ "$output" == *"Secure Boot is not enabled."* ]]
    run ./"${SCRIPT_NAME}" -n -d
    [[ "$output" == *"bootproblem = *0*"* ]]
    [[ "$output" == *"fixed_shim = *1*"* ]]
    [[ "$output" == *"fixed_grub = *0*"* ]]
    [[ "$output" == *"secure_boot_active_dmesg = *0*"* ]]
    [[ "$output" == *"secure_boot_active_mokutil = *0*"* ]]
    [[ "$output" == *"secure_boot_active_firmware = *0*"* ]]
}


@test "Integration -- RHEL7, BIOS, fixed grub" {
    uname() {
        echo "$RHEL7"
    }
    rpm() {
        rpm_rh7_kernvuln_fixedgrub_bios "$@"
    }
    dmesg() {
        echo "foobaz!"
    }
    mokutil() {
        echo "EFI variables are not supported on this system"
    }
    export -f uname
    export -f rpm_rh7_kernvuln_fixedgrub_bios
    export -f rpm
    export -f dmesg
    export -f journalctl
    export -f mokutil
    export MOCK_DMESG_PATH=/dev/null
    export MOCK_EFI_PATH=file_mocks/efivars/nonexistent


    run ./"${SCRIPT_NAME}" -n
    (( status == 0 ))
    [[ "$output" == *"This system is not vulnerable."* ]]
    [[ "$output" != *"This system is vulnerable."* ]]
    [[ "$output" != *"Vulnerable versions of the affected packages are installed."* ]]
    [[ "$output" != *"* The following installed packages are affected:"* ]]
    [[ "$output" == *"Secure Boot is not enabled."* ]]
    run ./"${SCRIPT_NAME}" -n -d
    [[ "$output" == *"bootproblem = *0*"* ]]
    [[ "$output" == *"fixed_shim = *1*"* ]]
    [[ "$output" == *"fixed_grub = *1*"* ]]
    [[ "$output" == *"secure_boot_active_dmesg = *0*"* ]]
    [[ "$output" == *"secure_boot_active_mokutil = *0*"* ]]
    [[ "$output" == *"secure_boot_active_firmware = *0*"* ]]
}


@test "Integration -- RHEL7, no efi, no grub, secboot" {
    uname() {
        echo "$RHEL7"
    }
    rpm() {
        rpm_rh7_allvuln_nogrub "$@"
    }
    dmesg() {
        echo "$RHEL7_SECBOOT_DMESG"
    }
    mokutil() {
        echo "EFI variables are not supported on this system"
    }
    export -f uname
    export -f rpm_rh7_allvuln_nogrub
    export -f rpm
    export -f dmesg
    export -f journalctl
    export -f mokutil
    export MOCK_DMESG_PATH=/dev/null
    export MOCK_EFI_PATH=file_mocks/efivars/nonexistent


    run ./"${SCRIPT_NAME}" -n
    (( status == 0 ))
    [[ "$output" == *"This system is not vulnerable."* ]]
    [[ "$output" != *"This system is vulnerable."* ]]
    [[ "$output" != *"Vulnerable versions of the affected packages are installed."* ]]
    [[ "$output" != *"Secure Boot is not enabled."* ]]
    [[ "$output" == *"Vulnerable package versions not installed."* ]]
    run ./"${SCRIPT_NAME}" -n -d
    [[ "$output" == *"bootproblem = *0*"* ]]
    [[ "$output" == *"fixed_shim = *1*"* ]]
    [[ "$output" == *"fixed_grub = *1*"* ]]
    [[ "$output" == *"secure_boot_active_dmesg = *1*"* ]]
    [[ "$output" == *"secure_boot_active_mokutil = *0*"* ]]
    [[ "$output" == *"secure_boot_active_firmware = *0*"* ]]
}
