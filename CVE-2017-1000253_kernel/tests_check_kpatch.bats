 #!/usr/bin/env bats

. test_harness


KPATCH_MODULE_NAMES=(
    'kpatch_3_10_0_514_26_2_1_2'
    'kpatch_3_10_0_514_6_1_1_2'
    'kpatch_3_10_0_514_1_3'
    'kpatch_3_10_0_514_2_2_1_2'
    'kpatch_3_10_0_514_16_1_1_6'
    'kpatch_3_10_0_327_1_2'
    'kpatch_3_10_0_327_59_2_1_1'
    'kpatch_3_10_0_514_32_2_1_1'
)


@test "check_kpatch -- loaded" {
    lsmod() {
        cat << EOF
Module                     Size  Used by
ip6t_rpfilter              16384  1
ip6t_REJECT                16384  2
kpatch_3_10_0_327_59_2_1_1 11111 1
EOF
    }

    run check_kpatch "${KPATCH_MODULE_NAMES[@]}"
    [[ "$output" == "kpatch_3_10_0_327_59_2_1_1" ]]
}


@test "check_kpatch -- not loaded" {
    lsmod() {
        cat << EOF
Module                     Size  Used by
ip6t_rpfilter              16384  1
ip6t_REJECT                16384  2
EOF
    }

    run check_kpatch "${KPATCH_MODULE_NAMES[@]}"
    [[ ! "$output" ]]
}


