#!/usr/bin/env bats

export RHEL7="3.10.0-520.10.2.el7.x86_64"
export FEDORA="4.9.14-200.fc25.x86_64"
export SCRIPT_NAME=$( grep -E '^\. .*\.sh$' test_harness | sed -r 's/^\. (.*)$/\1/g' )


@test "Integration -- Fedora" {
    uname() {
        echo "$FEDORA"
    }
    export -f uname

    run ./"${SCRIPT_NAME}"
    (( status == 1 ))
}


@test "Integration -- RHEL7, all vulnerable" {
    uname() {
        echo "$RHEL7"
    }
    rpm() {
        if [[ "$3" == "runc" ]]; then
            echo "runc-0.1.1-5.el7.x86_64"
        fi
        if [[ "$3" == "docker" ]]; then
            echo "docker-1.12.5-14.el7.x86_64"
        fi
        if [[ "$3" == "docker-latest" ]]; then
            echo "docker-latest-1.12.1-2.el7.x86_64"
        fi
    }
    export -f uname
    export -f rpm

    run ./"${SCRIPT_NAME}" -n
    (( status == 14 ))
    [[ "$output" == *"'runc' package is vulnerable"* ]]
    [[ "$output" == *"'docker' package is vulnerable"* ]]
    [[ "$output" == *"'docker-latest' package is vulnerable"* ]]

    # More thorough tests
    [[ "$output" == *"Detected packages:"* ]]
    [[ "$output" == *"Detected 'runc' package: runc-0.1.1-5.el7.x86_64"* ]]
    [[ "$output" != *"Package 'runc' not installed."* ]]
    [[ "$output" == *"Detected 'docker' package: docker-1.12.5-14.el7.x86_64"* ]]
    [[ "$output" != *"Package 'docker' not installed."* ]]
    [[ "$output" == *"Detected 'docker-latest' package: docker-latest-1.12.1-2.el7.x86_64"* ]]
    [[ "$output" != *"Package 'docker-latest' not installed."* ]]
    [[ "$output" == *"This system is vulnerable:"* ]]
    [[ "$output" != *"This system is not vulnerable:"* ]]
    [[ "$output" != *"This system is not vulnerable."* ]]
    [[ "$output" == *"'runc' package is vulnerable"* ]]
    [[ "$output" != *"'runc' package is NOT vulnerable"* ]]
    [[ "$output" == *"'docker' package is vulnerable"* ]]
    [[ "$output" != *"'docker' package is NOT vulnerable"* ]]
    [[ "$output" == *"'docker-latest' package is vulnerable"* ]]
    [[ "$output" != *"'docker-latest' package is NOT vulnerable"* ]]
    [[ "$output" != *"There are NO vulnerable packages"* ]]
}


@test "Integration -- RHEL7, all vulnerable but docker" {
    uname() {
        echo "$RHEL7"
    }
    rpm() {
        if [[ "$3" == "runc" ]]; then
            echo "runc-0.1.1-5.el7.x86_64"
        fi
        if [[ "$3" == "docker" ]]; then
            echo "docker-5.12.5-14.el7.x86_64"
        fi
        if [[ "$3" == "docker-latest" ]]; then
            echo "docker-latest-1.12.1-2.el7.x86_64"
        fi
    }
    export -f uname
    export -f rpm

    run ./"${SCRIPT_NAME}" -n
    (( status == 10 ))
    [[ "$output" == *"'runc' package is vulnerable"* ]]
    [[ "$output" != *"'docker' package is vulnerable"* ]]
    [[ "$output" == *"'docker-latest' package is vulnerable"* ]]

    # More thorough tests
    [[ "$output" == *"Detected packages:"* ]]
    [[ "$output" == *"Detected 'runc' package: runc-0.1.1-5.el7.x86_64"* ]]
    [[ "$output" != *"Package 'runc' not installed."* ]]
    [[ "$output" == *"Detected 'docker' package: docker-5.12.5-14.el7.x86_64"* ]]
    [[ "$output" != *"Package 'docker' not installed."* ]]
    [[ "$output" == *"Detected 'docker-latest' package: docker-latest-1.12.1-2.el7.x86_64"* ]]
    [[ "$output" != *"Package 'docker-latest' not installed."* ]]
    [[ "$output" == *"This system is vulnerable:"* ]]
    [[ "$output" != *"This system is not vulnerable:"* ]]
    [[ "$output" != *"This system is not vulnerable."* ]]
    [[ "$output" == *"'runc' package is vulnerable"* ]]
    [[ "$output" != *"'runc' package is NOT vulnerable"* ]]
    [[ "$output" != *"'docker' package is vulnerable"* ]]
    [[ "$output" == *"'docker' package is NOT vulnerable"* ]]
    [[ "$output" == *"'docker-latest' package is vulnerable"* ]]
    [[ "$output" != *"'docker-latest' package is NOT vulnerable"* ]]
    [[ "$output" != *"There are NO vulnerable packages"* ]]
}


@test "Integration -- RHEL7, docker vulnerable, others not installed" {
    uname() {
        echo "$RHEL7"
    }
    rpm() {
        if [[ "$3" == "runc" ]]; then
            echo
        fi
        if [[ "$3" == "docker" ]]; then
            echo "docker-1.12.5-14.el7.x86_64"
        fi
        if [[ "$3" == "docker-latest" ]]; then
            echo
        fi
    }
    export -f uname
    export -f rpm

    run ./"${SCRIPT_NAME}" -n
    (( status == 4 ))
    [[ "$output" != *"'runc' package is vulnerable"* ]]
    [[ "$output" == *"'docker' package is vulnerable"* ]]
    [[ "$output" != *"'docker-latest' package is vulnerable"* ]]

    # More thorough tests
    [[ "$output" == *"Detected packages:"* ]]
    [[ "$output" != *"Detected 'runc' package:"* ]]
    [[ "$output" == *"Package 'runc' not installed."* ]]
    [[ "$output" == *"Detected 'docker' package: docker-1.12.5-14.el7.x86_64"* ]]
    [[ "$output" != *"Package 'docker' not installed."* ]]
    [[ "$output" != *"Detected 'docker-latest' package:"* ]]
    [[ "$output" == *"Package 'docker-latest' not installed."* ]]
    [[ "$output" == *"This system is vulnerable:"* ]]
    [[ "$output" != *"This system is not vulnerable:"* ]]
    [[ "$output" != *"This system is not vulnerable."* ]]
    [[ "$output" != *"'runc' package is vulnerable"* ]]
    [[ "$output" != *"'runc' package is NOT vulnerable"* ]]
    [[ "$output" == *"'docker' package is vulnerable"* ]]
    [[ "$output" != *"'docker' package is NOT vulnerable"* ]]
    [[ "$output" != *"'docker-latest' package is vulnerable"* ]]
    [[ "$output" != *"'docker-latest' package is NOT vulnerable"* ]]
    [[ "$output" != *"There are NO vulnerable packages"* ]]
}




@test "Integration -- RHEL7, no vulnerable" {
    uname() {
        echo "$RHEL7"
    }
    rpm() {
        if [[ "$3" == "runc" ]]; then
            echo "runc-5.1.1-5.el7.x86_64"
        fi
        if [[ "$3" == "docker" ]]; then
            echo "docker-5.12.5-14.el7.x86_64"
        fi
        if [[ "$3" == "docker-latest" ]]; then
            echo "docker-latest-5.12.1-2.el7.x86_64"
        fi
    }
    export -f uname
    export -f rpm

    run ./"${SCRIPT_NAME}" -n
    (( status == 0 ))
    [[ "$output" != *"'runc' package is vulnerable"* ]]
    [[ "$output" != *"'docker' package is vulnerable"* ]]
    [[ "$output" != *"'docker-latest' package is vulnerable"* ]]
    [[ "$output" == *"There are NO vulnerable packages"* ]]

    # More thorough tests
    [[ "$output" == *"Detected packages:"* ]]
    [[ "$output" == *"Detected 'runc' package: runc-5.1.1-5.el7.x86_64"* ]]
    [[ "$output" != *"Package 'runc' not installed."* ]]
    [[ "$output" == *"Detected 'docker' package: docker-5.12.5-14.el7.x86_64"* ]]
    [[ "$output" != *"Package 'docker' not installed."* ]]
    [[ "$output" == *"Detected 'docker-latest' package: docker-latest-5.12.1-2.el7.x86_64"* ]]
    [[ "$output" != *"Package 'docker-latest' not installed."* ]]
    [[ "$output" != *"This system is vulnerable:"* ]]
    [[ "$output" == *"This system is not vulnerable:"* ]]
    [[ "$output" != *"This system is not vulnerable."* ]]
    [[ "$output" != *"'runc' package is vulnerable"* ]]
    [[ "$output" == *"'runc' package is NOT vulnerable"* ]]
    [[ "$output" != *"'docker' package is vulnerable"* ]]
    [[ "$output" == *"'docker' package is NOT vulnerable"* ]]
    [[ "$output" != *"'docker-latest' package is vulnerable"* ]]
    [[ "$output" == *"'docker-latest' package is NOT vulnerable"* ]]
    [[ "$output" == *"There are NO vulnerable packages"* ]]
}


@test "Integration -- RHEL7, no vulnerable, only runc installed" {
    uname() {
        echo "$RHEL7"
    }
    rpm() {
        if [[ "$3" == "runc" ]]; then
            echo "runc-5.1.1-5.el7.x86_64"
        fi
        if [[ "$3" == "docker" ]]; then
            echo
        fi
        if [[ "$3" == "docker-latest" ]]; then
            echo
        fi
    }
    export -f uname
    export -f rpm

    run ./"${SCRIPT_NAME}" -n
    (( status == 0 ))
    [[ "$output" == *"Detected packages:"* ]]
    [[ "$output" == *"Detected 'runc' package: runc-5.1.1-5.el7.x86_64"* ]]
    [[ "$output" == *"Package 'docker' not installed."* ]]
    [[ "$output" == *"Package 'docker-latest' not installed."* ]]
    [[ "$output" != *"This system is vulnerable:"* ]]
    [[ "$output" == *"This system is not vulnerable:"* ]]
    [[ "$output" != *"This system is not vulnerable."* ]]
    [[ "$output" != *"'runc' package is vulnerable"* ]]
    [[ "$output" == *"'runc' package is NOT vulnerable"* ]]
    [[ "$output" != *"'docker' package is vulnerable"* ]]
    [[ "$output" != *"'docker' package is NOT vulnerable"* ]]
    [[ "$output" != *"'docker-latest' package is vulnerable"* ]]
    [[ "$output" != *"'docker-latest' package is NOT vulnerable"* ]]
    [[ "$output" == *"There are NO vulnerable packages"* ]]
}


@test "Integration -- RHEL7, no vulnerable, only docker installed" {
    uname() {
        echo "$RHEL7"
    }
    rpm() {
        if [[ "$3" == "runc" ]]; then
            echo
        fi
        if [[ "$3" == "docker" ]]; then
            echo "docker-5.12.5-14.el7.x86_64"
        fi
        if [[ "$3" == "docker-latest" ]]; then
            echo
        fi
    }
    export -f uname
    export -f rpm

    run ./"${SCRIPT_NAME}" -n
    (( status == 0 ))
    [[ "$output" == *"Detected packages:"* ]]
    [[ "$output" != *"Detected 'runc' package:"* ]]
    [[ "$output" == *"Package 'runc' not installed."* ]]
    [[ "$output" == *"Detected 'docker' package: docker-5.12.5-14.el7.x86_64"* ]]
    [[ "$output" != *"Package 'docker' not installed."* ]]
    [[ "$output" != *"Detected 'docker-latest' package:"* ]]
    [[ "$output" == *"Package 'docker-latest' not installed."* ]]
    [[ "$output" != *"This system is vulnerable:"* ]]
    [[ "$output" == *"This system is not vulnerable:"* ]]
    [[ "$output" != *"This system is not vulnerable."* ]]
    [[ "$output" != *"'runc' package is vulnerable"* ]]
    [[ "$output" != *"'runc' package is NOT vulnerable"* ]]
    [[ "$output" != *"'docker' package is vulnerable"* ]]
    [[ "$output" == *"'docker' package is NOT vulnerable"* ]]
    [[ "$output" != *"'docker-latest' package is vulnerable"* ]]
    [[ "$output" != *"'docker-latest' package is NOT vulnerable"* ]]
    [[ "$output" == *"There are NO vulnerable packages"* ]]
}


@test "Integration -- RHEL7, no vulnerable, only docker-latest installed" {
    uname() {
        echo "$RHEL7"
    }
    rpm() {
        if [[ "$3" == "runc" ]]; then
            echo
        fi
        if [[ "$3" == "docker" ]]; then
            echo
        fi
        if [[ "$3" == "docker-latest" ]]; then
            echo "docker-latest-5.12.1-2.el7.x86_64"
        fi
    }
    export -f uname
    export -f rpm

    run ./"${SCRIPT_NAME}" -n
    (( status == 0 ))
    [[ "$output" == *"Detected packages:"* ]]
    [[ "$output" != *"Detected 'runc' package:"* ]]
    [[ "$output" == *"Package 'runc' not installed."* ]]
    [[ "$output" != *"Detected 'docker' package:"* ]]
    [[ "$output" == *"Package 'docker' not installed."* ]]
    [[ "$output" == *"Detected 'docker-latest' package: docker-latest-5.12.1-2.el7.x86_64"* ]]
    [[ "$output" != *"Package 'docker-latest' not installed."* ]]
    [[ "$output" != *"This system is vulnerable:"* ]]
    [[ "$output" == *"This system is not vulnerable:"* ]]
    [[ "$output" != *"This system is not vulnerable."* ]]
    [[ "$output" != *"'runc' package is vulnerable"* ]]
    [[ "$output" != *"'runc' package is NOT vulnerable"* ]]
    [[ "$output" != *"'docker' package is vulnerable"* ]]
    [[ "$output" != *"'docker' package is NOT vulnerable"* ]]
    [[ "$output" != *"'docker-latest' package is vulnerable"* ]]
    [[ "$output" == *"'docker-latest' package is NOT vulnerable"* ]]
    [[ "$output" == *"There are NO vulnerable packages"* ]]
}



@test "Integration -- RHEL7, no vulnerable, nothing installed" {
    uname() {
        echo "$RHEL7"
    }
    rpm() {
        if [[ "$3" == "runc" ]]; then
            echo
        fi
        if [[ "$3" == "docker" ]]; then
            echo
        fi
        if [[ "$3" == "docker-latest" ]]; then
            echo
        fi
    }
    export -f uname
    export -f rpm

    run ./"${SCRIPT_NAME}" -n
    (( status == 0 ))
    [[ "$output" != *"Detected packages:"* ]]
    [[ "$output" != *"Detected 'runc' package:"* ]]
    [[ "$output" == *"Package 'runc' not installed."* ]]
    [[ "$output" != *"Detected 'docker' package:"* ]]
    [[ "$output" == *"Package 'docker' not installed."* ]]
    [[ "$output" != *"Detected 'docker-latest' package:"* ]]
    [[ "$output" == *"Package 'docker-latest' not installed."* ]]
    [[ "$output" != *"This system is vulnerable:"* ]]
    [[ "$output" != *"This system is not vulnerable:"* ]]
    [[ "$output" == *"This system is not vulnerable."* ]]
    [[ "$output" != *"'runc' package is vulnerable"* ]]
    [[ "$output" != *"'runc' package is NOT vulnerable"* ]]
    [[ "$output" != *"'docker' package is vulnerable"* ]]
    [[ "$output" != *"'docker' package is NOT vulnerable"* ]]
    [[ "$output" != *"'docker-latest' package is vulnerable"* ]]
    [[ "$output" != *"'docker-latest' package is NOT vulnerable"* ]]
    [[ "$output" == *"There are NO vulnerable packages"* ]]
}

