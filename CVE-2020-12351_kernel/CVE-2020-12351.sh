#!/bin/bash

# Copyright (c) 2020  Red Hat, Inc.
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.

VERSION="1.0"

# Warning! Be sure to download the latest version of this script from its primary source:

ARTICLE="https://access.redhat.com/security/vulnerabilities/5493631"

# DO NOT blindly trust any internet sources and NEVER do `curl something | bash`!

# This script is meant for simple detection of the vulnerability. Feel free to modify it for your
# environment or needs. For more advanced detection, consider Red Hat Insights:
# https://access.redhat.com/products/red-hat-insights#getstarted

# Checking against the list of vulnerable packages is necessary because of the way how features
# are back-ported to older versions of packages in various channels.


VULNERABLE_KERNELS_CVE_2020_12351=(
    "3.10.0-693.1.1.el7"
    "3.10.0-693.2.1.el7"
    "3.10.0-693.2.2.el7"
    "3.10.0-693.5.2.el7"
    "3.10.0-693.5.2.p7ih.el7"
    "3.10.0-693.11.1.el7"
    "3.10.0-693.11.6.el7"
    "3.10.0-693.17.1.el7"
    "3.10.0-693.21.1.el7"
    "3.10.0-693.25.2.el7"
    "3.10.0-693.25.4.el7"
    "3.10.0-693.25.7.el7"
    "3.10.0-693.33.1.el7"
    "3.10.0-693.35.1.el7"
    "3.10.0-693.37.4.el7"
    "3.10.0-693.39.1.el7"
    "3.10.0-693.43.1.el7"
    "3.10.0-693.44.1.el7"
    "3.10.0-693.46.1.el7"
    "3.10.0-693.47.2.el7"
    "3.10.0-693.50.3.el7"
    "3.10.0-693.55.1.el7"
    "3.10.0-693.58.1.el7"
    "3.10.0-693.59.1.el7"
    "3.10.0-693.60.1.el7"
    "3.10.0-693.60.2.el7"
    "3.10.0-693.60.3.el7"
    "3.10.0-693.61.1.el7"
    "3.10.0-693.62.1.el7"
    "3.10.0-693.64.1.el7"
    "3.10.0-693.65.1.el7"
    "3.10.0-693.67.1.el7"
    "3.10.0-693.69.1.el7"
    "3.10.0-693.71.2.el7"
    "3.10.0-693.72.1.el7"
    "3.10.0-693.76.1.el7"
    "3.10.0-693.el7"
    "3.10.0-861.el7"
    "3.10.0-862.2.3.el7"
    "3.10.0-862.3.2.el7"
    "3.10.0-862.3.3.el7"
    "3.10.0-862.6.3.el7"
    "3.10.0-862.9.1.el7"
    "3.10.0-862.11.6.el7"
    "3.10.0-862.14.4.el7"
    "3.10.0-862.20.2.el7"
    "3.10.0-862.25.3.el7"
    "3.10.0-862.27.1.el7"
    "3.10.0-862.29.1.el7"
    "3.10.0-862.32.1.el7"
    "3.10.0-862.32.2.el7"
    "3.10.0-862.34.1.el7"
    "3.10.0-862.34.2.el7"
    "3.10.0-862.37.1.el7"
    "3.10.0-862.41.1.el7"
    "3.10.0-862.41.2.el7"
    "3.10.0-862.43.1.el7"
    "3.10.0-862.43.2.el7"
    "3.10.0-862.43.3.el7"
    "3.10.0-862.44.2.el7"
    "3.10.0-862.46.1.el7"
    "3.10.0-862.48.1.el7"
    "3.10.0-862.51.1.el7"
    "3.10.0-862.el7"
    "3.10.0-957.1.3.el7"
    "3.10.0-957.5.1.el7"
    "3.10.0-957.10.1.el7"
    "3.10.0-957.12.1.el7"
    "3.10.0-957.12.2.el7"
    "3.10.0-957.21.2.el7"
    "3.10.0-957.21.3.el7"
    "3.10.0-957.27.2.el7"
    "3.10.0-957.27.4.el7"
    "3.10.0-957.35.1.el7"
    "3.10.0-957.35.2.el7"
    "3.10.0-957.38.1.el7"
    "3.10.0-957.38.2.el7"
    "3.10.0-957.38.3.el7"
    "3.10.0-957.41.1.el7"
    "3.10.0-957.43.1.el7"
    "3.10.0-957.46.1.el7"
    "3.10.0-957.48.1.el7"
    "3.10.0-957.54.1.el7"
    "3.10.0-957.56.1.el7"
    "3.10.0-957.58.2.el7"
    "3.10.0-957.61.1.el7"
    "3.10.0-957.el7"
    "3.10.0-1062.1.1.el7"
    "3.10.0-1062.1.2.el7"
    "3.10.0-1062.4.1.el7"
    "3.10.0-1062.4.2.el7"
    "3.10.0-1062.4.3.el7"
    "3.10.0-1062.7.1.el7"
    "3.10.0-1062.9.1.el7"
    "3.10.0-1062.12.1.el7"
    "3.10.0-1062.18.1.el7"
    "3.10.0-1062.21.1.el7"
    "3.10.0-1062.26.1.el7"
    "3.10.0-1062.30.1.el7"
    "3.10.0-1062.31.2.el7"
    "3.10.0-1062.31.3.el7"
    "3.10.0-1062.33.1.el7"
    "3.10.0-1062.36.1.el7"
    "3.10.0-1062.el7"
    "3.10.0-1127.8.2.el7"
    "3.10.0-1127.10.1.el7"
    "3.10.0-1127.13.1.el7"
    "3.10.0-1127.18.2.el7"
    "3.10.0-1127.19.1.el7"
    "3.10.0-1127.el7"
    "3.10.0-1136.el7"
    "3.10.0-1149.el7"
    "3.10.0-1152.el7"
    "3.10.0-1160.2.1.el7"
    "3.10.0-1160.el7"
    "4.18.0-80.1.2.el8_0"
    "4.18.0-80.4.2.el8_0"
    "4.18.0-80.7.1.el8_0"
    "4.18.0-80.7.2.el8_0"
    "4.18.0-80.11.1.el8_0"
    "4.18.0-80.11.2.el8_0"
    "4.18.0-80.15.1.el8_0"
    "4.18.0-80.16.1.el8_0"
    "4.18.0-80.18.1.el8_0"
    "4.18.0-80.23.2.el8_0"
    "4.18.0-80.27.1.el8_0"
    "4.18.0-80.27.2.el8_0"
    "4.18.0-80.29.1.el8_0"
    "4.18.0-80.el8"
    "4.18.0-147.0.2.el8_1"
    "4.18.0-147.0.3.el8_1"
    "4.18.0-147.3.1.el8_1"
    "4.18.0-147.5.1.el8_1"
    "4.18.0-147.8.1.el8_1"
    "4.18.0-147.13.2.el8_1"
    "4.18.0-147.20.1.el8_1"
    "4.18.0-147.24.2.el8_1"
    "4.18.0-147.27.1.el8_1"
    "4.18.0-147.el8"
    "4.18.0-193.1.2.el8_2"
    "4.18.0-193.6.3.el8_2"
    "4.18.0-193.12.1.el8_2"
    "4.18.0-193.13.2.el8_2"
    "4.18.0-193.14.3.el8_2"
    "4.18.0-193.19.1.el8_2"
    "4.18.0-193.23.1.el8_2"
    "4.18.0-193.el8"
    "4.18.0-221.el8"
    "4.18.0-232.el8"
    "4.18.0-234.el8"
    "4.18.0-235.el8"
    "4.18.0-240.el8"
    "3.10.0-693.2.1.rt56.620.el7"
    "3.10.0-693.2.2.rt56.623.el7"
    "3.10.0-693.5.2.rt56.626.el7"
    "3.10.0-693.11.1.rt56.632.el7"
    "3.10.0-693.11.1.rt56.639.el7"
    "3.10.0-693.17.1.rt56.636.el7"
    "3.10.0-693.21.1.rt56.639.el7"
    "3.10.0-693.rt56.617.el7"
    "3.10.0-861.rt56.803.el7"
    "3.10.0-862.2.3.rt56.806.el7"
    "3.10.0-862.3.2.rt56.808.el7"
    "3.10.0-862.3.3.rt56.809.el7"
    "3.10.0-862.6.3.rt56.811.el7"
    "3.10.0-862.11.6.rt56.819.el7"
    "3.10.0-862.14.4.rt56.821.el7"
    "3.10.0-862.rt56.804.el7"
    "3.10.0-957.1.3.rt56.913.el7"
    "3.10.0-957.5.1.rt56.916.el7"
    "3.10.0-957.10.1.rt56.921.el7"
    "3.10.0-957.12.1.rt56.927.el7"
    "3.10.0-957.12.2.rt56.929.el7"
    "3.10.0-957.21.2.rt56.934.el7"
    "3.10.0-957.21.3.rt56.935.el7"
    "3.10.0-957.27.2.rt56.940.el7"
    "3.10.0-957.rt56.910.el7"
    "3.10.0-1062.1.1.rt56.1024.el7"
    "3.10.0-1062.1.2.rt56.1025.el7"
    "3.10.0-1062.4.1.rt56.1027.el7"
    "3.10.0-1062.4.2.rt56.1028.el7"
    "3.10.0-1062.4.3.rt56.1029.el7"
    "3.10.0-1062.7.1.rt56.1030.el7"
    "3.10.0-1062.9.1.rt56.1033.el7"
    "3.10.0-1062.12.1.rt56.1042.el7"
    "3.10.0-1062.18.1.rt56.1044.el7"
    "3.10.0-1062.rt56.1022.el7"
    "3.10.0-1127.8.2.rt56.1103.el7"
    "3.10.0-1127.10.1.rt56.1106.el7"
    "3.10.0-1127.13.1.rt56.1110.el7"
    "3.10.0-1127.18.2.rt56.1116.el7"
    "3.10.0-1127.19.1.rt56.1116.el7"
    "3.10.0-1127.rt56.1093.el7"
    "3.10.0-1136.rt56.1107.el7"
    "3.10.0-1160.2.1.rt56.1133.el7"
    "3.10.0-1160.rt56.1131.el7"
    "4.18.0-80.1.2.rt9.145.el8_0"
    "4.18.0-80.4.2.rt9.152.el8_0"
    "4.18.0-80.7.1.rt9.153.el8_0"
    "4.18.0-80.7.2.rt9.154.el8_0"
    "4.18.0-80.11.1.rt9.156.el8_0"
    "4.18.0-80.11.2.rt9.157.el8_0"
    "4.18.0-80.rt9.138.el8"
    "4.18.0-147.0.2.rt24.94.el8_1"
    "4.18.0-147.0.3.rt24.95.el8_1"
    "4.18.0-147.3.1.rt24.96.el8_1"
    "4.18.0-147.5.1.rt24.98.el8_1"
    "4.18.0-147.8.1.rt24.101.el8_1"
    "4.18.0-147.rt24.93.el8"
    "4.18.0-193.1.2.rt13.53.el8_2"
    "4.18.0-193.6.3.rt13.59.el8_2"
    "4.18.0-193.12.1.rt13.63.el8_2"
    "4.18.0-193.13.2.rt13.65.el8_2"
    "4.18.0-193.14.3.rt13.67.el8_2"
    "4.18.0-193.19.1.rt13.70.el8_2"
    "4.18.0-193.rt13.51.el8"
    "4.18.0-221.rt7.33.el8"
    "4.18.0-232.rt7.44.el8"
    "4.18.0-234.rt7.46.el8"
    "4.18.0-235.rt7.48.el8"
    "4.18.0-240.rt7.54.el8"
    "4.11.0-44.2.1.el7a"
    "4.11.0-44.4.1.el7a"
    "4.11.0-44.6.1.el7a"
    "4.11.0-44.7.1.el7a"
    "4.11.0-44.el7a"
    "4.14.0-49.2.2.el7a"
    "4.14.0-49.8.1.el7a"
    "4.14.0-49.10.1.el7a"
    "4.14.0-49.13.1.el7a"
    "4.14.0-49.el7a"
    "4.14.0-104.el7a"
    "4.14.0-115.2.2.el7a"
    "4.14.0-115.5.1.el7a"
    "4.14.0-115.6.1.el7a"
    "4.14.0-115.7.1.el7a"
    "4.14.0-115.8.1.el7a"
    "4.14.0-115.8.2.el7a"
    "4.14.0-115.10.1.el7a"
    "4.14.0-115.12.1.el7a"
    "4.14.0-115.13.1.el7a"
    "4.14.0-115.14.1.el7a"
    "4.14.0-115.16.1.el7a"
    "4.14.0-115.17.1.el7a"
    "4.14.0-115.18.1.el7a"
    "4.14.0-115.19.1.el7a"
    "4.14.0-115.21.2.el7a"
    "4.14.0-115.26.1.el7a"
    "4.14.0-115.29.1.el7a"
    "4.14.0-115.el7a"
)


VULNERABLE_KERNELS_CVE_2020_12352=(
    "${VULNERABLE_KERNELS_CVE_2020_12351[@]}"
    "3.10.0-229.1.2.ael7b"
    "3.10.0-229.4.2.ael7b"
    "3.10.0-229.7.2.ael7b"
    "3.10.0-229.11.1.ael7b"
    "3.10.0-229.14.1.ael7b"
    "3.10.0-229.20.1.ael7b"
    "3.10.0-229.24.2.ael7b"
    "3.10.0-229.26.2.ael7b"
    "3.10.0-229.28.1.ael7b"
    "3.10.0-229.30.1.ael7b"
    "3.10.0-229.34.1.ael7b"
    "3.10.0-229.38.1.ael7b"
    "3.10.0-229.40.1.ael7b"
    "3.10.0-229.42.1.ael7b"
    "3.10.0-229.42.2.ael7b"
    "3.10.0-229.44.1.ael7b"
    "3.10.0-229.46.1.ael7b"
    "3.10.0-229.48.1.ael7b"
    "3.10.0-229.49.1.ael7b"
    "3.10.0-229.ael7b"
    "3.10.0-54.0.1.el7"
    "3.10.0-121.el7"
    "3.10.0-123.1.2.el7"
    "3.10.0-123.4.2.el7"
    "3.10.0-123.4.4.el7"
    "3.10.0-123.6.3.el7"
    "3.10.0-123.8.1.el7"
    "3.10.0-123.9.2.el7"
    "3.10.0-123.9.3.el7"
    "3.10.0-123.13.1.el7"
    "3.10.0-123.13.2.el7"
    "3.10.0-123.20.1.el7"
    "3.10.0-123.el7"
    "3.10.0-229.1.2.el7"
    "3.10.0-229.4.2.el7"
    "3.10.0-229.7.2.el7"
    "3.10.0-229.11.1.el7"
    "3.10.0-229.14.1.el7"
    "3.10.0-229.20.1.el7"
    "3.10.0-229.24.2.el7"
    "3.10.0-229.26.2.el7"
    "3.10.0-229.28.1.el7"
    "3.10.0-229.30.1.el7"
    "3.10.0-229.34.1.el7"
    "3.10.0-229.38.1.el7"
    "3.10.0-229.40.1.el7"
    "3.10.0-229.42.1.el7"
    "3.10.0-229.42.2.el7"
    "3.10.0-229.44.1.el7"
    "3.10.0-229.46.1.el7"
    "3.10.0-229.48.1.el7"
    "3.10.0-229.49.1.el7"
    "3.10.0-229.el7"
    "3.10.0-327.3.1.el7"
    "3.10.0-327.4.4.el7"
    "3.10.0-327.4.5.el7"
    "3.10.0-327.10.1.el7"
    "3.10.0-327.13.1.el7"
    "3.10.0-327.18.2.el7"
    "3.10.0-327.22.2.el7"
    "3.10.0-327.28.2.el7"
    "3.10.0-327.28.3.el7"
    "3.10.0-327.36.1.el7"
    "3.10.0-327.36.2.el7"
    "3.10.0-327.36.3.el7"
    "3.10.0-327.41.3.el7"
    "3.10.0-327.41.4.el7"
    "3.10.0-327.44.2.el7"
    "3.10.0-327.46.1.el7"
    "3.10.0-327.49.2.el7"
    "3.10.0-327.53.1.el7"
    "3.10.0-327.55.1.el7"
    "3.10.0-327.55.2.el7"
    "3.10.0-327.55.3.el7"
    "3.10.0-327.58.1.el7"
    "3.10.0-327.59.1.el7"
    "3.10.0-327.59.2.el7"
    "3.10.0-327.59.3.el7"
    "3.10.0-327.61.3.el7"
    "3.10.0-327.62.1.el7"
    "3.10.0-327.62.4.el7"
    "3.10.0-327.64.1.el7"
    "3.10.0-327.66.1.el7"
    "3.10.0-327.66.3.el7"
    "3.10.0-327.66.5.el7"
    "3.10.0-327.70.1.el7"
    "3.10.0-327.71.1.el7"
    "3.10.0-327.71.4.el7"
    "3.10.0-327.73.1.el7"
    "3.10.0-327.76.1.el7"
    "3.10.0-327.77.1.el7"
    "3.10.0-327.78.2.el7"
    "3.10.0-327.79.2.el7"
    "3.10.0-327.80.1.el7"
    "3.10.0-327.82.1.el7"
    "3.10.0-327.82.2.el7"
    "3.10.0-327.83.1.el7"
    "3.10.0-327.84.1.el7"
    "3.10.0-327.85.1.el7"
    "3.10.0-327.86.1.el7"
    "3.10.0-327.88.1.el7"
    "3.10.0-327.89.1.el7"
    "3.10.0-327.90.2.el7"
    "3.10.0-327.92.1.el7"
    "3.10.0-327.el7"
    "3.10.0-514.2.2.el7"
    "3.10.0-514.6.1.el7"
    "3.10.0-514.6.2.el7"
    "3.10.0-514.10.2.el7"
    "3.10.0-514.16.1.el7"
    "3.10.0-514.16.2.p7ih.el7"
    "3.10.0-514.21.1.el7"
    "3.10.0-514.21.2.el7"
    "3.10.0-514.26.1.el7"
    "3.10.0-514.26.2.el7"
    "3.10.0-514.28.1.el7"
    "3.10.0-514.28.2.el7"
    "3.10.0-514.32.2.el7"
    "3.10.0-514.32.3.el7"
    "3.10.0-514.35.1.el7"
    "3.10.0-514.36.1.el7"
    "3.10.0-514.36.5.el7"
    "3.10.0-514.41.1.el7"
    "3.10.0-514.44.1.el7"
    "3.10.0-514.48.1.el7"
    "3.10.0-514.48.3.el7"
    "3.10.0-514.48.5.el7"
    "3.10.0-514.51.1.el7"
    "3.10.0-514.53.1.el7"
    "3.10.0-514.55.4.el7"
    "3.10.0-514.58.1.el7"
    "3.10.0-514.61.1.el7"
    "3.10.0-514.62.1.el7"
    "3.10.0-514.63.1.el7"
    "3.10.0-514.64.2.el7"
    "3.10.0-514.66.2.el7"
    "3.10.0-514.69.1.el7"
    "3.10.0-514.70.1.el7"
    "3.10.0-514.70.2.el7"
    "3.10.0-514.70.3.el7"
    "3.10.0-514.71.1.el7"
    "3.10.0-514.72.1.el7"
    "3.10.0-514.73.1.el7"
    "3.10.0-514.74.1.el7"
    "3.10.0-514.76.1.el7"
    "3.10.0-514.78.1.el7"
    "3.10.0-514.79.2.el7"
    "3.10.0-514.83.1.el7"
    "3.10.0-514.el7"
    "3.10.0-229.1.2.rt56.141.2.el7_1"
    "3.10.0-229.4.2.rt56.141.6.el7_1"
    "3.10.0-229.7.2.rt56.141.6.el7_1"
    "3.10.0-229.11.1.rt56.141.11.el7_1"
    "3.10.0-229.14.1.rt56.141.13.el7_1"
    "3.10.0-229.20.1.rt56.141.14.el7_1"
    "3.10.0-229.rt56.141.el7"
    "3.10.0-327.4.5.rt56.206.el7_2"
    "3.10.0-327.10.1.rt56.211.el7_2"
    "3.10.0-327.13.1.rt56.216.el7_2"
    "3.10.0-327.18.2.rt56.223.el7_2"
    "3.10.0-327.22.2.rt56.230.el7_2"
    "3.10.0-327.28.2.rt56.234.el7_2"
    "3.10.0-327.28.3.rt56.235.el7"
    "3.10.0-327.36.1.rt56.237.el7"
    "3.10.0-327.36.3.rt56.238.el7"
    "3.10.0-327.rt56.204.el7"
    "3.10.0-514.2.2.rt56.424.el7"
    "3.10.0-514.6.1.rt56.429.el7"
    "3.10.0-514.6.1.rt56.430.el7"
    "3.10.0-514.10.2.rt56.435.el7"
    "3.10.0-514.16.1.rt56.437.el7"
    "3.10.0-514.21.1.rt56.438.el7"
    "3.10.0-514.26.1.rt56.442.el7"
    "3.10.0-514.rt56.420.el7"
)


VULNERABLE_KERNEL_MODULE_NAMES=(
    'bnep'
    'bluetooth'
    'btusb'
)


basic_args() {
    # Parses basic commandline arguments and sets basic environment.
    #
    # Args:
    #     parameters - an array of commandline arguments
    #
    # Side effects:
    #     Exits if --help parameters is used
    #     Sets COLOR constants and debug variable

    local parameters=( "$@" )

    RED="\\033[1;31m"
    YELLOW="\\033[1;33m"
    GREEN="\\033[1;32m"
    BOLD="\\033[1m"
    RESET="\\033[0m"
    for parameter in "${parameters[@]}"; do
        if [[ "$parameter" == "-h" || "$parameter" == "--help" ]]; then
            echo "Usage: $( basename "$0" ) [-n | --no-colors] [-d | --debug]"
            exit 1
        elif [[ "$parameter" == "-n" || "$parameter" == "--no-colors" ]]; then
            RED=""
            YELLOW=""
            GREEN=""
            BOLD=""
            RESET=""
        elif [[ "$parameter" == "-d" || "$parameter" == "--debug" ]]; then
            debug=true
        fi
    done
}


basic_reqs() {
    # Prints common disclaimer and checks basic requirements.
    #
    # Args:
    #     CVE - string printed in the disclaimer
    #
    # Side effects:
    #     Exits when 'rpm' command is not available

    local CVE="$1"

    # Disclaimer
    echo
    echo -e "${BOLD}This script (v$VERSION) is primarily designed to detect $CVE on supported"
    echo -e "Red Hat Enterprise Linux systems and kernel packages."
    echo -e "Result may be inaccurate for other RPM based systems.${RESET}"
    echo

    # RPM is required
    if ! command -v rpm &> /dev/null; then
        echo "'rpm' command is required, but not installed. Exiting."
        exit 1
    fi
}


check_supported_kernel() {
    # Checks if running kernel is supported.
    #
    # Args:
    #     running_kernel - kernel string as returned by 'uname -r'
    #
    # Side effects:
    #     Exits when running kernel is obviously not supported

    local running_kernel="$1"

    # Check supported platform
    if [[ "$running_kernel" != *".el"[5-8]* ]]; then
        echo -e "${RED}This script is meant to be used only on RHEL 5-8.${RESET}"
        exit 1
    fi
}


get_rhel() {
    # Gets RHEL number.
    #
    # Args:
    #     running_kernel - kernel string as returned by 'uname -r'
    #
    # Prints:
    #     RHEL number, e.g. '5', '6', '7', or '8'

    local running_kernel="$1"

    local rhel
    rhel=$( sed -r -n 's/^.*el([[:digit:]]).*$/\1/p' <<< "$running_kernel" )
    echo "$rhel"
}


check_kernel() {
    # Checks kernel if it is in list of vulnerable kernels.
    #
    # Args:
    #     running_kernel - kernel string as returned by 'uname -r'
    #     vulnerable_versions - an array of vulnerable versions
    #
    # Prints:
    #     Vulnerable kernel string as returned by 'uname -r', or nothing

    local running_kernel="$1"
    shift
    local vulnerable_versions=( "$@" )

    for tested_kernel in "${vulnerable_versions[@]}"; do
        if [[ "$running_kernel" == *"$tested_kernel"* ]]; then
            echo "$running_kernel"
            break
        fi
    done
}


check_kernel_modules() {
    # Checks if modules listed in a list are loaded.
    #
    # Args:
    #     kernel_module_names - an array of kernel module names
    #
    # Prints:
    #     Found kernel module names as one string, or an empty string

    local kernel_module_names=( "$@" )
    local modules
    local matching_modules=()

    # Get loaded kernel modules
    modules=$( lsmod )

    for tested_module in "${kernel_module_names[@]}"; do
        if [[ "$modules" == *"$tested_module"* ]]; then
            matching_modules+=( "$tested_module" )
        fi
    done

    echo "${matching_modules[*]}"
}


check_all_modules_blocklisted() {
    # Checks if all specified kernel modules are blocklisted.
    #
    # Args:
    #     module_names - an array of kernel modules to be checked
    #
    # Returns:
    #     0 if all modules were blocklisted, 1 otherwise
    #
    # Notes:
    #     MOCK_MODPROBE_PATH can be used to mock /etc/modprobe.d directory

    local modprobe_dir=${MOCK_MODPROBE_PATH:-/etc/modprobe.d}

    local module_names=( "$@" )
    local mitigation_patterns=()
    local current_pattern_found

    # Prepare regular expressions
    for module_name in "${module_names[@]}"; do
        mitigation_patterns+=( "^[[:space:]]*install[[:space:]]+${module_name}[[:space:]]+/bin/(true|false)" )
    done

    # Check if all patterns are found at least once
    for pattern in "${mitigation_patterns[@]}"; do
        current_pattern_found=0
        # Check recommended mitigation
        for file in "$modprobe_dir/"*; do
            if grep -E --quiet "$pattern" "$file"; then
                current_pattern_found=1
                break
            fi
        done
        if (( ! current_pattern_found )); then
            return 1  # No need to search for the rest of the patterns, already have the answer
        fi
    done

    return 0
}


set_default_values() {
    result=2
    vulnerable=0
    vulnerable_51=0
    mitigation_blocklisting=0
    modules_not_loaded=0
}


parse_facts() {
    # Gathers all available information and stores it in global variables. Only store facts and
    # do not draw conclusion in this function for better maintainability.
    #
    # Side effects:
    #     Sets many global boolean flags and content variables

    vulnerable_kernel_51=$( check_kernel "$running_kernel" "${VULNERABLE_KERNELS_CVE_2020_12351[@]}" )
    vulnerable_kernel_52=$( check_kernel "$running_kernel" "${VULNERABLE_KERNELS_CVE_2020_12352[@]}" )
    vulnerable_loaded_kernel_modules=$( check_kernel_modules "${VULNERABLE_KERNEL_MODULE_NAMES[@]}" )

    check_all_modules_blocklisted "${VULNERABLE_KERNEL_MODULE_NAMES[@]}"
    # Store result as a flag, 1 as True, 0 as False
    # shellcheck disable=SC2181
    all_vulnerable_modules_loading_disabled=$(( !$? ))
}


draw_conclusions() {
    # Draws conclusions based on available system data.
    #
    # Side effects:
    #     Sets many global boolean flags and content variables

    if [[ "$vulnerable_kernel_52" ]]; then
        vulnerable=1
        result=2
    fi
    if [[ "$vulnerable_kernel_51" ]]; then
        vulnerable=1
        vulnerable_51=1
        result=4
    fi

    if [[ ! "$vulnerable_loaded_kernel_modules" && "$all_vulnerable_modules_loading_disabled" == 1 ]]; then
        mitigation_blocklisting=1
    fi

    if [[ ! "$vulnerable_loaded_kernel_modules" ]]; then
        modules_not_loaded=1
    fi

    if (( ! vulnerable || mitigation_blocklisting || modules_not_loaded )); then
        result=0
    fi
}


debug_print() {
    # Prints selected variables when debugging is enabled.

    variables=( running_kernel rhel result vulnerable mitigation_blocklisting
        vulnerable_kernel_51 vulnerable_kernel_52 vulnerable_loaded_kernel_modules
        all_vulnerable_modules_loading_disabled modules_not_loaded
        vulnerable_51 )
    for variable in "${variables[@]}"; do
        echo "$variable = *${!variable}*"
    done
    echo
}


if [[ "${BASH_SOURCE[0]}" == "$0" ]]; then
    basic_args "$@"
    basic_reqs "CVE-2020-12351 and CVE-2020-12352"
    running_kernel=$( uname -r )
    check_supported_kernel "$running_kernel"

    rhel=$( get_rhel "$running_kernel" )
    if (( rhel == 5 )); then
        export PATH="/sbin:/usr/sbin:$PATH"
    fi

    set_default_values
    parse_facts
    draw_conclusions

    # Debug prints
    if [[ "$debug" ]]; then
        debug_print
    fi

    # Results
    echo -e "This system is running kernel ${BOLD}${running_kernel}${RESET}"
    echo

    cve_string_51="CVE-2020-12351: ${YELLOW}Not vulnerable${RESET}"
    cve_string_52="CVE-2020-12352: ${RED}Vulnerable${RESET}"
    if (( vulnerable_51 )); then
        cve_string_51="CVE-2020-12351: ${RED}Vulnerable${RESET}"
    fi

    if (( vulnerable )); then
        if (( mitigation_blocklisting )); then
            echo -e "${YELLOW}This kernel version is vulnerable.${RESET}"
            echo -e "${GREEN}You have the proper mitigation installed${RESET}"
            echo -e "and the vulnerability is not exploitable."
            echo -e "${cve_string_51}"
            echo -e "${cve_string_52}"
        elif (( modules_not_loaded )); then
            echo -e "${YELLOW}This kernel version is vulnerable.${RESET}"
            echo -e "${GREEN}Vulnerable kernel modules are not loaded${RESET} and"
            echo -e "the vulnerability is currently not exploitable."
            echo -e "However, loading of vulnerable kernel modules is not disabled"
            echo -e "and ${YELLOW}the system can become vulnerable${RESET} at any moment."
            echo -e "${cve_string_51}"
            echo -e "${cve_string_52}"
        else
            echo -e "${RED}This kernel version is vulnerable.${RESET}"
            echo -e "${cve_string_51}"
            echo -e "${cve_string_52}"
        fi
    else
        echo -e "${GREEN}This kernel version is not affected.${RESET}"
    fi
    echo
    echo -e "For more information about this vulnerability, see:"
    echo -e "${ARTICLE}"

    exit "$result"
fi
