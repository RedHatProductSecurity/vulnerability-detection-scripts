#!/usr/bin/env bats

. test_harness


VULNERABLE_BT=(
    'bnep'
    'bluetooth'
    'btusb'
)

VULNERABLE_VHOST=( 'vhost_net' )


@test "check_all_modules_blocklisted -- blocklisted one module #1" {
    export MOCK_MODPROBE_PATH='file_mocks/modprobe_blocklisted_1'

    run check_all_modules_blocklisted "${VULNERABLE_VHOST[@]}"
    (( status == 0 ))
}


@test "check_all_modules_blocklisted -- blocklisted one module #2" {
    export MOCK_MODPROBE_PATH='file_mocks/modprobe_blocklisted_2'

    run check_all_modules_blocklisted "${VULNERABLE_VHOST[@]}"
    (( status == 0 ))
}


@test "check_all_modules_blocklisted -- not blocklisted one module #1" {
    export MOCK_MODPROBE_PATH='file_mocks/modprobe_not_blocklisted_1'

    run check_all_modules_blocklisted "${VULNERABLE_VHOST[@]}"
    (( status == 1 ))
}


@test "check_all_modules_blocklisted -- not blocklisted one module #2" {
    export MOCK_MODPROBE_PATH='file_mocks/modprobe_not_blocklisted_2'

    run check_all_modules_blocklisted "${VULNERABLE_VHOST[@]}"
    (( status == 1 ))
}


@test "check_all_modules_blocklisted -- not blocklisted multiple modules" {
    export MOCK_MODPROBE_PATH='file_mocks/modprobe_multiple_not_blocklisted'

    run check_all_modules_blocklisted "${VULNERABLE_BT[@]}"
    (( status == 1 ))
}


@test "check_all_modules_blocklisted -- partially blocklisted multiple modules" {
    export MOCK_MODPROBE_PATH='file_mocks/modprobe_multiple_partially_blocklisted'

    run check_all_modules_blocklisted "${VULNERABLE_BT[@]}"
    (( status == 1 ))
}


@test "check_all_modules_blocklisted -- blocklisted multiple modules" {
    export MOCK_MODPROBE_PATH='file_mocks/modprobe_multiple_blocklisted'

    run check_all_modules_blocklisted "${VULNERABLE_BT[@]}"
    (( status == 0 ))
}
