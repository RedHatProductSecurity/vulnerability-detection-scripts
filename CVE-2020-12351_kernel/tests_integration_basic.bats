#!/usr/bin/env bats

export RHEL7_OLD="3.10.0-520.10.2.el7.x86_64"  # same effect as new fixed version
export RHEL7_VULN="3.10.0-693.2.1.el7.x86_64"
export FEDORA="4.9.14-200.fc25.x86_64"
export SCRIPT_NAME=$( grep -E '^\. .*\.sh$' test_harness | sed -r 's/^\. (.*)$/\1/g' )

@test "Integration -- Fedora" {
    uname() {
        echo "$FEDORA"
    }
    lsmod() {
        echo ""
    }
    rpm() {
        :
    }
    export -f uname
    export -f lsmod
    export -f rpm

    run ./"${SCRIPT_NAME}"
    (( status == 1 ))
}


@test "Integration -- RHEL7, old non-vulnerable kernel" {
    uname() {
        echo "$RHEL7_OLD"
    }
    lsmod() {
        cat << EOF
Module                     Size  Used by
ip6t_rpfilter              16384  1
ip6t_REJECT                16384  2
btusb                      16384  2
bnep                       16384  2
bluetooth                  16384  2
EOF
    }
    rpm() {
        :
    }
    export -f uname
    export -f lsmod
    export -f rpm

    run ./"${SCRIPT_NAME}"
    (( status == 0 ))
    [[ "$output" =~ "This kernel version is not affected" ]]
    [[ "$output" != *"The bluetooth kernel modules are blocklisted"* ]]
}

@test "Integration -- RHEL7, vulnerable kernel" {
    uname() {
        echo "$RHEL7_VULN"
    }
    lsmod() {
        cat << EOF
Module                     Size  Used by
ip6t_rpfilter              16384  1
ip6t_REJECT                16384  2
btusb                      16384  2
bnep                       16384  2
bluetooth                  16384  2
EOF
    }
    rpm() {
        :
    }
    export -f uname
    export -f lsmod
    export -f rpm

    export MOCK_MODPROBE_PATH=file_mocks/modprobe_not_blocklisted_1

    run ./"${SCRIPT_NAME}"
    (( status == 6 ))
    [[ "$output" =~ "This kernel version is vulnerable." ]]
    [[ "$output" != *"The bluetooth kernel modules are blocklisted"* ]]
}

@test "Integration -- RHEL7, vulnerable kernel, mitigation" {
    uname() {
        echo "$RHEL7_VULN"
    }
    lsmod() {
        cat << EOF
Module                     Size  Used by
ip6t_rpfilter              16384  1
ip6t_REJECT                16384  2
EOF
    }
    rpm() {
        :
    }
    export -f uname
    export -f lsmod
    export -f rpm

    export MOCK_MODPROBE_PATH=file_mocks/modprobe_multiple_blocklisted

    run ./"${SCRIPT_NAME}"
    (( status == 0 ))
    [[ "$output" =~ "This kernel version is vulnerable." ]]
    [[ "$output" =~ "You have the proper mitigation installed" ]]
}

@test "Integration -- RHEL7, vulnerable kernel, partial mitigation" {
    uname() {
        echo "$RHEL7_VULN"
    }
    lsmod() {
        cat << EOF
Module                     Size  Used by
ip6t_rpfilter              16384  1
ip6t_REJECT                16384  2
EOF
    }
    rpm() {
        :
    }
    export -f uname
    export -f lsmod
    export -f rpm

    export MOCK_MODPROBE_PATH=file_mocks/modprobe_not_blocklisted_1

    run ./"${SCRIPT_NAME}"
    (( status == 0 ))
    [[ "$output" =~ "This kernel version is vulnerable." ]]
    [[ "$output" =~ "However, loading of vulnerable kernel modules is not disabled" ]]
}
