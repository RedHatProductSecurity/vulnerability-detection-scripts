#!/usr/bin/env bats

export RHEL6_VULN="2.6.32-754.35.1.el6.x86_64"
export RHEL6_FIXED="2.6.99-999.99.9.el6.x86_64"
export RHEL7_FIXED="3.10.0-999.99.9.el7.x86_64"
export RHEL7_VULN="3.10.0-1160.31.1.el7.x86_64"
export RHEL8_VULN="4.18.0-305.3.1.el8_4.x86_64"
export RHEL8_FIXED="4.99.9-999.9.9.el8_4.x86_64"
export RHEL7_SYSTEMD="systemd-219-78.el7_9.3.x86_64"
export RHEL8_SYSTEMD_VULN="systemd-239-45.el8.x86_64"
export RHEL8_SYSTEMD_FIXED="systemd-239-99.el8.x86_64"
export FEDORA="4.9.14-200.fc25.x86_64"
export SCRIPT_NAME=$( grep -E '^\. .*\.sh$' test_harness | sed -r 's/^\. (.*)$/\1/g' )


@test "Integration -- Fedora" {
    uname() {
        echo "$FEDORA"
    }
    export -f uname

    run ./"${SCRIPT_NAME}"
    (( status == 1 ))
}


@test "Integration - RHEL6 (Vulnerable)" {
    uname() {
        echo "$RHEL6_VULN"
    }

    rpm() {
        echo "initscripts-9.03.61-1.el6.x86_64"
    }
    lsmod() {
        echo "joydev                 24576  0"
    }

    export -f uname
    export -f rpm
    export -f lsmod
    run ./"${SCRIPT_NAME}"
    (( status == 2 ))
    [[ "$output" == *"This system is vulnerable to CVE-2021-33909"* ]]
    [[ "$output" == *"This system is not vulnerable to CVE-2021-33910"* ]]
}


@test "Integration - RHEL6 (Fixed)" {
    uname() {
        echo "$RHEL6_FIXED"
    }

    rpm() {
        echo "initscripts-9.03.61-1.el6.x86_64"
    }

    lsmod() {
        echo "joydev                 24576  0"
    }


    export -f uname
    export -f rpm
    export -f lsmod

    run ./"${SCRIPT_NAME}"
    (( status == 0 ))
    [[ "$output" != *"This system is vulnerable to"* ]]
    [[ "$output" == *"This system is not vulnerable"* ]]
}


@test "Integration - RHEL7 (not vulnerable)" {
    uname() {
        echo "$RHEL7_FIXED"
    }

    rpm() {
        echo "$RHEL7_SYSTEMD"
    }

    lsmod() {
        echo "joydev                 24576  0"
    }


    export -f uname
    export -f rpm
    export -f lsmod

    run ./"${SCRIPT_NAME}" -n
    (( status == 0 ))
    [[ "$output" != *"This system is vulnerable to"* ]]
    [[ "$output" == *"This system is not vulnerable"* ]]
}

@test "Integration - RHEL7 (Vulnerable)" {
    uname() {
        echo "$RHEL7_VULN"
    }

    rpm() {
        echo "$RHEL7_SYSTEMD"
    }

    lsmod() {
        echo "joydev                 24576  0"
    }

    export -f uname
    export -f rpm
    export -f lsmod

    run ./"${SCRIPT_NAME}" -n
    (( status == 2 ))
    [[ "$output" == *"This system is vulnerable to CVE-2021-33909"* ]]
    [[ "$output" == *"This system is not vulnerable to CVE-2021-33910"* ]]
}


@test "Integration - RHEL7 (Kpatched)" {
    uname() {
        echo "$RHEL7_VULN"
    }

    rpm() {
        echo "$RHEL7_SYSTEMD"
    }

    lsmod() {
        echo "kpatch_3_10_0_1062_30_1_1_4                 24576  0"
    }

    export -f uname
    export -f rpm
    export -f lsmod

    run ./"${SCRIPT_NAME}" -n
    (( status == 0 ))
    [[ "$output" != *"This system is vulnerable to"* ]]
    [[ "$output" == *"This system is not vulnerable"* ]]
}


@test "Integration - RHEL8 (Both vulnerable)" {
    uname() {
        echo "$RHEL8_VULN"
    }

    rpm() {
        echo "$RHEL8_SYSTEMD_VULN"
    }

    lsmod() {
        echo "joydev                 24576  0"
    }

    export -f uname
    export -f rpm
    export -f lsmod

    run ./"${SCRIPT_NAME}" -n
    (( status == 6 ))
    [[ "$output" == *"This system is vulnerable to CVE-2021-33909"* ]]
    [[ "$output" == *"This system is vulnerable to CVE-2021-33910"* ]]
}


@test "Integration - RHEL8 (Only systemd vulnerable)" {
    uname() {
        echo "$RHEL8_FIXED"
    }

    rpm() {
        echo "$RHEL8_SYSTEMD_VULN"
    }

    lsmod() {
        echo "joydev                 24576  0"
    }

    export -f uname
    export -f rpm
    export -f lsmod

    run ./"${SCRIPT_NAME}" -n
    (( status == 4 ))
    [[ "$output" == *"This system is not vulnerable to CVE-2021-33909"* ]]
    [[ "$output" == *"This system is vulnerable to CVE-2021-33910"* ]]
}


@test "Integration - RHEL8 (Only kernel vulnerable)" {
    uname() {
        echo "$RHEL8_VULN"
    }

    rpm() {
        echo "$RHEL8_SYSTEMD_FIXED"
    }

    lsmod() {
        echo "joydev                 24576  0"
    }

    export -f uname
    export -f rpm
    export -f lsmod

    run ./"${SCRIPT_NAME}" -n
    (( status == 2 ))
    [[ "$output" == *"This system is vulnerable to CVE-2021-33909"* ]]
    [[ "$output" == *"This system is not vulnerable to CVE-2021-33910"* ]]
}


@test "Integration - RHEL8 (Kpatch, vulnerable systemd)" {
    uname() {
        echo "kernel-4.18.0-193.56.1.el8_2"
    }

    rpm() {
        echo "$RHEL8_SYSTEMD_VULN"
    }

    lsmod() {
        echo "kpatch_4_18_0_193_56_1_1_1                 24576  0"
    }

    export -f uname
    export -f rpm
    export -f lsmod

    run ./"${SCRIPT_NAME}" -n
    (( status == 4 ))
    [[ "$output" == *"This system is not vulnerable to CVE-2021-33909"* ]]
    [[ "$output" == *"This system is vulnerable to CVE-2021-33910"* ]]
}


@test "Integration - RHEL8 (All fixed)" {
    uname() {
        echo "$RHEL8_FIXED"
    }

    rpm() {
        echo "$RHEL8_SYSTEMD_FIXED"
    }

    lsmod() {
        echo "joydev                 24576  0"
    }

    export -f uname
    export -f rpm
    export -f lsmod

    run ./"${SCRIPT_NAME}" -n
    (( status == 0 ))
    [[ "$output" != *"This system is vulnerable to"* ]]
    [[ "$output" == *"This system is not vulnerable"* ]]
}
