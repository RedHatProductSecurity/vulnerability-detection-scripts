#!/usr/bin/env bats

export RHEL6_VULNERABLE="2.6.32-71.7.1.el6.x86_64"
export RHEL6_SAFE="2.6.32-700.el6.x86_64"
export RHEL7_VULNERABLE="3.10.0-123.el7.x86_64"
export RHEL7_SAFE="3.10.0-520.10.2.el7.x86_64"
export FEDORA="4.9.14-200.fc25.x86_64"


@test "Integration -- Fedora" {
    uname() {
        echo "$FEDORA"
    }
    export -f uname
    
    run ./CVE-2017-7184.sh
    (( status == 1 ))
}


@test "Integration -- RHEL7 vulnerable, but not exploitable" {
    uname() {
        echo "$RHEL7_VULNERABLE"
    }
    export -f uname
    export MOCK_CMDLINE_PATH=file_mocks/cmdline_disabled
    
    run ./CVE-2017-7184.sh
    (( status == 2 ))
}


@test "Integration -- RHEL7 vulnerable and exploitable" {
    uname() {
        echo "$RHEL7_VULNERABLE"
    }
    export -f uname
    export MOCK_CMDLINE_PATH=file_mocks/cmdline_enabled
    
    run ./CVE-2017-7184.sh
    (( status == 3 ))
}

@test "Integration -- RHEL7 vulnerable and exploitable" {
    uname() {
        echo "$RHEL7_VULNERABLE"
    }
    export -f uname
    export MOCK_CMDLINE_PATH=file_mocks/cmdline_enabled
    
    run ./CVE-2017-7184.sh
    (( status == 3 ))
}
