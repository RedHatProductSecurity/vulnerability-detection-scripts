#!/usr/bin/env bats

export RHEL7="3.10.0-520.10.2.el7.x86_64"
export FEDORA="4.9.14-200.fc25.x86_64"
export SCRIPT_NAME=$( grep -E '^\. .*\.sh$' test_harness | sed -r 's/^\. (.*)$/\1/g' )


@test "Integration -- Fedora" {
    uname() {
        echo "$FEDORA"
    }
    export -f uname

    run ./"${SCRIPT_NAME}"
    (( status == 1 ))
}


@test "Integration -- RHEL7, vulnerable, not disabled, affected" {
    uname() {
        echo "$RHEL7"
    }
    export -f uname
    export MOCK_VULNS_PATH=file_mocks/vulns/vulnerable
    export MOCK_CMDLINE_PATH=file_mocks/cmdline/none
    export MOCK_CPU_INFO_PATH=file_mocks/cpuinfo/all_affected
    export MOCK_EUID=0

    run ./"${SCRIPT_NAME}"
    (( status == 2 ))
}


@test "Integration -- RHEL7, old kernel, not disabled, notaffected" {
    uname() {
        echo "$RHEL7"
    }
    export -f uname
    export MOCK_VULNS_PATH=file_mocks/vulns/foobar
    export MOCK_CMDLINE_PATH=file_mocks/cmdline/none
    export MOCK_CPU_INFO_PATH=file_mocks/cpuinfo/all_not_affected
    export MOCK_EUID=0

    run ./"${SCRIPT_NAME}"
    (( status == 0 ))
    [[ "$output" == *"not affected"* ]]
}


@test "Integration -- RHEL7, new kernel, not disabled, affected" {
    uname() {
        echo "$RHEL7"
    }
    export -f uname
    export MOCK_VULNS_PATH=file_mocks/vulns/vulnerable
    export MOCK_CMDLINE_PATH=file_mocks/cmdline/none
    export MOCK_CPU_INFO_PATH=file_mocks/cpuinfo/all_affected
    export MOCK_EUID=0

    run ./"${SCRIPT_NAME}"
    (( status == 2 ))
    [[ "$output" == *"CPU microcode is not updated"* ]]
}


@test "Integration -- RHEL7, mitigated, not disabled, affected" {
    uname() {
        echo "$RHEL7"
    }
    export -f uname
    export MOCK_VULNS_PATH=file_mocks/vulns/mitigation
    export MOCK_CMDLINE_PATH=file_mocks/cmdline/none
    export MOCK_CPU_INFO_PATH=file_mocks/cpuinfo/all_affected
    export MOCK_EUID=0

    run ./"${SCRIPT_NAME}"
    (( status == 0 ))
    [[ "$output" == *"correct mitigation applied"* ]]
}


@test "Integration -- RHEL7, mitigated, but disabled, affected" {
    uname() {
        echo "$RHEL7"
    }
    export -f uname
    export MOCK_VULNS_PATH=file_mocks/vulns/vulnerable
    export MOCK_CMDLINE_PATH=file_mocks/cmdline/nospec_store_bypass_disable
    export MOCK_CPU_INFO_PATH=file_mocks/cpuinfo/all_affected
    export MOCK_EUID=0

    run ./"${SCRIPT_NAME}"
    (( status == 2 ))
    [[ "$output" == *"Mitigation is disabled"* ]]
}
