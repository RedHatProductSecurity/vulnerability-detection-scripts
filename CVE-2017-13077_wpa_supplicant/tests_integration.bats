#!/usr/bin/env bats


export SCRIPT_NAME=$( grep -E '^\. .*\.sh$' test_harness | sed -r 's/^\. (.*)$/\1/g' )

export RHEL7_VULNERABLE="wpa_supplicant-2.6-5.el7.x86_64"
export RHEL7_SAFE="wpa_supplicant-2.6-5.el7_4.1.x86_64"
export RHEL7_KERNEL="3.10.0-520.10.2.el7.x86_64"

@test "Integration -- RHEL7 not installed" {
    rpm() {
        echo ""
    }
    uname() {
        echo "$RHEL7_KERNEL"
    }
    export -f rpm
    export -f uname
    export MOCK_SYS_CLASS_NET_PATH=file_mocks/net1

    run ./"${SCRIPT_NAME}"
    (( status == 0 ))
    [[ "$output" == *"not installed"* ]]
}

@test "Integration -- RHEL7 not vulnerable" {
    rpm() {
        echo "$RHEL7_SAFE"
    }
    uname() {
        echo "$RHEL7_KERNEL"
    }
    export -f rpm
    export -f uname
    export MOCK_SYS_CLASS_NET_PATH=file_mocks/net1
    
    run ./"${SCRIPT_NAME}"
    (( status == 0 ))
    [[ "$output" == *"not vulnerable"* ]]
}


@test "Integration -- RHEL7 vulnerable, but not exploitable" {
    rpm() {
        echo "$RHEL7_VULNERABLE"
    }
    uname() {
        echo "$RHEL7_KERNEL"
    }
    export -f rpm
    export -f uname
    export MOCK_SYS_CLASS_NET_PATH=file_mocks/net2
    
    run ./"${SCRIPT_NAME}"
    (( status == 0 ))
    [[ "$output" == *"not exploitable"* ]]
}


@test "Integration -- RHEL7 vulnerable, WiFi exists" {
    rpm() {
        echo "$RHEL7_VULNERABLE"
    }
    uname() {
        echo "$RHEL7_KERNEL"
    }
    export -f rpm
    export -f uname
    export MOCK_SYS_CLASS_NET_PATH=file_mocks/net3
    
    run ./"${SCRIPT_NAME}"
    (( status == 2 ))
    [[ "$output" == *"inactive WiFi"* ]]
}


@test "Integration -- RHEL7 vulnerable, WiFi active" {
    rpm() {
        echo "$RHEL7_VULNERABLE"
    }
    uname() {
        echo "$RHEL7_KERNEL"
    }
    export -f rpm
    export -f uname
    export MOCK_SYS_CLASS_NET_PATH=file_mocks/net1
    
    run ./"${SCRIPT_NAME}"
    (( status == 3 ))
    [[ "$output" == *" active WiFi"* ]]
}
