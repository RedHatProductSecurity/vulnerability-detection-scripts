#!/usr/bin/env bats

export RHEL7="3.10.0-520.10.2.el7.x86_64"
export FEDORA="4.9.14-200.fc25.x86_64"
export SCRIPT_NAME=$( grep -E '^\. .*\.sh$' test_harness | sed -r 's/^\. (.*)$/\1/g' )


@test "Integration -- Fedora" {
    uname() {
        echo "$FEDORA"
    }
    export -f uname

    run ./"${SCRIPT_NAME}"
    (( status == 1 ))
}


@test "Integration -- RHEL7, all vulnerable, SELinux good" {
    uname() {
        echo "$RHEL7"
    }
    rpm() {
        if [[ "$3" == "runc" ]]; then
            echo "runc-0.1.1-5.el7.x86_64"
        fi
        if [[ "$3" == "docker" ]]; then
            echo "docker-1.12.5-14.el7.x86_64"
        fi
        if [[ "$3" == "docker-latest" ]]; then
            echo "docker-latest-1.12.1-2.el7.x86_64"
        fi
    }
    getenforce() {
        echo "Enforcing"
    }
    sestatus() {
        echo "Loaded policy name:             targeted"
    }
    export -f uname
    export -f rpm
    export -f getenforce
    export -f sestatus

    run ./"${SCRIPT_NAME}"
    (( status == 0 ))
    [[ "$output" == *"cannot be exploited"* ]]
}


@test "Integration -- RHEL7, all vulnerable, SELinux bad" {
    uname() {
        echo "$RHEL7"
    }
    rpm() {
        if [[ "$3" == "runc" ]]; then
            echo "runc-0.1.1-5.el7.x86_64"
        fi
        if [[ "$3" == "docker" ]]; then
            echo "docker-1.12.5-14.el7.x86_64"
        fi
        if [[ "$3" == "docker-latest" ]]; then
            echo "docker-latest-1.12.1-2.el7.x86_64"
        fi
    }
    getenforce() {
        echo "Permissive"
    }
    sestatus() {
        echo "Loaded policy name:             targeted"
    }
    export -f uname
    export -f rpm
    export -f getenforce
    export -f sestatus

    run ./"${SCRIPT_NAME}" -n
    (( status == 14 ))
    [[ "$output" == *"'runc' package is vulnerable"* ]]
    [[ "$output" == *"'docker' package is vulnerable"* ]]
    [[ "$output" == *"'docker-latest' package is vulnerable"* ]]
    [[ "$output" == *"SELinux in current state does NOT mitigate"* ]]
}


@test "Integration -- RHEL7, all vulnerable but docker, SELinux bad" {
    uname() {
        echo "$RHEL7"
    }
    rpm() {
        if [[ "$3" == "runc" ]]; then
            echo "runc-0.1.1-5.el7.x86_64"
        fi
        if [[ "$3" == "docker" ]]; then
            echo "docker-5.12.5-14.el7.x86_64"
        fi
        if [[ "$3" == "docker-latest" ]]; then
            echo "docker-latest-1.12.1-2.el7.x86_64"
        fi
    }
    getenforce() {
        echo "Permissive"
    }
    sestatus() {
        echo "Loaded policy name:             targeted"
    }
    export -f uname
    export -f rpm
    export -f getenforce
    export -f sestatus

    run ./"${SCRIPT_NAME}" -n
    (( status == 10 ))
    [[ "$output" == *"'runc' package is vulnerable"* ]]
    [[ "$output" != *"'docker' package is vulnerable"* ]]
    [[ "$output" == *"'docker-latest' package is vulnerable"* ]]
    [[ "$output" == *"SELinux in current state does NOT mitigate"* ]]
}


@test "Integration -- RHEL7, no vulnerable, SELinux bad" {
    uname() {
        echo "$RHEL7"
    }
    rpm() {
        if [[ "$3" == "runc" ]]; then
            echo "runc-5.1.1-5.el7.x86_64"
        fi
        if [[ "$3" == "docker" ]]; then
            echo "docker-5.12.5-14.el7.x86_64"
        fi
        if [[ "$3" == "docker-latest" ]]; then
            echo "docker-latest-5.12.1-2.el7.x86_64"
        fi
    }
    getenforce() {
        echo "Permissive"
    }
    sestatus() {
        echo "Loaded policy name:             targeted"
    }
    export -f uname
    export -f rpm
    export -f getenforce
    export -f sestatus

    run ./"${SCRIPT_NAME}" -n
    (( status == 0 ))
    [[ "$output" != *"'runc' package is vulnerable"* ]]
    [[ "$output" != *"'docker' package is vulnerable"* ]]
    [[ "$output" != *"'docker-latest' package is vulnerable"* ]]
    [[ "$output" != *"SELinux in current state does NOT mitigate"* ]]
    [[ "$output" == *"There are NO vulnerable packages"* ]]
}


@test "Integration -- RHEL7, no vulnerable, SELinux good" {
    uname() {
        echo "$RHEL7"
    }
    rpm() {
        if [[ "$3" == "runc" ]]; then
            echo "runc-5.1.1-5.el7.x86_64"
        fi
        if [[ "$3" == "docker" ]]; then
            echo "docker-5.12.5-14.el7.x86_64"
        fi
        if [[ "$3" == "docker-latest" ]]; then
            echo "docker-latest-5.12.1-2.el7.x86_64"
        fi
    }
    getenforce() {
        echo "Enforcing"
    }
    sestatus() {
        echo "Loaded policy name:             targeted"
    }
    export -f uname
    export -f rpm
    export -f getenforce
    export -f sestatus

    run ./"${SCRIPT_NAME}" -n
    (( status == 0 ))
    [[ "$output" != *"'runc' package is vulnerable"* ]]
    [[ "$output" != *"'docker' package is vulnerable"* ]]
    [[ "$output" != *"'docker-latest' package is vulnerable"* ]]
    [[ "$output" != *"SELinux in current state does NOT mitigate"* ]]
    [[ "$output" == *"There are NO vulnerable packages"* ]]
    [[ "$output" != *"cannot be exploited"* ]]
}
