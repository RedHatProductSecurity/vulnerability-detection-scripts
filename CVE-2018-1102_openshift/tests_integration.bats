#!/usr/bin/env bats

export RHEL7="3.10.0-520.10.2.el7.x86_64"
export FEDORA="4.9.14-200.fc25.x86_64"
export SCRIPT_NAME=$( grep -E '^\. .*\.sh$' test_harness | sed -r 's/^\. (.*)$/\1/g' )


# Input data format:
#
# REPOSITORY                                                                 TAG                 IMAGE ID            CREATED             SIZE
# registry.access.redhat.com/rhel7/etcd                                      latest              4f35b6516d22        2 weeks ago         256 MB
# registry.reg-aws.openshift.com:443/openshift3/ose-deployer                 v3.9.14             ba9779c50c5b        4 weeks ago         1.258 GB
# registry.reg-aws.openshift.com:443/openshift3/ose-ansible-service-broker   v3.9.14             099623d2510d        4 weeks ago         545.4 MB
# registry.access.redhat.com/openshift3/ose-sti-builder                      v3.9.14             40b90df9fe14        13 days ago         1.26 GB
# registry.reg-aws.openshift.com:443/openshift3/ose-pod                      v3.9.14             e598d93f5abe        4 weeks ago         209.1 MB
# registry.reg-aws.openshift.com:443/openshift3/logging-fluentd              v3.9.14             58770b941e03        4 weeks ago         280.7 MB


@test "Integration -- Fedora" {
    uname() {
        echo "$FEDORA"
    }
    export -f uname

    docker() {
        echo "REPOSITORY                                                                 TAG                 IMAGE ID            CREATED             SIZE"
        echo "registry.access.redhat.com/rhel7/etcd                                      latest              4f35b6516d22        2 weeks ago         256 MB"
        echo "registry.reg-aws.openshift.com:443/openshift3/ose-deployer                 v3.9.14             ba9779c50c5b        4 weeks ago         1.258 GB"
        echo "registry.reg-aws.openshift.com:443/openshift3/ose-ansible-service-broker   v3.9.14             099623d2510d        4 weeks ago         545.4 MB"
        echo "registry.access.redhat.com/openshift3/ose-sti-builder                      v3.9.14             40b90df9fe14        13 days ago         1.26 GB"
        echo "registry.reg-aws.openshift.com:443/openshift3/ose-pod                      v3.9.14             e598d93f5abe        4 weeks ago         209.1 MB"
        echo "registry.reg-aws.openshift.com:443/openshift3/logging-fluentd              v3.9.14             58770b941e03        4 weeks ago         280.7 MB"
    }
    export -f docker

    run ./"${SCRIPT_NAME}"
    (( status == 1 ))
}


@test "Integration -- RHEL7" {
    uname() {
        echo "$RHEL7"
    }
    export -f uname

    docker() {
        echo "REPOSITORY                                                                 TAG                 IMAGE ID            CREATED             SIZE"
        echo "registry.access.redhat.com/rhel7/etcd                                      latest              4f35b6516d22        2 weeks ago         256 MB"
        echo "registry.reg-aws.openshift.com:443/openshift3/ose-deployer                 v9.9.14             ba9779c50c5b        4 weeks ago         1.258 GB"
        echo "registry.reg-aws.openshift.com:443/openshift3/ose-ansible-service-broker   v9.9.14             099623d2510d        4 weeks ago         545.4 MB"
        echo "registry.access.redhat.com/openshift3/ose-sti-builder                      v9.9.14             40b90df9fe14        13 days ago         1.26 GB"
        echo "registry.reg-aws.openshift.com:443/openshift3/ose-pod                      v9.9.14             e598d93f5abe        4 weeks ago         209.1 MB"
        echo "registry.reg-aws.openshift.com:443/openshift3/logging-fluentd              v9.9.14             58770b941e03        4 weeks ago         280.7 MB"
    }
    export -f docker

    run ./"${SCRIPT_NAME}"
    (( status == 0 ))
}


@test "Integration -- RHEL7 vulnerable 3.9.14" {
    uname() {
        echo "$RHEL7"
    }
    export -f uname

    docker() {
        echo "REPOSITORY                                                                 TAG                 IMAGE ID            CREATED             SIZE"
        echo "registry.access.redhat.com/rhel7/etcd                                      latest              4f35b6516d22        2 weeks ago         256 MB"
        echo "registry.reg-aws.openshift.com:443/openshift3/ose-deployer                 v3.9.14             ba9779c50c5b        4 weeks ago         1.258 GB"
        echo "registry.reg-aws.openshift.com:443/openshift3/ose-ansible-service-broker   v3.9.14             099623d2510d        4 weeks ago         545.4 MB"
        echo "registry.access.redhat.com/openshift3/ose-sti-builder                      v3.9.14             40b90df9fe14        13 days ago         1.26 GB"
        echo "registry.reg-aws.openshift.com:443/openshift3/ose-pod                      v3.9.14             e598d93f5abe        4 weeks ago         209.1 MB"
        echo "registry.reg-aws.openshift.com:443/openshift3/logging-fluentd              v3.9.14             58770b941e03        4 weeks ago         280.7 MB"
    }
    export -f docker

    run ./"${SCRIPT_NAME}"
    (( status == 2 ))
    grep -q "3.9.14 40b90df9fe14" <<< "$output"
}


@test "Integration -- RHEL7 vulnerable 3.3.1.46.39" {
    uname() {
        echo "$RHEL7"
    }
    export -f uname

    docker() {
        echo "REPOSITORY                                                                 TAG                 IMAGE ID            CREATED             SIZE"
        echo "registry.access.redhat.com/rhel7/etcd                                      latest              4f35b6516d22        2 weeks ago         256 MB"
        echo "registry.reg-aws.openshift.com:443/openshift3/ose-deployer                 v3.3.1.46.39        ba9779c50c5b        4 weeks ago         1.258 GB"
        echo "registry.reg-aws.openshift.com:443/openshift3/ose-ansible-service-broker   v3.3.1.46.39        099623d2510d        4 weeks ago         545.4 MB"
        echo "registry.access.redhat.com/openshift3/ose-sti-builder                      v3.3.1.46.39        cee523a4e55c        13 days ago         1.26 GB"
        echo "registry.reg-aws.openshift.com:443/openshift3/ose-pod                      v3.3.1.46.39        e598d93f5abe        4 weeks ago         209.1 MB"
        echo "registry.reg-aws.openshift.com:443/openshift3/logging-fluentd              v3.3.1.46.39        58770b941e03        4 weeks ago         280.7 MB"
    }
    export -f docker

    run ./"${SCRIPT_NAME}"
    (( status == 2 ))
    grep -q "3.3.1.46.39 cee523a4e55c" <<< "$output"
}


@test "Integration -- RHEL7 fixed 3.9.25" {
    uname() {
        echo "$RHEL7"
    }
    export -f uname

    docker() {
        echo "REPOSITORY                                                                 TAG                 IMAGE ID            CREATED             SIZE"
        echo "registry.access.redhat.com/rhel7/etcd                                      latest              4f35b6516d22        2 weeks ago         256 MB"
        echo "registry.reg-aws.openshift.com:443/openshift3/ose-deployer                 v3.9.25             ba9779c50c5b        4 weeks ago         1.258 GB"
        echo "registry.reg-aws.openshift.com:443/openshift3/ose-ansible-service-broker   v3.9.25             099623d2510d        4 weeks ago         545.4 MB"
        echo "registry.access.redhat.com/openshift3/ose-sti-builder                      v3.9.25             deadbeefbaaa        13 days ago         1.26 GB"
        echo "registry.reg-aws.openshift.com:443/openshift3/ose-pod                      v3.9.25             e598d93f5abe        4 weeks ago         209.1 MB"
        echo "registry.reg-aws.openshift.com:443/openshift3/logging-fluentd              v3.9.25             58770b941e03        4 weeks ago         280.7 MB"
    }
    export -f docker

    run ./"${SCRIPT_NAME}"
    (( status == 0 ))
}


@test "Integration -- RHEL7 fixed 3.3.1.46.39" {
    uname() {
        echo "$RHEL7"
    }
    export -f uname

    docker() {
        echo "REPOSITORY                                                                 TAG                 IMAGE ID            CREATED             SIZE"
        echo "registry.access.redhat.com/rhel7/etcd                                      latest              4f35b6516d22        2 weeks ago         256 MB"
        echo "registry.reg-aws.openshift.com:443/openshift3/ose-deployer                 v3.3.1.46.39        ba9779c50c5b        4 weeks ago         1.258 GB"
        echo "registry.reg-aws.openshift.com:443/openshift3/ose-ansible-service-broker   v3.3.1.46.39        099623d2510d        4 weeks ago         545.4 MB"
        echo "registry.access.redhat.com/openshift3/ose-sti-builder                      v3.3.1.46.39        deadbeefbaaa        13 days ago         1.26 GB"
        echo "registry.reg-aws.openshift.com:443/openshift3/ose-pod                      v3.3.1.46.39        e598d93f5abe        4 weeks ago         209.1 MB"
        echo "registry.reg-aws.openshift.com:443/openshift3/logging-fluentd              v3.3.1.46.39        58770b941e03        4 weeks ago         280.7 MB"
    }
    export -f docker

    run ./"${SCRIPT_NAME}"
    (( status == 0 ))
}


@test "Integration -- RHEL7 vulnerable 3.3.1.46.39 and 3.9.14" {
    uname() {
        echo "$RHEL7"
    }
    export -f uname

    docker() {
        echo "REPOSITORY                                                                 TAG                 IMAGE ID            CREATED             SIZE"
        echo "registry.access.redhat.com/rhel7/etcd                                      latest              4f35b6516d22        2 weeks ago         256 MB"
        echo "registry.reg-aws.openshift.com:443/openshift3/ose-deployer                 v3.3.1.46.39        ba9779c50c5b        4 weeks ago         1.258 GB"
        echo "registry.reg-aws.openshift.com:443/openshift3/ose-ansible-service-broker   v3.3.1.46.39        099623d2510d        4 weeks ago         545.4 MB"
        echo "registry.access.redhat.com/openshift3/ose-sti-builder                      v3.9.14             40b90df9fe14        13 days ago         1.26 GB"
        echo "registry.access.redhat.com/openshift3/ose-sti-builder                      v3.3.1.46.39        deadbeefbaaa        13 days ago         1.26 GB"
        echo "registry.access.redhat.com/openshift3/ose-sti-builder                      v3.3.1.46.39        cee523a4e55c        13 days ago         1.26 GB"
        echo "registry.reg-aws.openshift.com:443/openshift3/ose-pod                      v3.3.1.46.39        e598d93f5abe        4 weeks ago         209.1 MB"
        echo "registry.reg-aws.openshift.com:443/openshift3/logging-fluentd              v3.3.1.46.39        58770b941e03        4 weeks ago         280.7 MB"
    }
    export -f docker

    run ./"${SCRIPT_NAME}"
    (( status == 2 ))
    grep -q "3.3.1.46.39 cee523a4e55c" <<< "$output"
    grep -q "3.9.14 40b90df9fe14" <<< "$output"
}


@test "Integration -- RHEL7 substring test" {
    uname() {
        echo "$RHEL7"
    }
    export -f uname

    docker() {
        echo "REPOSITORY                                                                 TAG                 IMAGE ID            CREATED             SIZE"
        echo "registry.access.redhat.com/rhel7/etcd                                      latest              4f35b6516d22        2 weeks ago         256 MB"
        echo "registry.reg-aws.openshift.com:443/openshift3/ose-deployer                 v3.9.14             ba9779c50c5b        4 weeks ago         1.258 GB"
        echo "registry.reg-aws.openshift.com:443/openshift3/ose-ansible-service-broker   v3.9.14             099623d2510d        4 weeks ago         545.4 MB"
        echo "registry.access.redhat.com/openshift3/nose-sti-builder                     v3.9.14             40b90df9fe14        13 days ago         1.26 GB"
        echo "registry.reg-aws.openshift.com:443/openshift3/ose-pod                      v3.9.14             e598d93f5abe        4 weeks ago         209.1 MB"
        echo "registry.reg-aws.openshift.com:443/openshift3/logging-fluentd              v3.9.14             58770b941e03        4 weeks ago         280.7 MB"
    }
    export -f docker

    run ./"${SCRIPT_NAME}"
    (( status == 0 ))
}


@test "Integration -- RHEL7 inactive image test" {
    uname() {
        echo "$RHEL7"
    }
    export -f uname

    docker() {
        echo "REPOSITORY                                                                 TAG                 IMAGE ID            CREATED             SIZE"
        echo "registry.access.redhat.com/rhel7/etcd                                      latest              4f35b6516d22        2 weeks ago         256 MB"
        echo "registry.reg-aws.openshift.com:443/openshift3/ose-deployer                 v3.9.14             ba9779c50c5b        4 weeks ago         1.258 GB"
        echo "registry.reg-aws.openshift.com:443/openshift3/ose-ansible-service-broker   v3.9.14             099623d2510d        4 weeks ago         545.4 MB"
        echo "registry.access.redhat.com/openshift3/ose-sti-builder                      untagged            40b90df9fe14        13 days ago         1.26 GB"
        echo "registry.reg-aws.openshift.com:443/openshift3/ose-pod                      v3.9.14             e598d93f5abe        4 weeks ago         209.1 MB"
        echo "registry.reg-aws.openshift.com:443/openshift3/logging-fluentd              v3.9.14             58770b941e03        4 weeks ago         280.7 MB"
    }
    export -f docker

    run ./"${SCRIPT_NAME}"
    (( status == 0 ))
}



@test "Integration -- RHEL7 real images" {
    uname() {
        echo "$RHEL7"
    }
    export -f uname

    docker() {
        cat << EOF
REPOSITORY                                                      TAG                 IMAGE ID            CREATED             SIZE
registry.reg-aws.openshift.com:443/openshift3/ose-sti-builder   v3.9.24             f9ec23a30b12        13 days ago         1.23GB
registry.reg-aws.openshift.com:443/openshift3/ose-sti-builder   v3.8.37             7a0797bf211a        3 weeks ago         1.29GB
registry.reg-aws.openshift.com:443/openshift3/ose-sti-builder   v3.9.14             3fe8ae25f2a7        3 weeks ago         2.13GB
registry.reg-aws.openshift.com:443/openshift3/ose-sti-builder   v3.9.16             3fe8ae25f2a7        3 weeks ago         2.13GB
registry.reg-aws.openshift.com:443/openshift3/ose-sti-builder   v3.7.23             d2a127bda556        3 weeks ago         1.79GB
registry.reg-aws.openshift.com:443/openshift3/ose-sti-builder   v3.7.42             d2a127bda556        3 weeks ago         1.79GB
registry.reg-aws.openshift.com:443/openshift3/ose-sti-builder   <none>              0a9ac4b35935        4 weeks ago         1.26GB
dbaker-rh/trello                                                latest              dfb2c70a129c        3 months ago        311MB
oso-centos7-saml-sso                                            latest              ddcd90291df7        7 months ago        694MB
openshifttools/oso-centos7-saml-sso                             latest              ddcd90291df7        7 months ago        694MB
centos                                                          7                   36540f359ca3        10 months ago       193MB
centos                                                          centos7             36540f359ca3        10 months ago       193MB
centos                                                          latest              36540f359ca3        10 months ago       193MB
open.paas.redhat.com/dbaker-test/centos                         centos7             36540f359ca3        10 months ago       193MB
ruby                                                            2.2-alpine          efe0159fa452        10 months ago       117MB
openshifttools/oso-centos7-ops-base                             latest              06dd123f45e9        12 months ago       511MB
EOF
    }
    export -f docker

    run ./"${SCRIPT_NAME}"
    (( status == 2 ))

   [[ "$output" == *"3.9.24 f9ec23a30b12"* ]]
   [[ "$output" == *"3.9.14 3fe8ae25f2a7"* ]]
   [[ "$output" == *"3.9.16 3fe8ae25f2a7"* ]]
   [[ "$output" == *"3.7.23 d2a127bda556"* ]]
   [[ "$output" == *"3.7.42 d2a127bda556"* ]]
   [[ "$output" != *"3.8.37"* ]]
}



@test "Integration -- RHEL7 vulnerable 3.3.1.46.39 and 3.9.14 and some weird stuff" {
    uname() {
        echo "$RHEL7"
    }
    export -f uname

    docker() {
        echo "REPOSITORY                                                                 TAG                 IMAGE ID            CREATED             SIZE"
        echo "registry.access.redhat.com/rhel7/etcd                                      latest              4f35b6516d22        2 weeks ago         256 MB"
        echo "registry.reg-aws.openshift.com:443/openshift3/ose-deployer                 v3.3.1.46.39        ba9779c50c5b        4 weeks ago         1.258 GB"
        echo "registry.reg-aws.openshift.com:443/openshift3/ose-ansible-service-broker   v3.3.1.46.39        099623d2510d        4 weeks ago         545.4 MB"
        echo "registry.access.redhat.com/openshift3/ose-sti-builder                      v3.9.14             40b90df9fe14        13 days ago         1.26 GB"
        echo "registry.access.redhat.com/openshift3/ose-sti-builder                      v3.3.1.46.39        deadbeefbaaa        13 days ago         1.26 GB"
        echo "registry.access.redhat.com/openshift3/ose-sti-builder                      v3.3.1.46.39        cee523a4e55c        13 days ago         1.26 GB"
        echo "registry.access.redhat.com/openshift3/ose-sti-builder                      v3.3.1.46.39v       deadbeefbaaa        13 days ago         1.26 GB"
        echo "registry.access.redhat.com/openshift3/ose-sti-builder                      <none>              cee523a4e55c        13 days ago         1.26 GB"
        echo "registry.access.redhat.com/openshift3/ose-sti-builder                      none                cee523a4e55c        13 days ago         1.26 GB"
        echo "registry.access.redhat.com/openshift3/ose-sti-builder                                          cee523a4e55c        13 days ago         1.26 GB"
        echo "registry.reg-aws.openshift.com:443/openshift3/ose-pod                      v3.3.1.46.39        e598d93f5abe        4 weeks ago         209.1 MB"
        echo "registry.reg-aws.openshift.com:443/openshift3/logging-fluentd              v3.3.1.46.39        58770b941e03        4 weeks ago         280.7 MB"
    }
    export -f docker

    run ./"${SCRIPT_NAME}"
    (( status == 2 ))
    grep -q "3.3.1.46.39 cee523a4e55c" <<< "$output"
    grep -q "3.9.14 40b90df9fe14" <<< "$output"
}




@test "Integration -- RHEL7 no vulnerable and some weird stuff" {
    uname() {
        echo "$RHEL7"
    }
    export -f uname

    docker() {
        echo "REPOSITORY                                                                 TAG                 IMAGE ID            CREATED             SIZE"
        echo "registry.access.redhat.com/rhel7/etcd                                      latest              4f35b6516d22        2 weeks ago         256 MB"
        echo "registry.reg-aws.openshift.com:443/openshift3/ose-deployer                 v3.3.1.46.39        ba9779c50c5b        4 weeks ago         1.258 GB"
        echo "registry.reg-aws.openshift.com:443/openshift3/ose-ansible-service-broker   v3.3.1.46.39        099623d2510d        4 weeks ago         545.4 MB"
        echo "registry.access.redhat.com/openshift3/ose-sti-builder                      v3.9.550            40b90df9fe14        13 days ago         1.26 GB"
        echo "registry.access.redhat.com/openshift3/ose-sti-builder                      v3.3.1.46.39        deadbeefbaaa        13 days ago         1.26 GB"
        echo "registry.access.redhat.com/openshift3/ose-sti-builder                      v3.30.1.46.39       cee523a4e55c        13 days ago         1.26 GB"
        echo "registry.access.redhat.com/openshift3/ose-sti-builder                      v3.3.1.46.39v       deadbeefbaaa        13 days ago         1.26 GB"
        echo "registry.access.redhat.com/openshift3/ose-sti-builder                      <none>              cee523a4e55c        13 days ago         1.26 GB"
        echo "registry.access.redhat.com/openshift3/ose-sti-builder                      none                cee523a4e55c        13 days ago         1.26 GB"
        echo "registry.access.redhat.com/openshift3/ose-sti-builder                                          cee523a4e55c        13 days ago         1.26 GB"
        echo "registry.reg-aws.openshift.com:443/openshift3/ose-pod                      v3.3.1.46.39        e598d93f5abe        4 weeks ago         209.1 MB"
        echo "registry.reg-aws.openshift.com:443/openshift3/logging-fluentd              v3.3.1.46.39        58770b941e03        4 weeks ago         280.7 MB"
    }
    export -f docker

    run ./"${SCRIPT_NAME}"
    (( status == 0 ))
}
