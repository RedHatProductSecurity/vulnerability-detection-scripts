#!/bin/bash

vuln_vers=(
    '2.0-alpha1'
    '2.0-alpha2'
    '2.0-beta1'
    '2.0-beta2'
    '2.0-beta3'
    '2.0-beta4'
    '2.0-beta5'
    '2.0-beta6'
    '2.0-beta7'
    '2.0-beta8'
    '2.0-beta9'
    '2.0-rc1'
    '2.0-rc2'
    '2.0'
    '2.0.1'
    '2.0.2'
    '2.1'
    '2.2'
    '2.3'
    '2.4'
    '2.4.1'
    '2.5'
    '2.6'
    '2.6.1'
    '2.6.2'
    '2.7'
    '2.8'
    '2.8.1'
    '2.8.2'
    '2.9.0'
    '2.9.1'
    '2.10.0'
    '2.11.0'
    '2.11.1'
    '2.11.2'
    '2.12.0'
    '2.12.1'
    '2.13.0'
    '2.13.1'
    '2.13.2'
    '2.13.3'
    '2.14.0'
    '2.14.1'
    '2.2.0.redhat-1'
    '2.2.0.redhat-2'
    '2.5.0.redhat-1'
    '2.5.0.redhat-2'
    '2.5.0.redhat-3'
    '2.8.0.redhat-1'
    '2.8.2.redhat-1'
    '2.8.2.redhat-002'
    '2.11.1.redhat-00001'
    '2.11.2.redhat-00002'
    '2.13.1.redhat-00001'
    '2.13.2.redhat-00001'
    '2.13.2.redhat-00002'
    '2.13.3.redhat-00001'
    '2.13.3.redhat-00002'
    '2.13.3.redhat-00003'
    '2.14.0.redhat-00002'
    '2.14.0.redhat-00004'
)

non_vuln_vers=(
    '1.2.3'
    '2.3.1'  # https://logging.apache.org/log4j/2.x/security.html
    '2.3.2'  # https://logging.apache.org/log4j/2.x/security.html
    '2.12.2'  # https://logging.apache.org/log4j/log4j-2.12.1/
    '2.12.3'  # https://logging.apache.org/log4j/2.x/security.html
    '2.12.4'  # https://logging.apache.org/log4j/2.x/security.html
    '2.15.0'
    '2.16.0'
    '2.123.456'
)

POM_PATH="META-INF/maven/org.apache.logging.log4j/log4j-core/pom.xml"
POM_DIR="META-INF/maven/org.apache.logging.log4j/log4j-core"

rm -rf fake_jars_vuln
rm -rf fake_jars_nonvuln

mkdir -p fake_jars_vuln
mkdir -p fake_jars_nonvuln

for ver in "${vuln_vers[@]}" ; do
    (
        rm -rf tmp-fake-log4j-core
        mkdir tmp-fake-log4j-core
        cd tmp-fake-log4j-core || { echo "that's weird" ; exit 1 ; }
        mkdir -p "$POM_DIR"
        echo "
        ...something something something something...
        <modelVersion>4.0.0</modelVersion>
        <parent>
        <groupId>org.apache.logging.log4j</groupId>
        <artifactId>log4j</artifactId>
        <version>$ver</version>
        <relativePath>../</relativePath>
        </parent>
        ...something something something something...
        " > "$POM_PATH"
        dd if=/dev/zero of=filler bs=1024 count=301
        zip -0 -r ../fake_jars_vuln/log4j-core-"$ver".zip META-INF filler
        cd ..
        rm -rf tmp-fake-log4j-core
    )
done


for ver in "${non_vuln_vers[@]}" ; do
    (
        rm -rf tmp-fake-log4j-core
        mkdir tmp-fake-log4j-core
        cd tmp-fake-log4j-core || { echo "that's weird" ; exit 1 ; }
        mkdir -p "$POM_DIR"
        echo "
        ...something something something something...
        <modelVersion>4.0.0</modelVersion>
        <parent>
        <groupId>org.apache.logging.log4j</groupId>
        <artifactId>log4j</artifactId>
        <version>$ver</version>
        <relativePath>../</relativePath>
        </parent>
        ...something something something something...
        " > "$POM_PATH"
        dd if=/dev/zero of=filler bs=1024 count=301
        zip -0 -r ../fake_jars_nonvuln/log4j-core-"$ver".zip META-INF filler
        rm -rf tmp-fake-log4j-core
    )
done

rm -rf fake_jar_test_battery_*

# expected 61 detections
mkdir -p fake_jar_test_battery_1
cp -R fake_jars_vuln fake_jars_nonvuln fake_jar_test_battery_1/

# expected 0 detections
mkdir -p fake_jar_test_battery_2
cp -R fake_jars_nonvuln fake_jar_test_battery_2/

# expected 61 detections
mkdir -p fake_jar_test_battery_3
zip -0 -r fake_jar_test_battery_3/zip.jar fake_jar_test_battery_1 fake_jar_test_battery_2

# expected 183 detections
mkdir -p fake_jar_test_battery_4
zip -0 -r fake_jar_test_battery_4/zip.zip fake_jar_test_battery_1 fake_jar_test_battery_2 fake_jar_test_battery_3
cp -R fake_jars_vuln fake_jars_nonvuln fake_jar_test_battery_4/


# expected 1 detection
mkdir -p fake_jar_test_battery_smoke_1
cp -R fake_jars_vuln/log4j-core-2.0.zip fake_jars_nonvuln/log4j-core-2.16.0.zip fake_jar_test_battery_smoke_1/

# expected 0 detections
mkdir -p fake_jar_test_battery_smoke_2
cp -R fake_jars_nonvuln/log4j-core-2.16.0.zip fake_jar_test_battery_smoke_2/

# expected 1 detection
mkdir -p fake_jar_test_battery_smoke_3
zip -0 -r fake_jar_test_battery_smoke_3/zip.jar fake_jar_test_battery_smoke_1 fake_jar_test_battery_smoke_2

# expected 3 detections
mkdir -p fake_jar_test_battery_smoke_4
zip -0 -r fake_jar_test_battery_smoke_4/zip.zip fake_jar_test_battery_smoke_1 fake_jar_test_battery_smoke_2 fake_jar_test_battery_smoke_3
cp -R fake_jars_vuln/log4j-core-2.0.zip fake_jars_nonvuln/log4j-core-2.16.0.zip fake_jar_test_battery_smoke_4/

# expected 4 detections
mkdir -p fake_jar_test_battery_smoke_5/f4
mkdir -p fake_jar_test_battery_smoke_5/f3
mkdir -p fake_jar_test_battery_smoke_5/f2
mkdir -p fake_jar_test_battery_smoke_5/f1
cp -R fake_jars_vuln/log4j-core-2.0.zip fake_jar_test_battery_smoke_5/f4/
zip -0 -r fake_jar_test_battery_smoke_5/f3/zipf3.jar fake_jar_test_battery_smoke_5/f4
zip -0 -r fake_jar_test_battery_smoke_5/f2/zipf2.zip fake_jar_test_battery_smoke_5/f3
zip -0 -r fake_jar_test_battery_smoke_5/f1/zipf1.jar fake_jar_test_battery_smoke_5/f2

