#!/usr/bin/env bats

export VULNERABLE_1="samba3x-3.6.6-0.129.el5"
export VULNERABLE_2="samba4-4.2.10-6.el6_5"
export VULNERABLE_3="samba-3.6.9-160.3.el6rhs"
export VULNERABLE_4="samba-4.4.4-13.el7_3"
export SAFE_1="samba-3.5.9-160.3.el5"
export SAFE_2="samba-5.2.3-10.el7"


@test "Integration -- vulnerable #1" {
    rpm() {
        echo "$VULNERABLE_1"
    }
    getenforce() { 
        echo "Disabled"
    }
    export -f rpm
    export -f getenforce
    export MOCK_SMB_CONF=file_mocks/samba_not_applied
    
    run ./CVE-2017-7494.sh
    (( status == 2 ))
}


@test "Integration -- vulnerable #2" {
    rpm() {
        echo "$VULNERABLE_1"
    }
    getenforce() { 
        echo "Disabled"
    }  
    export -f rpm
    export -f getenforce
    export MOCK_SMB_CONF=file_mocks/samba_not_applied_yes
    
    run ./CVE-2017-7494.sh
    (( status == 2 ))
}


@test "Integration -- vulnerable #3" {
    rpm() {
        echo "$VULNERABLE_3"
    }
    getenforce() { 
        echo "Disabled"
    }  
    export -f rpm
    export -f getenforce
    export MOCK_SMB_CONF=file_mocks/samba_not_applied_1
    
    run ./CVE-2017-7494.sh
    (( status == 2 ))
}


@test "Integration -- vulnerable #4" {
    rpm() {
        echo "$VULNERABLE_4"
    }
    getenforce() { 
        echo "Disabled"
    }  
    export -f rpm
    export -f getenforce
    export MOCK_SMB_CONF=file_mocks/samba_not_applied_1
    
    run ./CVE-2017-7494.sh
    (( status == 2 ))
}


@test "Integration -- mitigation #1" {
    rpm() {
        echo "$VULNERABLE_1"
    }
    getenforce() { 
        echo "Disabled"
    }  
    export -f rpm
    export -f getenforce
    export MOCK_SMB_CONF=file_mocks/samba_applied_0
    
    run ./CVE-2017-7494.sh
    (( status == 0 ))
}


@test "Integration -- mitigation #2" {
    rpm() {
        echo "$VULNERABLE_1"
    }
    getenforce() { 
        echo "Disabled"
    }  
    export -f rpm
    export -f getenforce
    export MOCK_SMB_CONF=file_mocks/samba_applied_false
    
    run ./CVE-2017-7494.sh
    (( status == 0 ))
}


@test "Integration -- mitigation #3" {
    rpm() {
        echo "$VULNERABLE_3"
    }
    getenforce() { 
        echo "Disabled"
    }  
    export -f rpm
    export -f getenforce
    export MOCK_SMB_CONF=file_mocks/samba_applied_case
    
    run ./CVE-2017-7494.sh
    (( status == 0 ))
}


@test "Integration -- not vulnerable #1" {
    rpm() {
        echo "$SAFE_1"
    }
    getenforce() { 
        echo "Disabled"
    }  
    export -f rpm
    export -f getenforce
    export MOCK_SMB_CONF=file_mocks/samba_not_applied
    
    run ./CVE-2017-7494.sh
    (( status == 0 ))
}


@test "Integration -- not vulnerable #2" {
    rpm() {
        echo "$SAFE_2"
    }
    getenforce() { 
        echo "Disabled"
    }  
    export -f rpm
    export -f getenforce
    export MOCK_SMB_CONF=file_mocks/samba_not_applied
    
    run ./CVE-2017-7494.sh
    (( status == 0 ))
}


@test "Integration -- SELinux enforcing" {
    rpm() {
        echo "$VULNERABLE_3"
    }
    getenforce() { 
        echo "Enforcing"
    }  
    export -f rpm
    export -f getenforce
    export MOCK_SMB_CONF=file_mocks/samba_not_applied_1
    
    run ./CVE-2017-7494.sh
    (( status == 0 ))
}
