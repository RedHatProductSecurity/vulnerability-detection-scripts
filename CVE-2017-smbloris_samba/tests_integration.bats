#!/usr/bin/env bats

export VULNERABLE_1="samba-4.6.2-8.el7"
export VULNERABLE_2="samba4-4.2.10-6.el6_5"
export VULNERABLE_3="samba-3.6.9-160.3.el6rhs"
export VULNERABLE_4="samba-4.4.4-13.el7_3"
export NONRELEASED_1="samba-3.5.9-999.el5"
export NONRELEASED_2="samba-5.2.3-99.el7"


@test "Integration -- vulnerable #1" {
    rpm() {
        echo "$VULNERABLE_1"
    }
    export -f rpm
    export MOCK_SMB_CONF=file_mocks/samba_not_applied
    
    run ./smbloris.sh
    (( status == 2 ))
}


@test "Integration -- vulnerable #2" {
    rpm() {
        echo "$VULNERABLE_2"
    }
    export -f rpm
    export MOCK_SMB_CONF=file_mocks/samba_not_applied_0
    
    run ./smbloris.sh
    (( status == 2 ))
}


@test "Integration -- vulnerable #3" {
    rpm() {
        echo "$VULNERABLE_3"
    }
    export -f rpm
    export MOCK_SMB_CONF=file_mocks/samba_not_applied
    
    run ./smbloris.sh
    (( status == 2 ))
}


@test "Integration -- vulnerable #4" {
    rpm() {
        echo "$VULNERABLE_4"
    }
    export -f rpm
    export MOCK_SMB_CONF=file_mocks/samba_not_applied_0
    
    run ./smbloris.sh
    (( status == 2 ))
}


@test "Integration -- vulnerable #5" {
    rpm() {
        echo "$VULNERABLE_1"
    }
    export -f rpm
    export MOCK_SMB_CONF=file_mocks/samba_applied_commented
    
    run ./smbloris.sh
    (( status == 2 ))
}


@test "Integration -- mitigation #1" {
    rpm() {
        echo "$VULNERABLE_1"
    }
    export -f rpm
    export MOCK_SMB_CONF=file_mocks/samba_applied_1000
    
    run ./smbloris.sh
    (( status == 0 ))
}


@test "Integration -- mitigation #2" {
    rpm() {
        echo "$VULNERABLE_1"
    }
    export -f rpm
    export MOCK_SMB_CONF=file_mocks/samba_applied_100_nospaces
    
    run ./smbloris.sh
    (( status == 0 ))
}


@test "Integration -- mitigation #3" {
    rpm() {
        echo "$VULNERABLE_3"
    }
    export -f rpm
    export MOCK_SMB_CONF=file_mocks/samba_applied_3
    
    run ./smbloris.sh
    (( status == 0 ))
}


@test "Integration -- nonreleased vulnerable #1" {
    rpm() {
        echo "$NONRELEASED_1"
    }
    export -f rpm
    export MOCK_SMB_CONF=file_mocks/samba_not_applied

    run ./smbloris.sh
    (( status == 2 ))
}


@test "Integration -- nonreleased vulnerable #2" {
    rpm() {
        echo "$NONRELEASED_2"
    }
    export -f rpm
    export MOCK_SMB_CONF=file_mocks/samba_not_applied

    run ./smbloris.sh
    (( status == 2 ))
}


@test "Integration -- nonreleased mitigation #1" {
    rpm() {
        echo "$NONRELEASED_1"
    }
    export -f rpm
    export MOCK_SMB_CONF=file_mocks/samba_applied_1000

    run ./smbloris.sh
    (( status == 0 ))
}


@test "Integration -- nonreleased mitigation #2" {
    rpm() {
        echo "$NONRELEASED_2"
    }
    export -f rpm
    export MOCK_SMB_CONF=file_mocks/samba_applied_1000

    run ./smbloris.sh
    (( status == 0 ))
}
