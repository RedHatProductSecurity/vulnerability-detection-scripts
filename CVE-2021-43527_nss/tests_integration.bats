#!/usr/bin/env bats

export RHEL7="3.10.0-520.10.2.el7.x86_64"
export FEDORA="4.9.14-200.fc25.x86_64"
export SCRIPT_NAME=$( grep -E '^\. .*\.sh$' test_harness | sed -r 's/^\. (.*)$/\1/g' )


@test "Integration -- Fedora" {
    uname() {
        echo "$FEDORA"
    }
    export -f uname

    run ./"${SCRIPT_NAME}"
    (( status == 1 ))
}


@test "Integration -- RHEL7, all vulnerable" {
    uname() {
        echo "$RHEL7"
    }
    rpm() {
        if [[ "$3" == "nss" ]]; then
            echo "nss-3.67.0-3.el7_9.x86_64"
        fi
        if [[ "$3" == "thunderbird" ]]; then
            echo "thunderbird-38.8.0-1.el7_2.x86_64"
        fi
    }
    export -f uname
    export -f rpm

    run ./"${SCRIPT_NAME}" -n
    (( status == 6 ))
    [[ "$output" == *"'nss' package is vulnerable"* ]]
    [[ "$output" == *"'thunderbird' package is vulnerable"* ]]

    # More thorough tests
    [[ "$output" == *"Detected packages:"* ]]
    [[ "$output" == *"Detected 'nss' package: nss-3.67.0-3.el7_9.x86_64"* ]]
    [[ "$output" != *"Package 'nss' not installed."* ]]
    [[ "$output" == *"Detected 'thunderbird' package: thunderbird-38.8.0-1.el7_2.x86_64"* ]]
    [[ "$output" != *"Package 'thunderbird' not installed."* ]]
    [[ "$output" == *"This system is vulnerable"* ]]
    [[ "$output" != *"This system is not vulnerable"* ]]
    [[ "$output" != *"There are NO vulnerable packages"* ]]
}


@test "Integration -- RHEL7, nss vulnerable, thunderbird uses systemwide lib" {
    uname() {
        echo "$RHEL7"
    }
    rpm() {
        if [[ "$3" == "nss" ]]; then
            echo "nss-3.67.0-3.el7_9.x86_64"
        fi
        if [[ "$3" == "thunderbird" ]]; then
            echo "thunderbird-91.3.0-2.el7_9.x86_64"
        fi
    }
    export -f uname
    export -f rpm

    run ./"${SCRIPT_NAME}" -n
    (( status == 2 ))
    [[ "$output" == *"'nss' package is vulnerable"* ]]
    [[ "$output" == *"'thunderbird' package is NOT vulnerable"* ]]

    # More thorough tests
    [[ "$output" == *"Detected packages:"* ]]
    [[ "$output" == *"Detected 'nss' package: nss-3.67.0-3.el7_9.x86_64"* ]]
    [[ "$output" != *"Package 'nss' not installed."* ]]
    [[ "$output" == *"Detected 'thunderbird' package: thunderbird-91.3.0-2.el7_9.x86_64"* ]]
    [[ "$output" != *"Package 'thunderbird' not installed."* ]]
    [[ "$output" == *"This system is vulnerable"* ]]
    [[ "$output" != *"This system is not vulnerable"* ]]
    [[ "$output" != *"There are NO vulnerable packages"* ]]
}


@test "Integration -- RHEL7, nss vulnerable, thunderbird not installed" {
    uname() {
        echo "$RHEL7"
    }
    rpm() {
        if [[ "$3" == "nss" ]]; then
            echo "nss-3.67.0-3.el7_9.x86_64"
        fi
        if [[ "$3" == "thunderbird" ]]; then
            echo ""
        fi
    }
    export -f uname
    export -f rpm

    run ./"${SCRIPT_NAME}" -n
    (( status == 2 ))
    [[ "$output" == *"'nss' package is vulnerable"* ]]
    [[ "$output" == *"Package 'thunderbird' not installed"* ]]

    # More thorough tests
    [[ "$output" == *"Detected packages:"* ]]
    [[ "$output" == *"Detected 'nss' package: nss-3.67.0-3.el7_9.x86_64"* ]]
    [[ "$output" != *"Package 'nss' not installed."* ]]
    [[ "$output" != *"Detected 'thunderbird' package:"* ]]
    [[ "$output" == *"Package 'thunderbird' not installed."* ]]
    [[ "$output" == *"This system is vulnerable"* ]]
    [[ "$output" != *"This system is not vulnerable"* ]]
    [[ "$output" != *"There are NO vulnerable packages"* ]]
}


@test "Integration -- RHEL7, nss not vulnerable, thunderbird not installed" {
    uname() {
        echo "$RHEL7"
    }
    rpm() {
        if [[ "$3" == "nss" ]]; then
            echo "nss-3.67.0-123456.el7_9.x86_64"
        fi
        if [[ "$3" == "thunderbird" ]]; then
            echo ""
        fi
    }
    export -f uname
    export -f rpm

    run ./"${SCRIPT_NAME}" -n
    (( status == 0 ))
    [[ "$output" == *"'nss' package is NOT vulnerable"* ]]
    [[ "$output" == *"Package 'thunderbird' not installed"* ]]

    # More thorough tests
    [[ "$output" == *"Detected packages:"* ]]
    [[ "$output" == *"Detected 'nss' package: nss-3.67.0-123456.el7_9.x86_64"* ]]
    [[ "$output" != *"Package 'nss' not installed."* ]]
    [[ "$output" != *"Detected 'thunderbird' package:"* ]]
    [[ "$output" == *"Package 'thunderbird' not installed."* ]]
    [[ "$output" != *"This system is vulnerable"* ]]
    [[ "$output" == *"This system is not vulnerable"* ]]
    [[ "$output" == *"There are NO vulnerable packages"* ]]
}


@test "Integration -- RHEL8, nss vulnerable, thunderbird not installed" {
    uname() {
        echo "$RHEL7"
    }
    rpm() {
        if [[ "$3" == "nss" ]]; then
            echo "nss-3.67.0-6.el8_4.x86_64"
        fi
        if [[ "$3" == "thunderbird" ]]; then
            echo ""
        fi
    }
    export -f uname
    export -f rpm

    run ./"${SCRIPT_NAME}" -n
    (( status == 2 ))
    [[ "$output" == *"'nss' package is vulnerable"* ]]
    [[ "$output" == *"Package 'thunderbird' not installed"* ]]

    # More thorough tests
    [[ "$output" == *"Detected packages:"* ]]
    [[ "$output" == *"Detected 'nss' package: nss-3.67.0-6.el8_4.x86_64"* ]]
    [[ "$output" != *"Package 'nss' not installed."* ]]
    [[ "$output" != *"Detected 'thunderbird' package:"* ]]
    [[ "$output" == *"Package 'thunderbird' not installed."* ]]
    [[ "$output" == *"This system is vulnerable"* ]]
    [[ "$output" != *"This system is not vulnerable"* ]]
    [[ "$output" != *"There are NO vulnerable packages"* ]]
}


@test "Integration -- RHEL8, nss not installed, thunderbird vulnerable" {
    uname() {
        echo "$RHEL7"
    }
    rpm() {
        if [[ "$3" == "nss" ]]; then
            echo ""
        fi
        if [[ "$3" == "thunderbird" ]]; then
            echo "thunderbird-91.3.0-2.el8_2.x86_64"
        fi
    }
    export -f uname
    export -f rpm

    run ./"${SCRIPT_NAME}" -n
    (( status == 4 ))
    [[ "$output" == *"Package 'nss' not installed"* ]]
    [[ "$output" == *"'thunderbird' package is vulnerable"* ]]

    # More thorough tests
    [[ "$output" == *"Detected packages:"* ]]
    [[ "$output" != *"Detected 'nss' package:"* ]]
    [[ "$output" == *"Package 'nss' not installed."* ]]
    [[ "$output" == *"Detected 'thunderbird' package: thunderbird-91.3.0-2.el8_2.x86_64"* ]]
    [[ "$output" != *"Package 'thunderbird' not installed."* ]]
    [[ "$output" == *"This system is vulnerable"* ]]
    [[ "$output" != *"This system is not vulnerable"* ]]
    [[ "$output" != *"There are NO vulnerable packages"* ]]
}
