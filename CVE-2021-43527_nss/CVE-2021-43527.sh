#!/bin/bash

# Copyright (c) 2021  Red Hat, Inc.
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.

VERSION="1.0"

# Warning! Be sure to download the latest version of this script from its primary source:

BULLETIN="https://access.redhat.com/security/vulnerabilities/RHSB-2021-008"

# DO NOT blindly trust any internet sources and NEVER do `curl something | bash`!

# This script is meant for simple detection of the vulnerability. Feel free to modify it for your
# environment or needs. For more advanced detection, consider Red Hat Insights:
# https://access.redhat.com/products/red-hat-insights#getstarted

# Checking against the list of vulnerable packages is necessary because of the way how features
# are back-ported to older versions of packages in various channels.

VULNERABLE_VERSIONS=(
    'nss-3.16.2.3-5.ael7b'
    'nss-3.18.0-2.2.ael7b_1'
    'nss-3.19.1-3.ael7b_1'
    'nss-3.19.1-5.ael7b_1'
    'nss-3.19.1-7.ael7b_1.2'
    'nss-3.12.7-2.el6'
    'nss-3.12.8-1.el6_0'
    'nss-3.12.8-3.el6_0'
    'nss-3.12.9-9.el6'
    'nss-3.12.9-12.el6_1'
    'nss-3.12.10-2.el6_1'
    'nss-3.12.10-16.el6'
    'nss-3.12.10-17.el6_2'
    'nss-3.13.1-6.el6_2'
    'nss-3.13.1-7.el6_2'
    'nss-3.13.1-9.el6_2'
    'nss-3.13.1-10.el6_2'
    'nss-3.13.1-11.el6_2'
    'nss-3.13.1-12.el6_2'
    'nss-3.13.3-6.el6'
    'nss-3.13.3-8.el6'
    'nss-3.13.5-1.el6_3'
    'nss-3.13.6-2.el6_3'
    'nss-3.13.6-3.el6_3'
    'nss-3.14.0.0-12.el6'
    'nss-3.14.3-4.el6_4'
    'nss-3.14.3-5.el6_4'
    'nss-3.14.3-6.el6_4'
    'nss-3.14.3-8.el6_4'
    'nss-3.14.3-9.el6_4'
    'nss-3.15.1-15.el6'
    'nss-3.15.3-2.el6_5'
    'nss-3.15.3-3.el6_5'
    'nss-3.15.3-6.el6_5'
    'nss-3.16.1-4.el6_5'
    'nss-3.16.1-7.el6_5'
    'nss-3.16.1-9.el6_5'
    'nss-3.16.1-10.el6_5'
    'nss-3.16.1-14.el6'
    'nss-3.16.2.3-3.el6_6'
    'nss-3.18.0-5.3.el6_6'
    'nss-3.19.1-3.el6_6'
    'nss-3.19.1-4.el6_6'
    'nss-3.19.1-5.el6_6'
    'nss-3.19.1-5.el6_7'
    'nss-3.19.1-8.el6_7'
    'nss-3.21.0-0.3.el6_7'
    'nss-3.21.0-0.4.el6_7'
    'nss-3.21.0-8.el6'
    'nss-3.21.3-2.el6_8'
    'nss-3.27.1-12.el6'
    'nss-3.27.1-13.el6'
    'nss-3.28.3-3.el6_9'
    'nss-3.28.4-1.el6_9'
    'nss-3.28.4-3.el6_9'
    'nss-3.28.4-4.el6_9'
    'nss-3.36.0-7.el6'
    'nss-3.36.0-8.el6'
    'nss-3.36.0-9.el6_10'
    'nss-3.44.0-7.el6_10'
    'nss-3.44.0-11.el6_10'
    'nss-3.15.2-8.el7'
    'nss-3.15.4-6.el7'
    'nss-3.15.4-7.el7_0'
    'nss-3.16.2-2.el7_0'
    'nss-3.16.2-7.el7_0'
    'nss-3.16.2.3-2.el7_0'
    'nss-3.16.2.3-5.el7'
    'nss-3.18.0-2.2.el7_1'
    'nss-3.19.1-3.el7_1'
    'nss-3.19.1-5.el7_1'
    'nss-3.19.1-7.el7_1.2'
    'nss-3.19.1-18.el7'
    'nss-3.19.1-19.el7_2'
    'nss-3.21.0-9.el7_2'
    'nss-3.21.0-10.el7_2'
    'nss-3.21.0-17.el7'
    'nss-3.21.3-2.el7_3'
    'nss-3.28.2-1.6.el7_3'
    'nss-3.28.4-1.0.el7_3'
    'nss-3.28.4-1.2.el7_3'
    'nss-3.28.4-8.el7'
    'nss-3.28.4-11.el7_4'
    'nss-3.28.4-12.el7_4'
    'nss-3.28.4-15.el7_4'
    'nss-3.28.4-17.el7_4'
    'nss-3.34.0-4.el7'
    'nss-3.36.0-5.el7_5'
    'nss-3.36.0-7.1.el7_6'
    'nss-3.36.0-7.el7_5'
    'nss-3.36.0-8.el7_5'
    'nss-3.36.0-8.el7_6'
    'nss-3.36.0-9.el7_6'
    'nss-3.44.0-4.el7'
    'nss-3.44.0-7.el7_7'
    'nss-3.53.1-3.el7_9'
    'nss-3.53.1-7.el7_9'
    'nss-3.67.0-3.el7_9'
    'nss-3.41.0-5.el8'
    'nss-3.44.0-7.el8_0'
    'nss-3.44.0-8.el8'
    'nss-3.44.0-8.el8_0'
    'nss-3.44.0-9.el8_1'
    'nss-3.44.0-15.el8'
    'nss-3.53.1-11.el8_2'
    'nss-3.53.1-17.el8_3'
    'nss-3.67.0-6.el8_4'

    # Only Thunderbird with bundled NSS are vulnerable.
    # Versions that are commented out in this list use the system-wide nss library and are not vulnerable to CVE-2021-43527.
    # Versions that are not commented out in this list use a bundled nss library and are vulnerable to CVE-2021-43527.
    # You can check a given installed version manually with the following command:
    #     rpm -q thunderbird -R | grep '^libnss3.so'
    # If at least one "libnss3.so" line appears, the installed thunderbird uses the system-wide nss library.
    'thunderbird-31.4.0-1.ael7b'
    'thunderbird-31.5.0-2.ael7b_1'
    'thunderbird-31.6.0-1.ael7b_1'
    'thunderbird-31.7.0-1.ael7b_1'
    'thunderbird-31.8.0-1.ael7b_1'
    'thunderbird-38.2.0-1.ael7b_1'
    'thunderbird-38.3.0-1.ael7b_1'
    # 'thunderbird-3.1.3-1.el6'
    # 'thunderbird-3.1.6-1.el6_0'
    # 'thunderbird-3.1.7-3.el6_0'
    # 'thunderbird-3.1.8-4.el6_0'
    # 'thunderbird-3.1.9-3.el6_0'
    # 'thunderbird-3.1.10-1.el6_0'
    # 'thunderbird-3.1.11-2.el6_1'
    # 'thunderbird-3.1.12-1.el6_1'
    # 'thunderbird-3.1.12-2.el6_1'
    # 'thunderbird-3.1.14-1.el6_1'
    # 'thunderbird-3.1.15-1.el6_1'
    # 'thunderbird-3.1.16-2.el6_1'
    # 'thunderbird-3.1.18-1.el6_2'
    # 'thunderbird-3.1.18-2.el6_2'
    # 'thunderbird-10.0.1-3.el6_2'
    # 'thunderbird-10.0.3-1.el6_2'
    # 'thunderbird-10.0.4-1.el6_2'
    # 'thunderbird-10.0.5-2.el6_2'
    # 'thunderbird-10.0.6-1.el6_3'
    # 'thunderbird-10.0.7-1.el6_3'
    # 'thunderbird-10.0.8-1.el6_3'
    # 'thunderbird-10.0.8-2.el6_3'
    # 'thunderbird-10.0.10-1.el6_3'
    # 'thunderbird-10.0.11-1.el6_3'
    # 'thunderbird-10.0.12-3.el6_3'
    # 'thunderbird-17.0.3-1.el6_3'
    # 'thunderbird-17.0.3-2.el6_4'
    # 'thunderbird-17.0.5-1.el6_4'
    # 'thunderbird-17.0.6-2.el6_4'
    # 'thunderbird-17.0.7-1.el6_4'
    # 'thunderbird-17.0.8-5.el6_4'
    # 'thunderbird-17.0.9-1.el6_4'
    # 'thunderbird-17.0.10-1.el6_4'
    # 'thunderbird-24.2.0-1.el6_5'
    # 'thunderbird-24.3.0-2.el6_5'
    # 'thunderbird-24.4.0-1.el6_5'
    # 'thunderbird-24.5.0-1.el6_5'
    # 'thunderbird-24.6.0-1.el6_5'
    # 'thunderbird-24.7.0-1.el6_5'
    # 'thunderbird-24.8.0-1.el6_5'
    # 'thunderbird-31.2.0-3.el6_6'
    # 'thunderbird-31.3.0-1.el6_6'
    # 'thunderbird-31.4.0-1.el6_6'
    # 'thunderbird-31.5.0-1.el6_6'
    # 'thunderbird-31.6.0-1.el6_6'
    # 'thunderbird-31.7.0-1.el6_6'
    # 'thunderbird-31.8.0-1.el6_6'
    # 'thunderbird-38.2.0-4.el6_7'
    # 'thunderbird-38.3.0-1.el6_7'
    # 'thunderbird-38.4.0-1.el6_7'
    # 'thunderbird-38.5.0-1.el6_7'
    # 'thunderbird-38.6.0-1.el6_7'
    # 'thunderbird-38.7.0-1.el6_7'
    # 'thunderbird-38.8.0-2.el6_8'
    # 'thunderbird-45.2-1.el6_8'
    # 'thunderbird-45.3.0-1.el6_8'
    # 'thunderbird-45.4.0-1.el6_8'
    # 'thunderbird-45.5.0-1.el6_8'
    # 'thunderbird-45.5.1-1.el6_8'
    # 'thunderbird-45.6.0-1.el6_8'
    # 'thunderbird-45.7.0-1.el6_8'
    # 'thunderbird-45.8.0-1.el6_8'
    # 'thunderbird-52.1.0-1.el6_9'
    # 'thunderbird-52.2.0-1.el6_9'
    # 'thunderbird-52.3.0-1.el6_9'
    # 'thunderbird-52.4.0-2.el6_9'
    # 'thunderbird-52.5.0-1.el6_9'
    # 'thunderbird-52.5.2-1.el6_9'
    # 'thunderbird-52.6.0-1.el6_9'
    # 'thunderbird-52.7.0-1.el6_9'
    # 'thunderbird-52.8.0-2.el6_9'
    # 'thunderbird-52.9.1-1.el6'
    # 'thunderbird-60.2.1-5.el6'
    # 'thunderbird-60.3.0-1.el6'
    # 'thunderbird-60.4.0-1.el6'
    # 'thunderbird-60.5.0-1.el6_10'
    # 'thunderbird-60.6.1-1.el6_10'
    # 'thunderbird-60.7.0-1.el6_10'
    # 'thunderbird-60.7.2-2.el6_10'
    # 'thunderbird-60.8.0-1.el6_10'
    # 'thunderbird-60.9.0-1.el6_10'
    # 'thunderbird-68.2.0-2.el6_10'
    # 'thunderbird-68.3.0-3.el6_10'
    # 'thunderbird-68.4.1-2.el6_10'
    # 'thunderbird-68.5.0-1.el6_10'
    # 'thunderbird-68.6.0-1.el6_10'
    # 'thunderbird-68.7.0-1.el6_10'
    # 'thunderbird-68.8.0-1.el6_10'
    # 'thunderbird-68.9.0-1.el6_10'
    # 'thunderbird-68.10.0-1.el6_10'
    # 'thunderbird-68.11.0-1.el6_10'
    # 'thunderbird-68.12.0-1.el6_10'
    # 'thunderbird-78.3.1-1.el6_10'
    # 'thunderbird-78.4.0-1.el6_10'
    'thunderbird-78.4.3-1.el6_10'
    'thunderbird-78.5.0-1.el6_10'
    'thunderbird-31.4.0-1.el7'
    'thunderbird-31.5.0-2.el7_1'
    'thunderbird-31.6.0-1.el7_1'
    'thunderbird-31.7.0-1.el7_1'
    'thunderbird-31.8.0-1.el7_1'
    'thunderbird-38.2.0-1.el7_1'
    'thunderbird-38.3.0-1.el7_1'
    'thunderbird-38.4.0-1.el7_2'
    'thunderbird-38.5.0-1.el7_2'
    'thunderbird-38.6.0-1.el7_2'
    'thunderbird-38.7.0-1.el7_2'
    'thunderbird-38.8.0-1.el7_2'
    # 'thunderbird-45.2-1.el7_2'
    # 'thunderbird-45.3.0-1.el7_2'
    # 'thunderbird-45.4.0-1.el7_2'
    # 'thunderbird-45.5.0-1.el7_3'
    # 'thunderbird-45.5.1-1.el7_3'
    # 'thunderbird-45.6.0-1.el7_3'
    # 'thunderbird-45.7.0-1.el7_3'
    # 'thunderbird-45.8.0-1.el7_3'
    # 'thunderbird-52.1.0-1.el7_3'
    # 'thunderbird-52.2.0-1.el7_3'
    # 'thunderbird-52.3.0-1.el7_4'
    # 'thunderbird-52.4.0-2.el7_4'
    # 'thunderbird-52.5.0-1.el7_4'
    # 'thunderbird-52.5.2-1.el7_4'
    # 'thunderbird-52.6.0-1.el7_4'
    # 'thunderbird-52.7.0-1.el7_4'
    # 'thunderbird-52.8.0-1.el7_5'
    # 'thunderbird-52.9.1-1.el7_5'
    # 'thunderbird-60.2.1-4.el7_5'
    # 'thunderbird-60.3.0-1.el7_5'
    # 'thunderbird-60.4.0-1.el7_6'
    # 'thunderbird-60.5.0-1.el7_6'
    # 'thunderbird-60.6.1-1.el7_6'
    # 'thunderbird-60.7.0-1.el7_6'
    # 'thunderbird-60.7.2-2.el7_6'
    # 'thunderbird-60.8.0-1.el7_6'
    # 'thunderbird-60.9.0-1.el7_7'
    # 'thunderbird-68.2.0-1.el7_7'
    # 'thunderbird-68.3.0-1.el7_7'
    # 'thunderbird-68.4.1-2.el7_7'
    # 'thunderbird-68.5.0-1.el7_7'
    # 'thunderbird-68.6.0-1.el7_7'
    # 'thunderbird-68.7.0-1.el7_8'
    # 'thunderbird-68.8.0-1.el7_8'
    # 'thunderbird-68.9.0-1.el7_8'
    # 'thunderbird-68.10.0-1.el7_8'
    # 'thunderbird-68.11.0-1.el7_8'
    # 'thunderbird-68.12.0-1.el7_8'
    # 'thunderbird-78.3.1-1.el7_9'
    # 'thunderbird-78.4.0-1.el7_9'
    # 'thunderbird-78.4.3-1.el7_9'
    # 'thunderbird-78.5.0-1.el7_9'
    # 'thunderbird-78.5.1-1.el7_9'
    # 'thunderbird-78.6.0-1.el7_9'
    # 'thunderbird-78.6.1-1.el7_9'
    # 'thunderbird-78.7.0-1.el7_9'
    # 'thunderbird-78.8.0-1.el7_9'
    # 'thunderbird-78.9.0-3.el7_9'
    # 'thunderbird-78.9.1-1.el7_9'
    # 'thunderbird-78.10.0-1.el7_9'
    # 'thunderbird-78.11.0-1.el7_9'
    # 'thunderbird-78.12.0-2.el7_9'
    # 'thunderbird-78.13.0-1.el7_9'
    # 'thunderbird-78.14.0-1.el7_9'
    # 'thunderbird-91.2.0-1.el7_9'
    # 'thunderbird-91.3.0-2.el7_9'
    # 'thunderbird-60.5.0-1.el8'
    # 'thunderbird-60.6.1-1.el8'
    # 'thunderbird-60.7.0-1.el8_0'
    # 'thunderbird-60.7.2-2.el8_0'
    # 'thunderbird-60.8.0-1.el8_0'
    # 'thunderbird-60.9.0-2.el8_0'
    # 'thunderbird-68.2.0-1.el8_0'
    # 'thunderbird-68.3.0-2.el8_1'
    # 'thunderbird-68.4.1-2.el8_0'
    # 'thunderbird-68.4.1-2.el8_1'
    # 'thunderbird-68.5.0-1.el8_0'
    # 'thunderbird-68.5.0-1.el8_1'
    # 'thunderbird-68.6.0-1.el8_0'
    # 'thunderbird-68.6.0-1.el8_1'
    # 'thunderbird-68.7.0-1.el8_0'
    # 'thunderbird-68.7.0-1.el8_1'
    # 'thunderbird-68.8.0-1.el8_0'
    # 'thunderbird-68.8.0-1.el8_1'
    # 'thunderbird-68.8.0-1.el8_2'
    # 'thunderbird-68.9.0-1.el8'
    # 'thunderbird-68.9.0-1.el8_0'
    # 'thunderbird-68.9.0-1.el8_1'
    # 'thunderbird-68.9.0-1.el8_2'
    # 'thunderbird-68.10.0-1.el8_0'
    # 'thunderbird-68.10.0-1.el8_1'
    # 'thunderbird-68.10.0-1.el8_2'
    # 'thunderbird-68.11.0-1.el8_0'
    # 'thunderbird-68.11.0-1.el8_1'
    # 'thunderbird-68.11.0-1.el8_2'
    # 'thunderbird-68.12.0-1.el8_0'
    # 'thunderbird-68.12.0-1.el8_1'
    # 'thunderbird-68.12.0-1.el8_2'
    # 'thunderbird-78.3.0-3.el8'
    'thunderbird-78.3.1-1.el8_0'
    'thunderbird-78.3.1-1.el8_1'
    # 'thunderbird-78.3.1-1.el8_2'
    'thunderbird-78.4.0-1.el8_0'
    'thunderbird-78.4.0-1.el8_1'
    # 'thunderbird-78.4.0-1.el8_2'
    # 'thunderbird-78.4.0-1.el8_3'
    'thunderbird-78.4.3-1.el8_0'
    'thunderbird-78.4.3-1.el8_1'
    # 'thunderbird-78.4.3-1.el8_2'
    # 'thunderbird-78.4.3-1.el8_3'
    'thunderbird-78.5.0-1.el8_0'
    'thunderbird-78.5.0-1.el8_1'
    # 'thunderbird-78.5.0-1.el8_2'
    # 'thunderbird-78.5.0-1.el8_3'
    # 'thunderbird-78.5.1-1.el8_2'
    # 'thunderbird-78.5.1-1.el8_3'
    'thunderbird-78.6.0-1.el8_0'
    'thunderbird-78.6.0-1.el8_1'
    # 'thunderbird-78.6.0-1.el8_2'
    # 'thunderbird-78.6.0-1.el8_3'
    'thunderbird-78.6.1-1.el8_1'
    # 'thunderbird-78.6.1-1.el8_2'
    # 'thunderbird-78.6.1-1.el8_3'
    'thunderbird-78.7.0-1.el8_1'
    # 'thunderbird-78.7.0-1.el8_2'
    # 'thunderbird-78.7.0-1.el8_3'
    'thunderbird-78.8.0-1.el8_1'
    # 'thunderbird-78.8.0-1.el8_2'
    # 'thunderbird-78.8.0-1.el8_3'
    'thunderbird-78.9.0-3.el8_1'
    # 'thunderbird-78.9.0-3.el8_2'
    # 'thunderbird-78.9.0-3.el8_3'
    'thunderbird-78.9.1-1.el8_1'
    # 'thunderbird-78.9.1-1.el8_2'
    # 'thunderbird-78.9.1-1.el8_3'
    'thunderbird-78.10.0-1.el8_1'
    # 'thunderbird-78.10.0-1.el8_2'
    # 'thunderbird-78.10.0-1.el8_3'
    'thunderbird-78.11.0-1.el8_1'
    # 'thunderbird-78.11.0-1.el8_2'
    # 'thunderbird-78.11.0-1.el8_4'
    'thunderbird-78.12.0-2.el8_1'
    # 'thunderbird-78.12.0-2.el8_2'
    # 'thunderbird-78.12.0-3.el8_4'
    'thunderbird-78.13.0-1.el8_1'
    # 'thunderbird-78.13.0-1.el8_2'
    # 'thunderbird-78.13.0-1.el8_4'
    'thunderbird-78.14.0-1.el8_1'
    # 'thunderbird-78.14.0-1.el8_2'
    # 'thunderbird-78.14.0-1.el8_4'
    'thunderbird-91.2.0-1.el8_1'
    'thunderbird-91.2.0-1.el8_2'
    # 'thunderbird-91.2.0-1.el8_4'
    'thunderbird-91.3.0-2.el8_1'
    'thunderbird-91.3.0-2.el8_2'
    # 'thunderbird-91.3.0-2.el8_4'


)

basic_args() {
    # Parses basic commandline arguments and sets basic environment.
    #
    # Args:
    #     parameters - an array of commandline arguments
    #
    # Side effects:
    #     Exits if --help parameters is used
    #     Sets COLOR constants and debug variable

    local parameters=( "$@" )

    RED="\\033[1;31m"
    GREEN="\\033[1;32m"
    BOLD="\\033[1m"
    RESET="\\033[0m"
    for parameter in "${parameters[@]}"; do
        if [[ "$parameter" == "-h" || "$parameter" == "--help" ]]; then
            echo "Usage: $( basename "$0" ) [-n | --no-colors] [-d | --debug]"
            exit 1
        elif [[ "$parameter" == "-n" || "$parameter" == "--no-colors" ]]; then
            RED=""
            GREEN=""
            BOLD=""
            RESET=""
        elif [[ "$parameter" == "-d" || "$parameter" == "--debug" ]]; then
            debug=true
        fi
    done
}


basic_reqs() {
    # Prints common disclaimer and checks basic requirements.
    #
    # Args:
    #     CVE - string printed in the disclaimer
    #
    # Side effects:
    #     Exits when 'rpm' command is not available

    local CVE="$1"

    # Disclaimer
    echo
    echo -e "${BOLD}This script (v$VERSION) is primarily designed to detect $CVE on supported"
    echo -e "Red Hat Enterprise Linux systems and kernel packages."
    echo -e "Result may be inaccurate for other RPM based systems."
    echo -e "Result may be inaccurate for affected RPM packages not compiled by Red Hat.${RESET}"
    echo

    # RPM is required
    if ! command -v rpm &> /dev/null; then
        echo "'rpm' command is required, but not installed. Exiting."
        exit 1
    fi
}


check_supported_kernel() {
    # Checks if running kernel is supported.
    #
    # Args:
    #     running_kernel - kernel string as returned by 'uname -r'
    #
    # Side effects:
    #     Exits when running kernel is obviously not supported

    local running_kernel="$1"

    # Check supported platform
    if [[ "$running_kernel" != *".el"[6-8]* ]]; then
        echo -e "${RED}This script is meant to be used only on RHEL 6, 7 and 8.${RESET}"
        echo
        echo -e "Follow $BULLETIN for advice."
        exit 1
    fi
}


check_package() {
    # Checks if installed package is in list of vulnerable packages.
    #
    # Args:
    #     installed_packages - installed packages string as returned by 'rpm -qa package'
    #                          (may be multiline)
    #     vulnerable_versions - an array of vulnerable versions
    #
    # Prints:
    #     First vulnerable package string as returned by 'rpm -qa package', or nothing

    # Convert to array, use word splitting on purpose
    # shellcheck disable=SC2206
    local installed_packages=( $1 )
    shift
    local vulnerable_versions=( "$@" )

    for tested_package in "${vulnerable_versions[@]}"; do
        for installed_package in "${installed_packages[@]}"; do
            installed_package_without_arch="${installed_package%.*}"
            if [[ "$installed_package_without_arch" == "$tested_package" ]]; then
                echo "$installed_package"
                return 0
            fi
        done
    done
}


get_installed_packages() {
    # Checks for installed packages. Compatible with RHEL5.
    #
    # Args:
    #     package_names - an array of package name strings
    #
    # Prints:
    #     Lines with N-V-R.A strings of the installed packages.

    local package_names=( "$@" )

    rpm -qa --queryformat="%{NAME}-%{VERSION}-%{RELEASE}.%{ARCH}\n" "${package_names[@]}"
}


get_installed_package_names() {
    # Checks for installed packages and returns the names of the installed packages. Compatible with RHEL5.
    #
    # Args:
    #     package_names - an array of package name strings
    #
    # Prints:
    #     Lines with the names of the installed packages.

    local package_names=( "$@" )

    rpm -qa --queryformat="%{NAME}\n" "${package_names[@]}" | uniq
}


parse_facts() {
    # Gathers all available information and stores it in global variables. Only store facts and
    # do not draw conclusion in this function for better maintainability.
    #
    # Side effects:
    #     Sets many global boolean flags and content variables

    installed_nss=$( get_installed_packages "nss" )
    installed_thunderbird=$( get_installed_packages "thunderbird" )
}

draw_conclusions() {
    # Draws conclusions based on available system data.
    #
    # Side effects:
    #     Sets many global boolean flags and content variables

    vulnerable_nss=$( check_package "$installed_nss" "${VULNERABLE_VERSIONS[@]}" )
    vulnerable_thunderbird=$( check_package "$installed_thunderbird" "${VULNERABLE_VERSIONS[@]}" )

    result=0
    if [[ "$vulnerable_nss" ]]; then
        (( result |= 2 ))
    fi
    if [[ "$vulnerable_thunderbird" ]]; then
        (( result |= 4 ))
    fi
}


debug_print() {
    # Prints selected variables when debugging is enabled.

    variables=( installed_nss vulnerable_nss running_kernel rhel result )
    for variable in "${variables[@]}"; do
        echo "$variable = *${!variable}*"
    done
    echo
}


if [[ "${BASH_SOURCE[0]}" == "$0" ]]; then
    basic_args "$@"
    basic_reqs "CVE-2021-43527"
    running_kernel=$( uname -r )
    check_supported_kernel "$running_kernel"

    parse_facts
    draw_conclusions

    # Debug prints
    if [[ "$debug" ]]; then
        debug_print
    fi

    sentence_end="."
    if [[ "$installed_nss" || "$installed_thunderbird" ]]; then
        echo "Detected packages:"
        sentence_end=":"
    fi
    if [[ "$installed_nss" ]]; then
        echo -e "* Detected 'nss' package: ${BOLD}$installed_nss${RESET}"
    else
        echo "* Package 'nss' not installed."
    fi
    if [[ "$installed_thunderbird" ]]; then
        echo -e "* Detected 'thunderbird' package: ${BOLD}$installed_thunderbird${RESET}"
    else
        echo "* Package 'thunderbird' not installed."
    fi

    echo
    if (( result )); then
        echo -e "${RED}This system is vulnerable:${RESET}"
    else
        echo -e "${GREEN}This system is not vulnerable${sentence_end}${RESET}"
    fi

    if [[ "$installed_nss" ]]; then
        if [[ "$vulnerable_nss" ]]; then
            echo -e "* 'nss' package is ${RED}vulnerable${RESET}"
        else
            echo -e "* 'nss' package is ${GREEN}NOT vulnerable${RESET}"
        fi
    fi

    if [[ "$installed_thunderbird" ]]; then
        if [[ "$vulnerable_thunderbird" ]]; then
            echo -e "* 'thunderbird' package is ${RED}vulnerable${RESET}"
        else
            echo -e "* 'thunderbird' package is ${GREEN}NOT vulnerable${RESET}"
        fi
    fi

    if [[ ! "$vulnerable_nss" && ! "$vulnerable_thunderbird" ]]; then
        echo
        echo -e "There are ${GREEN}NO vulnerable packages${RESET} installed."
    fi

    echo
    echo -e "Follow $BULLETIN for advice."

    exit "$result"
fi
