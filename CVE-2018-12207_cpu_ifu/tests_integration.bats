#!/usr/bin/env bats


export FEDORA="4.9.14-200.fc25.x86_64"
export SCRIPT_NAME=$( grep -E '^\. .*\.sh$' test_harness | sed -r 's/^\. (.*)$/\1/g' )


@test "Integration -- Fedora - not supported" {
    uname() {
        echo "$FEDORA"
    }
    export -f uname

    run ./"${SCRIPT_NAME}"
    (( status == 1 ))
}


@test "Integration -- RHEL7, virtualization guest - not able to detect" {
    uname() {
        cat file_mocks/uname_r-rhel7
    }
    virt-what() {
        cat file_mocks/virt-what-kvm
    }
    export -f uname
    export -f virt-what
    export MOCK_ARCH="x86_64"
    export MOCK_EUID=0
    export MOCK_CPU_INFO_PATH=file_mocks/cpuinfo-skylake
    export MOCK_VULN_FILE_PATH=file_mocks/foo

    run ./"${SCRIPT_NAME}"
    (( status == 1 ))
}


@test "Integration -- RHEL7, kernel not updated - vuln. file does not exit" {
    virt-what() {
        return 0
    }
    uname() {
        cat file_mocks/uname_r-rhel7
    }
    export -f uname
    export -f virt-what
    export MOCK_ARCH="x86_64"
    export MOCK_EUID=0
    export MOCK_CPU_INFO_PATH=file_mocks/cpuinfo-skylake
    export MOCK_VULN_FILE_PATH=file_mocks/foo

    run ./"${SCRIPT_NAME}"
    (( status == 2 ))
}


@test "Integration -- RHEL7, POWER not affected" {
    virt-what() {
        return 0
    }
    uname() {
        cat file_mocks/uname_r-rhel7
    }
    export -f uname
    export -f virt-what
    export MOCK_ARCH="ppc64le"
    export MOCK_EUID=0
    export MOCK_CPU_INFO_PATH=file_mocks/cpuinfo-power
    export MOCK_VULN_FILE_PATH=file_mocks/foo

    run ./"${SCRIPT_NAME}"
    (( status == 0 ))
}


@test "Integration -- RHEL7, AMD not affected" {
    virt-what() {
        return 0
    }
    uname() {
        cat file_mocks/uname_r-rhel7
    }
    export -f uname
    export -f virt-what
    export MOCK_ARCH="i686"
    export MOCK_EUID=0
    export MOCK_CPU_INFO_PATH=file_mocks/cpuinfo-amd
    export MOCK_VULN_FILE_PATH=file_mocks/foo

    run ./"${SCRIPT_NAME}"
    (( status == 0 ))
}


@test "Integration -- RHEL7, Intel - not affected model" {
    virt-what() {
        return 0
    }
    uname() {
        cat file_mocks/uname_r-rhel7
    }
    export -f uname
    export -f virt-what
    export MOCK_ARCH="x86_64"
    export MOCK_EUID=0
    export MOCK_CPU_INFO_PATH=file_mocks/cpuinfo-xeon
    export MOCK_VULN_FILE_PATH=file_mocks/foo

    run ./"${SCRIPT_NAME}"
    (( status == 0 ))
}


@test "Integration -- RHEL7, Intel, mitigation" {
    virt-what() {
        return 0
    }
    uname() {
        cat file_mocks/uname_r-rhel7
    }
    export -f uname
    export -f virt-what
    export MOCK_ARCH="x86_64"
    export MOCK_EUID=0
    export MOCK_CPU_INFO_PATH=file_mocks/cpuinfo-skylake
    export MOCK_VULN_FILE_PATH=file_mocks/vuln-mit/itlb_multihit

    run ./"${SCRIPT_NAME}"
    (( status == 0 ))
}


@test "Integration -- RHEL7, vulnerable, kernel updated, mitigation disabled" {
    virt-what() {
        return 0
    }
    uname() {
        cat file_mocks/uname_r-rhel7
    }
    export -f uname
    export -f virt-what
    export MOCK_ARCH="x86_64"
    export MOCK_EUID=0
    export MOCK_CPU_INFO_PATH=file_mocks/cpuinfo-skylake
    export MOCK_VULN_FILE_PATH=file_mocks/vuln-disabled/itlb_multihit

    run ./"${SCRIPT_NAME}"
    (( status == 3 ))
}
